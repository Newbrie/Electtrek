<!DOCTYPE html>
<html lang="en"><head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style data-tippy-stylesheet="">.tippy-box[data-animation=fade][data-state=hidden]{opacity:0}[data-tippy-root]{max-width:calc(100vw - 10px)}.tippy-box{position:relative;background-color:#333;color:#fff;border-radius:4px;font-size:14px;line-height:1.4;white-space:normal;outline:0;transition-property:transform,visibility,opacity}.tippy-box[data-placement^=top]>.tippy-arrow{bottom:0}.tippy-box[data-placement^=top]>.tippy-arrow:before{bottom:-7px;left:0;border-width:8px 8px 0;border-top-color:initial;transform-origin:center top}.tippy-box[data-placement^=bottom]>.tippy-arrow{top:0}.tippy-box[data-placement^=bottom]>.tippy-arrow:before{top:-7px;left:0;border-width:0 8px 8px;border-bottom-color:initial;transform-origin:center bottom}.tippy-box[data-placement^=left]>.tippy-arrow{right:0}.tippy-box[data-placement^=left]>.tippy-arrow:before{border-width:8px 0 8px 8px;border-left-color:initial;right:-7px;transform-origin:center left}.tippy-box[data-placement^=right]>.tippy-arrow{left:0}.tippy-box[data-placement^=right]>.tippy-arrow:before{left:-7px;border-width:8px 8px 8px 0;border-right-color:initial;transform-origin:center right}.tippy-box[data-inertia][data-state=visible]{transition-timing-function:cubic-bezier(.54,1.5,.38,1.11)}.tippy-arrow{width:16px;height:16px;color:#333}.tippy-arrow:before{content:"";position:absolute;border-color:transparent;border-style:solid}.tippy-content{position:relative;padding:5px 9px;z-index:1}</style><link rel="stylesheet" href="/Users/newbrie/Documents/ReformUK/GitHub/Electtrek/static/style.css" media="screen">
  <link rel="stylesheet" href="/Users/newbrie/Documents/ReformUK/GitHub/Electtrek/static/print.css" media="print">
  <link rel="icon" href="/Users/newbrie/Documents/ReformUK/GitHub/Electtrek/static/favicon.ico" type="image/x-icon">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">


<script src="https://newbrie.github.io/Electtrek/static/map.js"></script><script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script><link rel="stylesheet" href="https://unpkg.com/tippy.js@6/dist/tippy.css"><script src="https://unpkg.com/@popperjs/core@2"></script><script src="https://unpkg.com/tippy.js@6"></script><script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script><meta charset="UTF-8"></head>







<body>


  

<style>
body {
    font-family: sans-serif;
    margin: 20px;
  }
  .calendar-grid {
    margin-top: 100px;
  }

  .slot {
  position: relative;
  height: 90px;
  width: 100%;
  border: 1px solid #ddd;
  border-radius: 4px;
  background-color: #fafafa;
  box-sizing: border-box;
  padding: 2px 6px;
  overflow: hidden;
  font-size: 0.85em;
  line-height: 1.2em;
}

.slot-time {
  font-size: 0.75em;
  font-weight: 600;
  color: #666;
  margin-right: 0.4em;
  vertical-align: baseline;
}

.slot-content {
  display: inline;
  word-break: break-word;
}


.slot small {
    color: #555;
    display: block;        /* new line for resource list */
  }

.slot-label {
  position: absolute;
  top: 2px;
  left: 4px;
  font-size: 0.75em;
  color: #666;
  pointer-events: none;
  z-index: 2;
  background: rgba(255, 255, 255, 0.85);
  border-radius: 3px;
  padding: 0 4px;
  white-space: nowrap;

  /* dynamically measure label width */
  --label-width: calc(100% + 8px);
}

/* âœ… indent based on label width */
.slot::before {
  content: "";
  display: block;
  width: calc(var(--label-width, 3em) + 6px); /* auto + small gap */
  height: 0;
  flex: 0 0 auto;
}

/* Lozenges act like inline text */
.slot .lozenge {
  margin: 0;
  padding: 0px 4px;
  font-size: 0.8em;
  line-height: 1em;
  display: inline-block;
  border-radius: 4px;
  white-space: nowrap;
  opacity: 1;
}

.slot .lozenge[data-type="activity"] { background: rgba(204, 229, 255, 0.9); }
.slot .lozenge[data-type="resource"] { background: rgba(212, 237, 218, 0.9); }
.slot .lozenge[data-type="place"]    { background: rgba(255, 243, 205, 0.9); }
.slot .lozenge[data-type="area"]     { background: rgba(248, 215, 218, 0.9); }


.election-highlight {
  border: 2px double red;!important;
  box-sizing: border-box;
}

.today-highlight {
  border: 2px double blue;!important;
  box-sizing: border-box;
}

</style>

<div class="container-fluid">
  <h2 class="text-center mb-4">FAB1 Campaigns Calendar</h2>

  <div id="calendar-controls" class="mb-3">
    <button id="save-calendar-btn" class="btn btn-primary" disabled="">âœ… Saved!</button>
    <button id="generate-summary-btn" class="btn btn-secondary">ğŸ“‹ Generate Table</button>
    <button id="export-html-btn" class="btn btn-info" disabled="">ğŸ”„ Exporting...</button>
  </div>

  <div id="calendar-grid" class="calendar-grid mt-4"></div>

  <!-- Modal -->
  <div class="modal fade" id="slotModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Slot</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="slotForm">
          <div class="mb-2">
            <label>Activity</label>
            <select id="activitySelect" class="form-select"><option value="">-- Select --</option><option value="Curry">Networking Event</option><option value="L1">Leaflet1</option><option value="L2">SecondLeaflet</option><option value="L3">FinalLeaflet</option><option value="M1">Member</option><option value="M2">Pledged</option><option value="M3">HouseBoard</option></select>
          </div>
          <div class="mb-2">
            <label>Resources</label>
            <select id="resourcesSelect" class="form-select" multiple=""><option value="">-- Select --</option><option value="GH">GH</option></select>
          </div>
          <div class="mb-2">
            <label>Place</label>
            <select id="placeSelect" class="form-select"><option value="">-- Select --</option><option value="BHH">BHH</option><option value="CH">CH</option><option value="CHS">CHS</option><option value="FPH">FPH</option><option value="H">H</option><option value="HPSH">HPSH</option><option value="NHSC4WL">NHSC4WL</option><option value="PH">PH</option><option value="QHH">QHH</option><option value="RR">RR</option><option value="SH">SH</option><option value="SPCH">SPCH</option><option value="TCO">TCO</option><option value="TCP">TCP</option><option value="VPSV">VPSV</option><option value="WEPSW">WEPSW</option><option value="WPSW">WPSW</option></select>
          </div>
          <div class="mb-2">
            <label>Area</label>
            <select id="areaSelect" class="form-select" multiple=""><option value="">-- Select --</option><option value="FARNHAM_CENTRAL_ED">FARNHAM_CENTRAL_ED</option><option value="FARNHAM_NORTH_ED">FARNHAM_NORTH_ED</option><option value="HASLEMERE_ED">HASLEMERE_ED</option></select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-danger" id="clearSlotBtn">Clear Slot</button>
        <button class="btn btn-primary" id="saveSlotBtn">Save</button>
      </div>
    </div>
  </div>
</div>

<div id="summary-report" class="mt-4"></div>

</div>

<script>

  function createStandaloneHTML() {
    const doctype = "<!DOCTYPE html>\n";

    // âœ… Clone once
    const clone = document.documentElement.cloneNode(true);

    // âœ… Remove duplicate calendar content
    const calendar = clone.querySelector("#calendar-grid");
    if (calendar) {
      calendar.innerHTML = "";
    }

    // âœ… Serialize the edited clone
    let htmlString = doctype + clone.outerHTML;

    // âœ… Replace placeholder with final API URL
    const FINAL_API_URL = DEVURLS['prod'];
    htmlString = htmlString.replace(/https://electtrek.com/g, FINAL_API_URL);

    return htmlString;
  }

  document.getElementById("export-html-btn").addEventListener("click", async () => {
    await saveCalendarPlan();
    const btn = document.getElementById("export-html-btn");
    btn.disabled = true;
    btn.textContent = "ğŸ”„ Exporting...";

    try {
      // Create a standalone HTML document

      const htmlContent = createStandaloneHTML();

      // Create a Blob and FormData to send as 'file'
      const blob = new Blob([htmlContent], { type: "text/html" });
      const formData = new FormData();
      formData.append("file", blob, "calendar.html");

      // Upload to development backend
      const response = await fetch("/api/upload-and-protect", {
        method: "POST",
        body: formData
      });

      const result = await response.json();

      if (!response.ok || !result.ok) {
        throw new Error(result.error || "Upload failed");
      }

      btn.textContent = "âœ… Exported & Protected";
    } catch (err) {
      console.error("Export failed:", err);
      btn.textContent = "âŒ Failed";
    } finally {
      setTimeout(() => {
        btn.textContent = "ğŸ” Export Protected HTML";
        btn.disabled = false;
      }, 1500);
    }
  });

  // Format hours nicely
  function formatHour(hour) {
    const ampm = hour >= 12 ? "PM" : "AM";
    const h = (hour % 12) || 12;
    return `${h} ${ampm}`;
  }

  // Build 45-day x 2-hour grid
  function buildCalendarGrid(containerId, daysToShow = 45) {
    const container = document.getElementById(containerId);
    container.innerHTML = "";

    const slots = ["9 AM", "11 AM", "1 PM", "3 PM", "5 PM", "7 PM"];

    // â”€â”€â”€ Date Setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    // â¬‡ï¸ Find Monday of the previous week
    const dayOfWeek = today.getDay(); // 0 (Sun) to 6 (Sat)
    const daysSinceMonday = (dayOfWeek + 6) % 7 + 7;
    const startDate = new Date(today);
    startDate.setDate(today.getDate() - daysSinceMonday);

    // âœ… Store globally for access elsewhere
    window.calendarStartDate = new Date(startDate);

    // â”€â”€â”€ Election Date (optional) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let electionDate = null;
    const electionDateStr = window.parent?.document?.getElementById('electiondate')?.value;

    if (electionDateStr) {
      const [year, month, day] = electionDateStr.split("-");
      electionDate = new Date(year, month - 1, day);
      electionDate.setHours(0, 0, 0, 0);
      console.log("ğŸ“… Election date parsed as:", electionDate.toDateString());
    } else {
      console.warn("âš ï¸ No election date found");
    }

    // â”€â”€â”€ Calculate padding and total days â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const padStart = startDate.getDay() === 0 ? 6 : startDate.getDay() - 1;
    const padEnd = 7 - ((padStart + daysToShow) % 7);
    const totalDays = daysToShow + padStart + (padEnd === 7 ? 0 : padEnd);

    let weekRow = document.createElement("div");
    weekRow.className = "week-row";

    for (let i = 0; i < totalDays; i++) {
      const dayDiv = document.createElement("div");
      dayDiv.className = "day-column";

      // Determine if this is a blank cell
      if (i < padStart || i >= padStart + daysToShow) {
        dayDiv.classList.add("empty-day"); // ğŸ‘ˆ add class for styling
      } else {
        // Calculate the correct date for this cell
        const date = new Date(startDate);
        date.setDate(startDate.getDate() + (i - padStart));

        // Apply highlights
        if (date.getTime() === today.getTime()) dayDiv.classList.add("today-highlight");
        if (electionDate && date.getTime() === electionDate.getTime()) dayDiv.classList.add("election-highlight");

        // Day header
        const dayNumber = date.getDate();
        const weekday = date.toLocaleDateString(undefined, { weekday: "short" });

        const header = document.createElement("div");
        header.className = "day-header";
        header.textContent = `${weekday} ${dayNumber}`;
        dayDiv.appendChild(header);

        // Create slots
        for (const slotName of slots) {
          const slotDiv = document.createElement("div");
          slotDiv.className = "slot";
          slotDiv.dataset.availability = "0";
          slotDiv.dataset.time = slotName;

          const localDateStr = date.toLocaleDateString("en-CA"); // YYYY-MM-DD
          const slotId = `${localDateStr}_${slotName}`;
          slotDiv.dataset.id = slotId;

          const timeLabel = document.createElement("div");
          timeLabel.className = "slot-label";
          timeLabel.textContent = slotName;
          slotDiv.appendChild(timeLabel);

          const lozengeContainer = document.createElement("div");
          lozengeContainer.className = "lozenge-container";
          slotDiv.appendChild(lozengeContainer);

          slotDiv.addEventListener("click", () => openSlotModal(slotId));
          dayDiv.appendChild(slotDiv);
        }
      }

      weekRow.appendChild(dayDiv);

      // Finish a week row after 7 days
      if ((i + 1) % 7 === 0) {
        container.appendChild(weekRow);
        weekRow = document.createElement("div");
        weekRow.className = "week-row";
      }
    }

    if (weekRow.children.length) {
      container.appendChild(weekRow);
    }
  }


// Fill s
function populateDropdowns() {
  fillSelect("activitySelect", window.task_tags);
  fillSelect("resourcesSelect", window.resources);
  fillSelect("placeSelect", window.places);
  fillSelect("areaSelect", window.areas);
}


function fillSelect(selectId, items) {
  const sel = document.getElementById(selectId);
  sel.innerHTML = '<option value="">-- Select --</option>';

  let arr = [];

  if (Array.isArray(items)) {
    // Case: resources is an array of { key, value: {...} }
    arr = items.map(it => ({
      key: it.key ?? "",
      value: it.value?.Firstname
              ? `${it.value.Firstname} (${it.key})`
              : it.value?.name ?? it.key
    }));
  } else if (typeof items === "object" && items !== null) {
    // Case: task_tags, places, areas
    arr = Object.entries(items).map(([k, v]) => ({
      key: k,
      value: typeof v === "string"
        ? v
        : v.name ?? v.code ?? k
    }));
  }

  console.log(`Populating ${selectId}:`, arr);

  arr.forEach(it => {
    const opt = document.createElement("option");
    opt.value = it.key;
    opt.textContent = it.value;
    sel.appendChild(opt);
  });
}

function updateSlotAvailability(slot) {
  // Count children with the Bootstrap resource lozenge class
  const resourceCount = [...slot.children].filter(child =>
    child.classList.contains('badge') && child.classList.contains('resource-lozenge')
  ).length;

  const availabilityLevel = Math.min(10, Math.ceil(resourceCount / 2));

  // Set a data attribute for styling or logic
  slot.setAttribute("data-availability", availabilityLevel);

  // Update tooltip text (Bootstrap tooltip)
  slot.setAttribute("title", `${availabilityLevel * 2} resources available`);

  // If using Bootstrap tooltips, refresh them
  if (slot._tooltipInstance) {
    slot._tooltipInstance.dispose(); // Remove old tooltip
  }
  slot._tooltipInstance = new bootstrap.Tooltip(slot); // Reinitialize tooltip
}

function processLozenges(lozenges, areas = {}, places = {}, tags = {}) {
  const resourceList = [];
  const activityList = [];
  const placeList = [];

  lozenges?.forEach(loz => {
    if (!loz?.type || !loz?.code) {
      console.warn("Skipping invalid lozenge:", loz);
      return;
    }

    switch (loz.type) {
      case "resource":
        resourceList.push(loz.code);
        break;

      case "area": {
        const areaInfo = areas[loz.code];
        if (areaInfo?.details?.length) {
          placeList.push(`Area: ${loz.code} â€“ ${areaInfo.details.join(", ")}`);
        } else {
          placeList.push(`Area: ${loz.code}`);
        }
        break;
      }

      case "place": {
        const placeInfo = places[loz.code];
        const tooltip = placeInfo?.tooltip || "(place unknown)";
        placeList.push(`${loz.code} â€“ ${tooltip}`);
        break;
      }

      case "activity": {
        // For backward compatibility, fall back to tags if available
        const desc = tags[loz.code] || "(no description)";
        activityList.push(`${loz.code} â€“ ${desc}`);
        break;
      }

      default:
        console.warn("Unknown lozenge type:", loz.type);
    }
  });

  return { resourceList, activityList, placeList };
}


function buildSummaryTable(slots, areas, places, tags) {
  const table = document.createElement("table");
  // Bootstrap table classes
  table.className = "table table-striped table-bordered table-hover table-sm";

  // Responsive wrapper
  const wrapper = document.createElement("div");
  wrapper.className = "table-responsive";
  wrapper.appendChild(table);

  table.innerHTML = `
    <thead class="table-dark">
      <tr>
        <th scope="col">Date & Time</th>
        <th scope="col">Activities</th>
        <th scope="col">Resources</th>
        <th scope="col">Places</th>
      </tr>
    </thead>
    <tbody></tbody>
  `;

  const tbody = table.querySelector("tbody");

  Object.entries(slots).forEach(([key, slot]) => {
    const [dateStr, timeStr] = key.split("_");

    let formattedDateTime = "Invalid Date";

    if (dateStr && timeStr) {
      const [year, month, day] = dateStr.split("-").map(Number);
      const timeParts = timeStr.match(/^(\d{1,2})(?::(\d{2}))?\s*(AM|PM)$/i);

      if (year && month && day && timeParts) {
        let [, hourStr, minuteStr, period] = timeParts;
        let hour = parseInt(hourStr, 10);
        const minute = parseInt(minuteStr || "0", 10);

        if (period.toUpperCase() === "PM" && hour !== 12) hour += 12;
        if (period.toUpperCase() === "AM" && hour === 12) hour = 0;

        const date = new Date(year, month - 1, day, hour, minute);

        formattedDateTime = date.toLocaleString(undefined, {
          weekday: "short",
          day: "numeric",
          month: "short",
          hour: "2-digit",
          minute: "2-digit",
          hour12: true,
        });
      } else {
        console.warn("âš ï¸ Invalid time format in slot key:", key);
      }
    } else {
      console.warn("âš ï¸ Invalid slot key format:", key);
    }

    const { resourceList, activityList, placeList } = processLozenges(
      slot.lozenges,
      areas,
      places,
      tags
    );

    const row = document.createElement("tr");

    // Use Bootstrap text classes for better readability
    row.innerHTML = `
      <td class="align-top">${formattedDateTime}</td>
      <td class="align-top">${activityList.join("<br>")}</td>
      <td class="align-top">${resourceList.join(", ")}</td>
      <td class="align-top">${placeList.join("<br>")}</td>
    `;
    tbody.appendChild(row);
  });

  return wrapper; // return the responsive wrapper
}

function extractCalendarPlan() {
  const calendarPlan = { slots: {} };

  document.querySelectorAll(".slot").forEach(slotDiv => {
    const slotId = slotDiv.dataset.id; // use data-id instead of id
    if (!slotId) return;

    const slotKey = slotId; // already "YYYY-MM-DD_9 AM"
    const availability = parseInt(slotDiv.getAttribute("data-availability")) || 0;

    const lozenges = Array.from(
      slotDiv.querySelectorAll(".lozenge")
    ).map(el => ({
      type: el.dataset.type || null,
      code: el.dataset.code || el.textContent.trim()
    }));

    if (availability > 0 || lozenges.length > 0) {
      calendarPlan.slots[slotKey] = {
        availability,
        lozenges
      };
    }
  });

  return calendarPlan;
}

function loadCalendarPlan(plan) {
  console.log("ğŸ“¦ Loaded plan:", plan);

  if (!plan?.slots) return;

  Object.entries(plan.slots).forEach(([key, slotData]) => {
    const slotDiv = document.querySelector(`.slot[data-id="${key}"]`);
    if (!slotDiv) {
      console.warn("âš ï¸ Slot not found for key:", key);
      return;
    }

    // Clear the slot before rendering
    slotDiv.innerHTML = "";

    // Re-add time label
    const timeSpan = document.createElement("span");
    timeSpan.className = "slot-time";
    timeSpan.textContent = slotDiv.dataset.time;
    slotDiv.appendChild(timeSpan);

    // Lozenge container
    const lozengeContainer = document.createElement("span");
    lozengeContainer.className = "slot-content"; // or "lozenge-container"
    slotDiv.appendChild(lozengeContainer);

    // Add lozenges
    slotData.lozenges?.forEach(l => {
      const lozEl = createLozengeElement(l);
      lozengeContainer.appendChild(lozEl);
      lozengeContainer.appendChild(document.createTextNode(" "));
    });

    // Optional: store in calendarData for quick access
    calendarData[key] = slotData;

    // Optional visual updates
    updateSlotAvailability(slotDiv);
  });
}

function redrawSlot(slotId, data = {}) {
  const slotDiv = document.querySelector(`.slot[data-id="${slotId}"]`);
  if (!slotDiv) return;

  // Clear existing content
  slotDiv.innerHTML = "";

  // Re-add time label
  const timeSpan = document.createElement("span");
  timeSpan.className = "slot-time";
  timeSpan.textContent = slotDiv.dataset.time;
  slotDiv.appendChild(timeSpan);

  // Add lozenge container
  const lozengeContainer = document.createElement("span");
  lozengeContainer.className = "slot-content";
  slotDiv.appendChild(lozengeContainer);

  // Build lozenges from data
  const lozenges = [
    { type: "activity", code: data.activity },
    ...(data.resources || []).map(r => ({ type: "resource", code: r })),
    { type: "place", code: data.place },
    { type: "area", code: data.area }
  ].filter(l => l.code);

  lozenges.forEach(l => {
    const loz = document.createElement("span");
    loz.className = "lozenge";
    loz.dataset.type = l.type;
    loz.dataset.code = l.code;
    loz.textContent = l.code;
    lozengeContainer.appendChild(loz);
    lozengeContainer.appendChild(document.createTextNode(" "));
  });

  // Store lozenges for summary/report
  calendarData[slotId].lozenges = lozenges;
}


// ğŸ§± Safe variable injection
window.task_tags = {"Curry": "Networking Event", "L1": "Leaflet1", "L2": "SecondLeaflet", "L3": "FinalLeaflet", "M1": "Member", "M2": "Pledged", "M3": "HouseBoard"};
window.resources = {"GH": {"Address1": "Guildford", "Address2": "Haslemere", "Firstname": "Ged", "Mobile": "M: 0758 412 3293", "Postcode": "GU1 2DR", "Role": "Branch", "Surname": "Hall", "campaignMgremail": "farnhamandbordon@reformuk.com"}};
window.places = {"BHH": {"code": "BHH", "lat": null, "lon": null, "tooltip": "Bridge House Hotel, Reigate Hill, Reigate, RH2 9RP"}, "CH": {"code": "CH", "lat": null, "lon": null, "tooltip": "Cambridge Hotel, 19 Bonehurst Rd, Horley, RH6 8PP"}, "CHS": {"code": "CHS", "lat": null, "lon": null, "tooltip": "Caterham High Street, 8 Station Road East, Oxted, Surrey, RH8 0BT"}, "FPH": {"code": "FPH", "lat": null, "lon": null, "tooltip": "Four Points Hotel, 49 Bonehurst Rd, Horley, RH6 8TY"}, "H": {"code": "H", "lat": null, "lon": null, "tooltip": "Hammonds, 8 Station Road East, Oxted, Surrey, RH8 0BT"}, "HPSH": {"code": "HPSH", "lat": null, "lon": null, "tooltip": "Harestone Polling Station (HA1), The Soper Hall, Harestone Valley Road, Caterham, CR3 6HY"}, "NHSC4WL": {"code": "NHSC4WL", "lat": null, "lon": null, "tooltip": "New Haw Social Club, 48 Woodham Lane , Addlestone, KT15 3NA "}, "PH": {"code": "PH", "lat": null, "lon": null, "tooltip": "Potters Hotel, 1 Fleet Road, Aldershot, GU11 2ET"}, "QHH": {"code": "QHH", "lat": null, "lon": null, "tooltip": "Quadrant House Hotel, Princess Way , Redhill, RH1 1FE"}, "RR": {"code": "RR", "lat": null, "lon": null, "tooltip": "Rashoi Restaurant, 58 Updown Hill, Windlesham, GU20 6DX"}, "SH": {"code": "SH", "lat": null, "lon": null, "tooltip": "Skylane Hotel, 34 Bonehurst Road, Horley Surrey , RH6 8QF"}, "SPCH": {"code": "SPCH", "lat": null, "lon": null, "tooltip": "St Peters Church Hall, 1 Parsonage Way, Frimley Green Road, Camberley, GU16 8HZ"}, "TCO": {"code": "TCO", "lat": null, "lon": null, "tooltip": "Tandridge Council Offices, 8 Station Road East, Oxted, Surrey, RH8 0BT"}, "TCP": {"code": "TCP", "lat": null, "lon": null, "tooltip": "The CrabTree Pub, 220 Frimley Green Road , Camberley, GU15 2QJ"}, "VPSV": {"code": "VPSV", "lat": null, "lon": null, "tooltip": "Valley Polling Station (VA1) , Caterham Baptist Church, 4-6 Beechwood Road, Caterham , CR3 6NA"}, "WEPSW": {"code": "WEPSW", "lat": null, "lon": null, "tooltip": "Whyteleafe East  Polling Station (WAW2), St. Luke\u2019s Church, Whyteleafe Hill, Whyteleafe, CR3 0AA"}, "WPSW": {"code": "WPSW", "lat": null, "lon": null, "tooltip": "Whyteleafe Polling Station (WHT1), St. Luke\u2019s Church, Whyteleafe Hill, Whyteleafe , CR3 0AA"}};
window.areas = {"FARNHAM_CENTRAL_ED": {"code": "FARNHAM_CENTRAL_ED", "details": ["K271", "K361", "K286", "K18", "K192", "K16", "K296", "K297", "K272", "K17", "K287", "K193", "K191", "K214", "K288", "K143", "K298", "K152", "K261", "K260", "K113", "K205", "K262", "K111", "K71", "K75", "K25", "K74", "K24", "K228"], "tooltip_html": "\n    \u003cdiv style=\"\n        border: 1px solid #ccc;\n        border-radius: 10px;\n        padding: 10px;\n        background-color: black !important;\n        color: white !important;\n        box-shadow: 2px 2px 6px rgba(0,0,0,0.1);\n        max-width: 500px;\n        overflow-x: auto;\n        font-family: sans-serif;\n        font-size: 9pt;\n        white-space: nowrap;\n    \"\u003e\n        \u003ctable style=\"border-collapse: collapse; width: 100%;\"\u003e\n            \u003cthead\u003e\n                \u003ctr\u003e\n                    \u003cth style=\"text-align:left; padding: 4px;\"\u003eArea Name\u003c/th\u003e\n                    \u003cth style=\"text-align:left; padding: 4px;\"\u003e# Walks\u003c/th\u003e\n                    \u003cth style=\"text-align:left; padding: 4px;\"\u003e# Streets\u003c/th\u003e\n                    \u003cth style=\"text-align:left; padding: 4px;\"\u003e# Electors\u003c/th\u003e\n                \u003c/tr\u003e\n            \u003c/thead\u003e\n            \u003ctbody\u003e\n    \n        \u003ctr\u003e\n            \u003ctd style=\"padding: 4px;\"\u003eFARNHAM_CENTRAL_ED\u003c/td\u003e\n            \u003ctd style=\"padding: 4px;\"\u003e30\u003c/td\u003e\n            \u003ctd style=\"padding: 4px;\"\u003e137\u003c/td\u003e\n            \u003ctd style=\"padding: 4px;\"\u003e3342\u003c/td\u003e\n        \u003c/tr\u003e\n        \n            \u003c/tbody\u003e\n        \u003c/table\u003e\n    \u003c/div\u003e\n    "}, "FARNHAM_NORTH_ED": {"code": "FARNHAM_NORTH_ED", "details": ["K332", "K133", "K36", "K132", "K38", "K134", "K331", "K308", "K333", "K35", "K323", "K270", "K58", "K59", "K269", "K322", "K73", "K213", "K231", "K232", "K209", "K10", "K216", "K219", "K125", "K124", "K100", "K98", "K08", "K99", "K217", "K197", "K210", "K09", "K108", "K163", "K195", "K77", "K76", "K109", "K218", "K317", "K199", "K196", "K200", "K201", "K198", "K37"], "tooltip_html": "\n    \u003cdiv style=\"\n        border: 1px solid #ccc;\n        border-radius: 10px;\n        padding: 10px;\n        background-color: black !important;\n        color: white !important;\n        box-shadow: 2px 2px 6px rgba(0,0,0,0.1);\n        max-width: 500px;\n        overflow-x: auto;\n        font-family: sans-serif;\n        font-size: 9pt;\n        white-space: nowrap;\n    \"\u003e\n        \u003ctable style=\"border-collapse: collapse; width: 100%;\"\u003e\n            \u003cthead\u003e\n                \u003ctr\u003e\n                    \u003cth style=\"text-align:left; padding: 4px;\"\u003eArea Name\u003c/th\u003e\n                    \u003cth style=\"text-align:left; padding: 4px;\"\u003e# Walks\u003c/th\u003e\n                    \u003cth style=\"text-align:left; padding: 4px;\"\u003e# Streets\u003c/th\u003e\n                    \u003cth style=\"text-align:left; padding: 4px;\"\u003e# Electors\u003c/th\u003e\n                \u003c/tr\u003e\n            \u003c/thead\u003e\n            \u003ctbody\u003e\n    \n        \u003ctr\u003e\n            \u003ctd style=\"padding: 4px;\"\u003eFARNHAM_NORTH_ED\u003c/td\u003e\n            \u003ctd style=\"padding: 4px;\"\u003e48\u003c/td\u003e\n            \u003ctd style=\"padding: 4px;\"\u003e238\u003c/td\u003e\n            \u003ctd style=\"padding: 4px;\"\u003e10409\u003c/td\u003e\n        \u003c/tr\u003e\n        \n            \u003c/tbody\u003e\n        \u003c/table\u003e\n    \u003c/div\u003e\n    "}, "HASLEMERE_ED": {"code": "HASLEMERE_ED", "details": ["K156", "K142", "K327", "K302", "K325", "K372", "K326", "K27", "K256", "K53", "K52", "K157", "K19", "K362", "K174", "K173", "K126", "K295", "K336", "K337", "K243", "K20", "K66", "K318", "K64", "K115", "K01", "K329", "K63", "K165", "K02", "K170", "K169", "K166", "K167", "K62", "K364", "K363", "K159", "K240", "K350", "K241", "K89", "K90", "K303", "K230", "K315", "K239", "K212"], "tooltip_html": "\n    \u003cdiv style=\"\n        border: 1px solid #ccc;\n        border-radius: 10px;\n        padding: 10px;\n        background-color: black !important;\n        color: white !important;\n        box-shadow: 2px 2px 6px rgba(0,0,0,0.1);\n        max-width: 500px;\n        overflow-x: auto;\n        font-family: sans-serif;\n        font-size: 9pt;\n        white-space: nowrap;\n    \"\u003e\n        \u003ctable style=\"border-collapse: collapse; width: 100%;\"\u003e\n            \u003cthead\u003e\n                \u003ctr\u003e\n                    \u003cth style=\"text-align:left; padding: 4px;\"\u003eArea Name\u003c/th\u003e\n                    \u003cth style=\"text-align:left; padding: 4px;\"\u003e# Walks\u003c/th\u003e\n                    \u003cth style=\"text-align:left; padding: 4px;\"\u003e# Streets\u003c/th\u003e\n                    \u003cth style=\"text-align:left; padding: 4px;\"\u003e# Electors\u003c/th\u003e\n                \u003c/tr\u003e\n            \u003c/thead\u003e\n            \u003ctbody\u003e\n    \n        \u003ctr\u003e\n            \u003ctd style=\"padding: 4px;\"\u003eHASLEMERE_ED\u003c/td\u003e\n            \u003ctd style=\"padding: 4px;\"\u003e49\u003c/td\u003e\n            \u003ctd style=\"padding: 4px;\"\u003e303\u003c/td\u003e\n            \u003ctd style=\"padding: 4px;\"\u003e9573\u003c/td\u003e\n        \u003c/tr\u003e\n        \n            \u003c/tbody\u003e\n        \u003c/table\u003e\n    \u003c/div\u003e\n    "}};

console.log("Injected task_tags:", window.task_tags);
console.log("Injected resources:", window.resources);
console.log("Injected places:", window.places);
console.log("Injected areas:", window.areas);

const DEVURLS = {"dev": "http://127.0.0.1:5000", "prod": "https://electtrek.com"} ;
const isDev = location.hostname.includes("localhost") || location.hostname.startsWith("127.");
const API = isDev ? DEVURLS["dev"] : "https://electtrek.com";


const calendarData = {};
const startHour = 9, endHour = 21, slotDuration = 2;



document.addEventListener("DOMContentLoaded", async () => {
  console.log("ğŸ“… Building calendarâ€¦");

  // Build the grid and load data
  buildCalendarGrid("calendar-grid", 45);
  populateDropdowns();
  await getCalendarUpdate();
  console.log("âœ… Calendar initialized.");

  // Buttons (use correct IDs)
  const saveCalendarBtn = document.getElementById("save-calendar-btn"); // âœ… matches HTML ID
  const generateSummaryBtn = document.getElementById("generate-summary-btn");
  const saveSlotBtn = document.getElementById("saveSlotBtn");
  const clearSlotBtn = document.getElementById("clearSlotBtn");

  // Attach button event handlers
  saveCalendarBtn.addEventListener("click", saveCalendarPlan);
  generateSummaryBtn.addEventListener("click", generateSummaryReport);
  saveSlotBtn.addEventListener("click", handleSaveSlot);
  clearSlotBtn.addEventListener("click", handleClearSlot);
});



// --- Slot Modal Handlers ---
async function handleSaveSlot() {
  if (!currentSlotId) return;

  const activity = document.getElementById("activitySelect").value;
  const place = document.getElementById("placeSelect").value;
  const area = document.getElementById("areaSelect").value;
  const resources = Array.from(document.getElementById("resourcesSelect").selectedOptions).map(o => o.value);

  calendarData[currentSlotId] = { activity, place, area, resources };

  redrawSlot(currentSlotId, calendarData[currentSlotId]);
  console.log(`ğŸ’¾ Slot ${currentSlotId} saved.`, calendarData[currentSlotId]);

  await saveCalendarPlan();
  bootstrap.Modal.getInstance(document.getElementById("slotModal")).hide();
}

async function handleClearSlot() {
  if (!currentSlotId) return;

  calendarData[currentSlotId] = {}; // clear memory
  redrawSlot(currentSlotId, {});
  console.log(`ğŸ—‘ï¸ Slot ${currentSlotId} cleared.`);

  await saveCalendarPlan();
  bootstrap.Modal.getInstance(document.getElementById("slotModal")).hide();
}

function generateSummaryReport() {
  const summary = extractCalendarPlan();
  const areas = window.areas || {};
  const places = window.places || {};
  const tags = window.task_tags || {};

  const summaryTable = buildSummaryTable(summary.slots, areas, places, tags);
  const container = document.getElementById("summary-report");
  container.innerHTML = "";
  container.appendChild(summaryTable);
}



// Modal logic
let currentSlotId = null;

async function saveCalendarPlan() {
  const btn = document.getElementById("save-calendar-btn");
  if (btn) {
    btn.disabled = true;
    btn.textContent = "ğŸ’¾ Saving...";
  }

  // Wrap the in-memory data correctly
  const dataToSave = { calendar_plan: { slots: calendarData } };

  try {
    const response = await fetch(`${API}/current-election`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(dataToSave)
    });

    if (!response.ok) throw new Error(`Server responded with ${response.status}`);

    if (btn) btn.textContent = "âœ… Saved!";
    console.log("ğŸ’¾ Calendar plan saved:", dataToSave);
  } catch (err) {
    console.error("âŒ Failed to save calendar plan:", err);
    if (btn) btn.textContent = "âŒ Save Failed";
  } finally {
    if (btn) {
      setTimeout(() => {
        btn.disabled = false;
        btn.textContent = "ğŸ’¾ Save Calendar";
      }, 2000);
    }
  }
}

function openSlotModal(slotId) {
  currentSlotId = slotId;
  const slotDiv = document.querySelector(`.slot[data-id="${slotId}"]`);
  const data = calendarData[slotId] || {}; // reference, not copy

  // Fill dropdowns
  fillSelect("activitySelect", window.task_tags);
  fillSelect("resourcesSelect", window.resources);
  fillSelect("placeSelect", window.places);
  fillSelect("areaSelect", window.areas);

  // Infer from lozenges if data is empty
  if (slotDiv && (!data.activity && !data.place && !data.area && (!data.resources || !data.resources.length))) {
    data.resources = [];
    const lozenges = Array.from(slotDiv.querySelectorAll(".lozenge"));
    lozenges.forEach(l => {
      switch (l.dataset.type) {
        case "activity": data.activity = l.dataset.code; break;
        case "place": data.place = l.dataset.code; break;
        case "area": data.area = l.dataset.code; break;
        case "resource": data.resources.push(l.dataset.code); break;
      }
    });
  }


  // Pre-select dropdowns
  document.getElementById("activitySelect").value = data.activity || "";
  document.getElementById("placeSelect").value = data.place || "";
  document.getElementById("areaSelect").value = data.area || "";
  const resSel = document.getElementById("resourcesSelect");
  Array.from(resSel.options).forEach(opt => {
    opt.selected = data.resources?.includes(opt.value) || false;
  });

  // Show modal
  const modalInstance = new bootstrap.Modal(document.getElementById("slotModal"));
  modalInstance.show();

}


async function getCalendarUpdate() {
  try {
    const response = await fetch(`${API}/current-election`);
    const data = await response.json();
    console.log("ğŸ“¦ Raw backend response:", data); // ğŸ‘ˆ Add this

    const plan = data.calendar_plan || data; // Handles both structures
    console.log("ğŸ“‹ Parsed plan object:", plan); // ğŸ‘ˆ Add this too

    if (plan?.slots) {
      loadCalendarPlan(plan);
      console.log("âœ… Calendar plan loaded into UI");
    } else {
      console.warn("âš ï¸ No slots found in backend data");
    }
  } catch (error) {
    console.error("ğŸš¨ Error fetching calendar plan:", error);
  }
}



function populateResourcesSelect(resourcesSelect, lozenges) {
  // First, clear all selections
  Array.from(resourcesSelect.options).forEach(opt => opt.selected = false);

  // Filter lozenges for type "resource"
  const resourceCodes = lozenges
    .filter(l => l.type === "resource")
    .map(l => l.code);

  // Select matching options
  Array.from(resourcesSelect.options).forEach(opt => {
    // Match by value first
    if (resourceCodes.includes(opt.value)) {
      opt.selected = true;
    } else {
      // Fallback: match by option text (if lozenge stores description instead of code)
      if (resourceCodes.includes(opt.text)) opt.selected = true;
    }
  });
}
</script>



  

  

  

  

  

  




<!-- PASSWORD OVERLAY + UNLOCK SCRIPT (injected) -->
<style>
  /* minimal overlay styles */
  #password-overlay {
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    background: rgba(255,255,255,0.95);
    z-index: 99999;
    display:flex;
    align-items:center;
    justify-content:center;
  }
  #password-overlay .box {
    background: #fff;
    padding: 14px;
    border-radius: 8px;
    box-shadow: 0 6px 24px rgba(0,0,0,0.14);
    max-width: 92vw;
  }
  #password-overlay input { font-size:14px; padding:8px; }
</style>

<div id="password-overlay" role="dialog" aria-modal="true" aria-label="Password required">
  <div class="box">
    <div style="margin-bottom:8px; font-weight:700;">Protected content</div>
    <div style="margin-bottom:8px;">
      <input id="password-input" type="password" placeholder="Enter password" />
      <button id="password-submit">Unlock</button>
    </div>
    <div id="password-error" style="color:#c00; display:none;">Incorrect password</div>
    <div style="margin-top:8px; font-size:12px; color:#666;">This is client-side gating only.</div>
  </div>
</div>

<script>
(async function() {
  const expectedHash = "fcf730b6d95236ecd3c9fc2d92d7b6b2bb061514961aec041d6c7a7192f592e4";

  async function sha256(str) {
    const utf8 = new TextEncoder().encode(str);
    const hashBuffer = await crypto.subtle.digest("SHA-256", utf8);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, "0")).join("");
  }

  async function unlock() {
    const input = document.getElementById('password-input');
    const err = document.getElementById('password-error');
    err.style.display = 'none';
    const val = (input && input.value) ? input.value : '';
    try {
      const h = await sha256(val);
      if (h === expectedHash) {
        // remove overlay
        const ov = document.getElementById('password-overlay');
        if (ov) ov.remove();

        // optionally unhide a content element (map or provided selector)
        try {
          const toShow = null;
          if (toShow) {
            // if element was hidden via display:none, remove that inline style
            toShow.style.display = '';
          }
        } catch(e) { /* ignore */ }

        try { sessionStorage.setItem("map_access_granted", "1"); } catch(e){}
      } else {
        err.style.display = 'block';
      }
    } catch(e) {
      console.error('Password check failed', e);
      err.style.display = 'block';
    }
  }

  document.getElementById('password-submit').addEventListener('click', unlock);
  const pw = document.getElementById('password-input');
  pw && pw.addEventListener('keydown', function(ev) { if (ev.key === 'Enter') { ev.preventDefault(); unlock(); } });

  // restore prior session
  try {
    if (sessionStorage.getItem("map_access_granted") === "1") {
      const ov = document.getElementById('password-overlay');
      if (ov) ov.remove();
      const toShow = null;
      if (toShow) toShow.style.display = '';
    }
  } catch(e){}
})();
</script>

</body></html>