{% extends "base.html" %}
{% block body %}

<style>
.body {
  font-family: sans-serif;
  margin: 20px;
}
/* Availability levels: 0 (none) to 10 (max) */
.slot[data-availability="0"] { background-color: #ffffff; } /* white / no availability */
.slot[data-availability="1"] { background-color: #e6f0ff; }
.slot[data-availability="2"] { background-color: #cce0ff; }
.slot[data-availability="3"] { background-color: #b3d1ff; }
.slot[data-availability="4"] { background-color: #99c2ff; }
.slot[data-availability="5"] { background-color: #80b3ff; }
.slot[data-availability="6"] { background-color: #66a3ff; }
.slot[data-availability="7"] { background-color: #4d94ff; }
.slot[data-availability="8"] { background-color: #3385ff; }
.slot[data-availability="9"] { background-color: #1a75ff; }
.slot[data-availability="10"] { background-color: #0066ff; } /* max */

h2 {
  position: fixed;
  top: 20px;
  left: 50px;
  z-index: 1000;
  background: white;
  padding: 4px 8px;
  margin: 0;
}
#summary-report {
  max-width: 100%;
  width: auto;
  overflow-x: auto;
}

#summary-report table {
  width: 100%;
  border-collapse: collapse;
}


</style>

<div class="container-fluid">
  <h2 class="text-center mb-4">{{ current_election }} Campaigns Calendar</h2>

  <!-- Fixed Buttons -->
  <div id="calendar-controls" class="fixed-buttons">
    <button id="save-calendar-btn" class="btn btn-primary">ğŸ’¾ Save Calendar</button>
    <button id="generate-summary-btn" class="btn btn-secondary">ğŸ“‹ Generate Calendar/Table</button>
    <button id="export-html-btn" class="btn btn-info">ğŸ” Export Protected HTML</button>
  </div>

  <!-- Tooltip (hidden by default) -->
  <div id="tooltip"
       style="display:none; position:absolute; background:#fff; border:1px solid #aaa; padding:5px 8px;
              border-radius:4px; box-shadow:0 0 5px rgba(0,0,0,0.2); font-size:12px; z-index:1000;">
  </div>

  <!-- Bootstrap Accordions for Palettes -->
  <div id="palette-container">

    <!-- Resources Palette -->
    <div class="accordion floating-accordion" id="resourcesAccordion">
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingResources">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                  data-bs-target="#collapseResources" aria-expanded="true" aria-controls="collapseResources">
            Resources
          </button>
        </h2>
        <div id="collapseResources" class="accordion-collapse collapse show" aria-labelledby="headingResources"
             data-bs-parent="#resourcesAccordion">
          <div class="accordion-body" id="resource-content"></div>
        </div>
      </div>
    </div>

    <!-- Areas Palette -->
    <div class="accordion floating-accordion" id="areasAccordion">
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingAreas">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                  data-bs-target="#collapseAreas" aria-expanded="true" aria-controls="collapseAreas">
            Areas
          </button>
        </h2>
        <div id="collapseAreas" class="accordion-collapse collapse show" aria-labelledby="headingAreas"
             data-bs-parent="#areasAccordion">
          <div class="accordion-body" id="areas-content"></div>
        </div>
      </div>
    </div>

    <!-- Activities Palette -->
    <div class="accordion floating-accordion" id="tagsAccordion">
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingTags">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                  data-bs-target="#collapseTags" aria-expanded="true" aria-controls="collapseTags">
            Activities
          </button>
        </h2>
        <div id="collapseTags" class="accordion-collapse collapse show" aria-labelledby="headingTags"
             data-bs-parent="#tagsAccordion">
          <div class="accordion-body" id="tags-content"></div>
        </div>
      </div>
    </div>

    <!-- Places Palette -->
    <div class="accordion floating-accordion" id="placesAccordion">
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingPlaces">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                  data-bs-target="#collapsePlaces" aria-expanded="true" aria-controls="collapsePlaces">
            Places
          </button>
        </h2>
        <div id="collapsePlaces" class="accordion-collapse collapse show" aria-labelledby="headingPlaces"
             data-bs-parent="#placesAccordion">
          <div class="accordion-body" id="places-content"></div>
        </div>
      </div>
    </div>

  </div>

  <!-- Calendar and Summary -->
  <div id="calendar-grid" class="calendar-grid mt-5"></div>
  <div id="summary-report" class="mt-4"></div>
</div>

{% endblock %}
<script>
  // ğŸ”¹ Global API & Data
  const DEVURLS = {{ DEVURLS | tojson }};
  const isDev = location.hostname.includes("localhost") || location.hostname.startsWith("127.");
  const API = isDev ? DEVURLS["dev"] : "__REPLACE_WITH_API_URL__";
  console.log("API :", API);

  window.resources = {{ resources | tojson }};
  window.task_tags = {{ task_tags | tojson }};
  window.places = {{ places | tojson }};
  window.areas = {{ areas | tojson }};
  console.log("Injected areas:", {{ areas | tojson }});

  // ğŸ”¹ DOMContentLoaded
  document.addEventListener("DOMContentLoaded", () => {

    buildCalendarGrid("calendar-grid", new Date(), 7); // builds a 7-day grid starting today


    // â”€â”€â”€ Build Palettes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    buildResourcePalette("resource-content");
    buildAreaPalette("areas-content");
    buildTaskTagsPalette("tags-content");
    buildPlacesPalette("places-content");

    let currentZIndex = 1000;

    const BUTTONS_HEIGHT = 120;
    const PALETTE_SPACING = 30;

    document.querySelectorAll(".collapsible-palette").forEach((palette, index) => {
      const header = palette.querySelector(".vertical-header");
      if (!header) return;

      // Initial positioning
      palette.style.position = "fixed";
      palette.style.top = `${BUTTONS_HEIGHT + index * PALETTE_SPACING}px`;
      palette.style.left = "10px";
      palette.style.zIndex = 1000;
      palette.classList.add("collapsed");

      // â”€â”€â”€ Drag & Touch support â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      let isDragging = false;
      let offsetX = 0;
      let offsetY = 0;

      const startDrag = (e) => {
        e.preventDefault();
        isDragging = true;
        palette.style.zIndex = ++currentZIndex;

        const rect = palette.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;

        offsetX = clientX - rect.left;
        offsetY = clientY - rect.top;
      };

      const moveDrag = (e) => {
        if (!isDragging) return;
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;

        let left = clientX - offsetX;
        let top = clientY - offsetY;

        // Keep within viewport
        left = Math.max(0, Math.min(left, window.innerWidth - palette.offsetWidth));
        top = Math.max(0, Math.min(top, window.innerHeight - palette.offsetHeight));

        palette.style.left = `${left}px`;
        palette.style.top = `${top}px`;
      };

      const endDrag = () => {
        isDragging = false;
      };

      header.addEventListener("mousedown", startDrag);
      header.addEventListener("touchstart", startDrag, { passive: false });
      window.addEventListener("mousemove", moveDrag);
      window.addEventListener("touchmove", moveDrag, { passive: false });
      window.addEventListener("mouseup", endDrag);
      window.addEventListener("touchend", endDrag);

      // Collapse toggle
      header.addEventListener("click", (e) => {
        if (isDragging) return;
        palette.classList.toggle("collapsed");
      });
    });

    // â”€â”€â”€ Make Palettes Sortable (clone to slots) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    ["resource-content", "areas-content", "tags-content", "places-content"].forEach(id => {
      const groupName = id.split("-")[0];
      Sortable.create(document.getElementById(id), {
        group: { name: groupName, pull: "clone", put: false },
        sort: false,
        animation: 150,
        fallbackOnBody: true,   // mobile support
        swapThreshold: 0.65
      });
    });

    // â”€â”€â”€ Make Slots Droppable â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.querySelectorAll(".slot").forEach(slot => {
      Sortable.create(slot, {
        group: { name: "calendar", put: ["resource", "areas", "tags", "places"] },
        animation: 150,
        filter: ".slot-label",
        onMove: evt => evt.related && evt.related.classList.contains("slot-label") ? false : true,
        onAdd: evt => {
          const el = evt.item;
          if (el.classList.contains("slot-label")) return;

          const newCode = el.getAttribute("data-code");
          const exists = [...slot.children].some(child => child !== el && child.getAttribute("data-code") === newCode);
          if (exists) { el.remove(); return; }

          el.classList.add("dropped");
          el.setAttribute("draggable", false);

          el.addEventListener("click", () => {
            el.remove();
            updateSlotAvailability(slot);
          });

          updateSlotAvailability(slot);
        }
      });

      updateSlotAvailability(slot); // initial
    });

    document.getElementById("save-calendar-btn").disabled = false;
    getCalendarUpdate();

  });

// â”€â”€â”€ Palette Builders â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// ğŸ”¹ Generic helper
function createPaletteItem(item, type) {
  const div = document.createElement("div");
  div.className = "palette-item border rounded p-2 mb-2 text-center";
  div.textContent = item.name;
  div.setAttribute("data-code", item.code);
  div.style.backgroundColor = item.color || "#f8f9fa";
  div.style.cursor = "grab";
  div.style.userSelect = "none";
  div.style.fontSize = "0.9em";
  div.title = `${type}: ${item.name}`;
  return div;
}

// ğŸ”¹ Resources Palette
function buildResourcePalette(containerId) {
  const container = document.getElementById(containerId);
  container.innerHTML = "";
  if (!window.resources || !window.resources.length) {
    container.innerHTML = "<em>No resources available</em>";
    return;
  }
  window.resources.forEach(res => {
    const el = createPaletteItem(res, "Resource");
    container.appendChild(el);
  });
}

// ğŸ”¹ Areas Palette
function buildAreaPalette(containerId) {
  const container = document.getElementById(containerId);
  container.innerHTML = "";
  if (!window.areas || !window.areas.length) {
    container.innerHTML = "<em>No areas available</em>";
    return;
  }
  window.areas.forEach(area => {
    const el = createPaletteItem(area, "Area");
    container.appendChild(el);
  });
}

// ğŸ”¹ Activities Palette (Task Tags)
function buildTaskTagsPalette(containerId) {
  const container = document.getElementById(containerId);
  container.innerHTML = "";
  if (!window.task_tags || !window.task_tags.length) {
    container.innerHTML = "<em>No task_tags available</em>";
    return;
  }
  window.task_tags.forEach(tag => {
    const el = createPaletteItem(tag, "Activity");
    container.appendChild(el);
  });
}

// ğŸ”¹ Places Palette
function buildPlacesPalette(containerId) {
  const container = document.getElementById(containerId);
  container.innerHTML = "";
  console.log("Building places palette with:", window.places);
  if (!window.places || !window.places.length) {
    container.innerHTML = "<em>No places available</em>";
    return;
  }
  window.places.forEach(place => {
    const el = createPaletteItem(place, "Place");
    container.appendChild(el);
  });
}


// â”€â”€â”€ Calendar Builder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function buildCalendarGrid(containerId, startDate = null, numDays = 7) {
  const container = document.getElementById(containerId);
  container.innerHTML = "";

  const today = startDate ? new Date(startDate) : new Date();
  const table = document.createElement("table");
  table.className = "table table-bordered calendar-table";
  table.style.width = "100%";
  table.style.tableLayout = "fixed";

  const thead = document.createElement("thead");
  const headerRow = document.createElement("tr");
  for (let i = 0; i < numDays; i++) {
    const date = new Date(today);
    date.setDate(today.getDate() + i);
    const th = document.createElement("th");
    th.textContent = date.toLocaleDateString(undefined, { weekday: "short", month: "short", day: "numeric" });
    headerRow.appendChild(th);
  }
  thead.appendChild(headerRow);
  table.appendChild(thead);

  const tbody = document.createElement("tbody");
  const row = document.createElement("tr");
  for (let i = 0; i < numDays; i++) {
    const td = document.createElement("td");
    td.classList.add("slot");
    td.setAttribute("data-availability", "0");
    td.style.height = "120px";
    td.style.verticalAlign = "top";
    td.style.position = "relative";
    td.style.overflowY = "auto";
    row.appendChild(td);
  }
  tbody.appendChild(row);
  table.appendChild(tbody);

  container.appendChild(table);
}
</script>
