<!DOCTYPE html>
<html lang="en">
<head>
  <!-- In your HTML file -->
<link rel="stylesheet" href="https://unpkg.com/tippy.js@6/dist/tippy.css" />
<script src="https://unpkg.com/@popperjs/core@2"></script>
<script src="https://unpkg.com/tippy.js@6"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
  <meta charset="UTF-8">
  <title>44-Day Calendar (Aligned Weeks)</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }

    resource-item {
  background-color: #e6f7ff;
  border: 1px solid #91d5ff;
  border-radius: 12px;
  padding: 4px 10px;
  font-weight: bold;
  color: #0050b3;
  cursor: grab;
}

/* Availability levels: 0 (none) to 10 (max) */
.slot[data-availability="0"] { background-color: #ffffff; } /* white / no availability */
.slot[data-availability="1"] { background-color: #e6f0ff; }
.slot[data-availability="2"] { background-color: #cce0ff; }
.slot[data-availability="3"] { background-color: #b3d1ff; }
.slot[data-availability="4"] { background-color: #99c2ff; }
.slot[data-availability="5"] { background-color: #80b3ff; }
.slot[data-availability="6"] { background-color: #66a3ff; }
.slot[data-availability="7"] { background-color: #4d94ff; }
.slot[data-availability="8"] { background-color: #3385ff; }
.slot[data-availability="9"] { background-color: #1a75ff; }
.slot[data-availability="10"] { background-color: #0066ff; } /* max */


.palette-header {
  background-color: #ddd;
  padding: 6px 10px;
  font-weight: bold;
  cursor: move;
  border-bottom: 1px solid #aaa;
  user-select: none;
}

.lozenge-selected {
  outline: 2px solid #1890ff;
  background-color: #cceeff !important;
  box-shadow: 0 0 5px rgba(0, 136, 255, 0.6);
}


.floating-palette {
  position: fixed;
  background-color: #f9f9f9;
  border: 2px solid #aaa;
  border-radius: 8px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.2);
  z-index: 999;
  width: 200px;
}



    .calendar-grid {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .election-highlight {
      border: 2px double red;!important;
      box-sizing: border-box;
    }

    .today-highlight {
      border: 2px double blue;!important;
      box-sizing: border-box;
    }

    .slot:hover {
  background-color: #cce5ff;
  cursor: pointer;
}

    .week-row {
      display: flex;
      gap: 2px;
    }

    .day-column, .empty-day {
      width: 120px;
      height: 300px;
      border: 1px solid #ddd;
      background-color: #f5f5f5;
      display: flex;
      flex-direction: column;
    }

    .day-column.today-cell {
  border: 4px double #007BFF !important;
}


#calendar-controls {
  position: fixed;
  top: 20px;
  right: 50px;
  z-index: 1000;
}

#calendar-controls button {
  padding: 6px 12px;
  font-size: 14px;
  margin-left: 10px;
}

    .empty-day {
      background-color: #fff;
      border: none;
    }

    .day-header {
      background-color: #e0e0e0;
      padding: 4px;
      text-align: center;
      font-weight: bold;
      border-bottom: 1px solid #ccc;
    }

    .slot {
      flex: 1;
      border-top: 1px solid #ccc;
      padding: 2px;
      font-size: 11px;
      font-weight: 300;
      color: #333;
      min-height: 30px;
      line-height: 1;
    }



.walk-lozenge,
.tag-lozenge,
.resource-lozenge,
.place-lozenge {
  background-color: #e0f0ff;
  border-radius: 15px;
  padding: 4px 8px; /* Smaller padding */
  font-weight: bold;
  font-size: 13px;
  cursor: grab;
  display: inline-block; /* Ensures width fits text */
  margin: 2px;
  white-space: nowrap; /* Prevent text wrapping */
}


/* Compact style when dropped */
.walk-lozenge.dropped,
.tag-lozenge.dropped,
.resource-lozenge.dropped,
.place-lozenge.dropped  {
  font-size: 8px;
  padding: 2px 6px;
  margin: 1px 0; /* ‚¨ÖÔ∏è Tight vertical spacing */
  cursor: pointer;
  display: inline-block;
  white-space: nowrap;
  line-height: 1; /* ‚¨ÖÔ∏è Minimal line height */
}



.walk-lozenge {
  background-color: #d4edda; /* ‚úÖ Light green */
}

.tag-lozenge {
  background-color: #fff3cd; /* ‚úÖ Light yellow */
}

.resource-lozenge {
  background-color: #f8d7da; /* ‚úÖ Light red */
}

.place-lozenge {
  background-color: #d1ecf1; /* ‚úÖ Light cyan */
}
.summary-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 1em;
  table-layout: auto; /* allow flexible column sizes */
}

.summary-table th,
.summary-table td {
  border: 1px solid #ccc;
  padding: 8px;
  vertical-align: top;
  text-align: left;
}

/* Minimize width of first two columns */
.summary-table th:nth-child(1),
.summary-table td:nth-child(1),
.summary-table th:nth-child(2),
.summary-table td:nth-child(2) {
  white-space: nowrap;
  width: 1%;
}
.walk-tooltip {
  color: white;  !important;       /* or another visible color */
  background-color: black;!important;
}
.walk-tooltip ul {
  list-style: disc;
  margin: 0;
  padding-left: 20px;
  color: white;!important;
}

  </style>
</head>
<body>

  <h2>{{current_election}} Elections Calendar </h2>
  <div id="calendar-controls" style="position: fixed; top: 20px; right: 50px; z-index: 1000;">
  <button id="save-calendar-btn" style="padding: 6px 12px; font-size: 14px;">üíæ Save Calendar</button>
  <button id="generate-summary-btn" style="padding: 6px 12px; font-size: 14px; margin-left: 10px;">üìã Generate Calendar/Table</button>
  <button id="export-html-btn" style="padding: 6px 12px; font-size: 14px; margin-top:8px;">üîê Export Protected HTML</button>

</div>


  <div id="tooltip" style="display:none; position:absolute; background:#fff; border:1px solid #aaa; padding:5px 8px; border-radius:4px; box-shadow:0 0 5px rgba(0,0,0,0.2); font-size:12px; z-index:1000;"></div>
  <!-- Resource -->
  <!-- Existing Resource Palette -->
  <div id="resource-palette" class="floating-palette" style="top: 460px; right: 50px;">
    <div id="resource-handle" class="palette-header">Who - Resources</div>
    <div id="resource-content">
      {% for key, value in resources.items() %}
        <div class="resource-lozenge"
             data-id="{{ key }}"
             data-type="resource"
             data-info="{{ value.Firstname }} {{ value.Surname }} {{ value.Status }}"
             draggable="true">
          {{ key }}
        </div>
      {% endfor %}
    </div>
  </div>

  <!-- New Walks Palette -->
  <div id="walks-palette" class="floating-palette" style="top: 100px; right: 50px;">
    <div id="walks-handle" class="palette-header">Where - Zone-Walks</div>
    <div id="walks-content">
      {% for w in walks %}
      <div class="walk-lozenge" data-id="{{ loop.index0 }}" data-type="walk" data-info="{{ w }}" draggable="true">{{ w }}</div>
      {% endfor %}
    </div>
  </div>

  <!-- New Task Tags Palette -->
  <div id="tags-palette" class="floating-palette" style="top: 280px; right: 50px;">
    <div id="tags-handle" class="palette-header">What - Activities</div>
    <div id="tags-content">
      {% for code,desc in task_tags.items() %}
      <div class="tag-lozenge" data-id="{{ loop.index0 }}" data-type="tag" data-info="{{ desc }}" draggable="true">{{ code }}</div>
      {% endfor %}
    </div>
  </div>


  <!-- New Places Palette -->
  <div id="places-palette" class="floating-palette" style="top: 640px; right: 50px;">
    <div id="places-handle" class="palette-header">Where - Places</div>
    <div id="places-content" class="palette-group">
  {% for place in places %}
  <div class="place-lozenge" data-type="place" title="{{ place.tooltip }}">{{ place.code }}</div>
  {% endfor %}
</div>
  </div>

  <!-- Your calendar grid -->
  <div class="calendar-grid" id="calendar-grid"></div>
  <h3>üìã Calendar Summary Table</h3>
<div id="calendar-summary"></div>

</body>
<script>

  // Make backend data available to JS
  window.tagDescriptions = {{ task_tags | tojson }};
  window.placeDetails = {{ places | tojson }};
  window.walkDetails = {{ walks | tojson }};
  console.log("Injected walks:", {{ walks | tojson }});


  function setupWalkLozengeTooltips() {
    const walkLozenges = document.querySelectorAll('.walk-lozenge');

    walkLozenges.forEach(loz => {
      const code = loz.textContent.trim();  // e.g., "K01"
      const walkInfo = window.walkDetails?.[code];

      if (walkInfo?.tooltip_html) {
        tippy(loz, {
          content: walkInfo.tooltip_html,
          allowHTML: true,
          interactive: false,
          theme: 'light', // optional
        });
      }
    });
  }


  function generateSummaryReport() {
    const summaryContainer = document.getElementById("summary-report");
    summaryContainer.innerHTML = ""; // Clear previous report

    const state = extractCalendarPlan();
    if (!state?.slots) return;

    const table = document.createElement("table");
    table.className = "summary-table";

    const headerRow = document.createElement("tr");
    ["Date + Time", "Who", "What", "Where"].forEach(headerText => {
      const th = document.createElement("th");
      th.textContent = headerText;
      headerRow.appendChild(th);
    });
    table.appendChild(headerRow);

    const dayColumns = [...document.querySelectorAll(".day-column")];

    Object.entries(state.slots).forEach(([key, slot]) => {
      const [dayIndexStr, time] = key.split("_");
      const dayIndex = parseInt(dayIndexStr, 10);
      const col = dayColumns[dayIndex];
      const dateStr = col?.querySelector(".day-header")?.textContent || "Unknown Date";

      // WHO = resources
      const who = slot.lozenges
        .filter(l => l.type === "resource")
        .map(l => l.code)
        .join(", ");

      // WHAT = task + tag
      const taskTags = slot.lozenges
        .filter(l => l.type === "task" || l.type === "tag")
        .map(l => {
          const desc = window.tagDescriptions?.[l.code] || "(no description)";
          return `${l.code}${l.type === "tag" ? `: ${desc}` : ""}`;
        })
        .join(", ");

      // WHERE = walk + place
      const walkItems = slot.lozenges
        .filter(l => l.type === "walk")
        .map(l => {
          const walk = window.walkDetails?.[l.code];
          return walk && walk.streets?.length
            ? `${l.code}: ${walk.streets.join("; ")}`
            : l.code;
        });

      const placeItems = slot.lozenges
        .filter(l => l.type === "place")
        .map(l => {
          const place = window.placeDetails?.find(p => p.code === l.code);
          return place ? `${place.code}: ${place.tooltip}` : l.code;
        });

      const whereParts = [];
      if (walkItems.length) whereParts.push(`Walk: ${walkItems.join(" | ")}`);
      if (placeItems.length) whereParts.push(`Place: ${placeItems.join(" | ")}`);
      const where = whereParts.join(" | ");

      // Build row
      const row = document.createElement("tr");
      [ `${dateStr}, ${time}`, who, taskTags, where ].forEach(cellText => {
        const td = document.createElement("td");
        td.textContent = cellText;
        row.appendChild(td);
      });

      table.appendChild(row);
    });

    summaryContainer.appendChild(table);
  }


function updateSlotAvailability(slot) {
  const resourceCount = [...slot.children].filter(child =>
    child.classList.contains('resource-lozenge')
  ).length;

  const availabilityLevel = Math.min(10, Math.ceil(resourceCount / 2));

  slot.setAttribute("data-availability", availabilityLevel);
  slot.setAttribute("title", `${availabilityLevel * 2} resources available`);
}


function setupPaletteSelection() {
  document.body.addEventListener('click', function (e) {
    if (
      e.target.classList.contains('walk-lozenge') ||
      e.target.classList.contains('tag-lozenge') ||
      e.target.classList.contains('resource-lozenge') ||
      e.target.classList.contains('place-lozenge')
    ) {
      e.stopPropagation();
      e.target.classList.toggle('lozenge-selected');
    }
  });
}




    const tooltip = document.getElementById('tooltip');

    document.body.addEventListener('mouseover', function (e) {
      const target = e.target;

      if (target.classList.contains('walk-lozenge') ||
          target.classList.contains('tag-lozenge') ||
          target.classList.contains('resource-lozenge') ||
          target.classList.contains('place-lozenge'))
           {

        const info = target.getAttribute('data-info') || 'No details';

        tooltip.textContent = info;
        tooltip.style.display = 'block';
        tooltip.style.left = `${e.pageX + 10}px`;
        tooltip.style.top = `${e.pageY + 10}px`;
      }
    });

    document.body.addEventListener('mousemove', function (e) {
      if (tooltip.style.display === 'block') {
        tooltip.style.left = `${e.pageX + 10}px`;
        tooltip.style.top = `${e.pageY + 10}px`;
      }
    });

    document.body.addEventListener('mouseout', function (e) {
      const target = e.target;

      if (target.classList.contains('walk-lozenge') ||
          target.classList.contains('tag-lozenge') ||
          target.classList.contains('resource-lozenge') ||
            target.classList.contains('place-lozenge'))  {
        tooltip.style.display = 'none';
      }
    });

    function makePaletteDraggable(paletteId, handleId) {
    const palette = document.getElementById(paletteId);
    const handle = document.getElementById(handleId);
    let isDragging = false, offsetX = 0, offsetY = 0;

    handle.addEventListener("mousedown", e => {
      isDragging = true;
      offsetX = e.clientX - palette.offsetLeft;
      offsetY = e.clientY - palette.offsetTop;
      document.body.style.userSelect = "none";
    });

    document.addEventListener("mousemove", e => {
      if (isDragging) {
        palette.style.left = `${e.clientX - offsetX}px`;
        palette.style.top = `${e.clientY - offsetY}px`;
      }
    });
    document.addEventListener("mouseup", () => {
      isDragging = false;
      document.body.style.userSelect = "auto";
    });
  }


  // Enable draggable behavior on all three palettes
  makePaletteDraggable("resource-palette", "resource-handle");
  makePaletteDraggable("walks-palette", "walks-handle");
  makePaletteDraggable("tags-palette", "tags-handle");
  makePaletteDraggable("places-palette", "places-handle");

  document.addEventListener("DOMContentLoaded", async () => {
    document.getElementById("save-calendar-btn").addEventListener("click", saveCalendarPlan);

    setupPaletteSelection();

    const container = document.getElementById("calendar-grid");
    const daysToShow = 45;
    const slots = ["9 AM", "11 AM", "1 PM", "3 PM", "5 PM"];

    // ‚úÖ Use election date from parent window
    function parseYYYYMMDD(str) {
      const [year, month, day] = str.split("-");
      return new Date(parseInt(year, 10), parseInt(month, 10) - 1, parseInt(day, 10));
    }


    const electionDateStr = window.parent.document.getElementById('electiondate')?.value;
    const endDate = parseYYYYMMDD(electionDateStr);

    const startDate = new Date(endDate);
    startDate.setDate(endDate.getDate() - (daysToShow - 1));

    let weekRow = document.createElement("div");
    weekRow.className = "week-row";

    // Align first row (starting from Monday)
    const startDayOfWeek = startDate.getDay();
    const offset = (startDayOfWeek === 0) ? 6 : startDayOfWeek - 1;


    // Add blanks before the first real day if start isn't Monday
    for (let i = 0; i < offset; i++) {
    const empty = document.createElement("div");
    empty.className = "empty-day";
    weekRow.appendChild(empty);
    }

    for (let i = 0; i < daysToShow; i++) {
    const date = new Date(startDate);
    date.setDate(startDate.getDate() + i);

    const dayNumber = date.getDate();
    const weekday = date.toLocaleDateString(undefined, { weekday: 'short' });
    const dayOfWeek = date.getDay(); // 0 = Sunday

    const dayDiv = document.createElement("div");
    dayDiv.className = "day-column";

    const header = document.createElement("div");
    header.className = "day-header";
    header.textContent = `${weekday} ${dayNumber}`;

    const today = new Date();
    today.setHours(0,0,0,0);

    const cellDate = new Date(date);
    cellDate.setHours(0,0,0,0);

    if (cellDate.toDateString() === today.toDateString()) {
      dayDiv.classList.add("today-cell");
    }


    dayDiv.appendChild(header);

    for (const slotName of slots) {
      const slotDiv = document.createElement("div");
      slotDiv.className = "slot";
      slotDiv.setAttribute("data-availability", "0");
      slotDiv.setAttribute("title", `${0} resources available`);
      slotDiv.setAttribute("data-time", slotName);

      // Create a child div ONLY for the slot time label
      const timeLabel = document.createElement("div");
      timeLabel.className = "slot-label";
      timeLabel.textContent = slotName;

      slotDiv.appendChild(timeLabel);

      // Your existing click event and other logic on slotDiv goes here

      dayDiv.appendChild(slotDiv);

    }


    weekRow.appendChild(dayDiv);


    // Wrap row on Sundays
    if (dayOfWeek === 0 || i === daysToShow - 1) {
      container.appendChild(weekRow);
      weekRow = document.createElement("div");
      weekRow.className = "week-row";
    }
    }
    await loadCalendarPlan(); // ‚úÖ Fetch and restore on load

      // Make each slot droppable
      // Setup Sortable group behavior
      // Palettes: distinct groups with clone pull, no put
    ["resource-content", "walks-content", "tags-content", "places-content"].forEach((id) => {
    const groupName = id.split("-")[0]; // 'resource', 'walks', or 'tags'
    Sortable.create(document.getElementById(id), {
      group: { name: groupName, pull: "clone", put: false },
      sort: false,
      animation: 150,
    });
  });




  // Slots: accept all groups
  document.querySelectorAll(".slot").forEach(slot => {
    Sortable.create(slot, {
      group: {
        name: "calendar",
        put: ["resource", "walks", "tags", "places"]
      },
      animation: 150,
      onAdd: evt => {
        const el = evt.item;
        const slot = evt.to;

        const alreadyExists = [...slot.children].some(child =>
          child !== el && child.textContent === el.textContent
        );

        if (alreadyExists) {
          el.remove();
          return;
        }

        el.classList.add('dropped');
        el.setAttribute('draggable', false);

        el.addEventListener('click', () => {
          el.remove();
          updateSlotAvailability(slot);  // üëà Recalculate on removal
        });

        updateSlotAvailability(slot);  // üëà Recalculate on add
      }
    });

  });

  document.querySelectorAll(".slot").forEach(slot => {
  updateSlotAvailability(slot);
  });


  });

  function extractCalendarPlan() {
  const state = { slots: {} };

  const dayColumns = [...document.querySelectorAll(".day-column")];

  dayColumns.forEach((col, dayIndex) => {
    const slots = col.querySelectorAll(".slot");

    slots.forEach((slot, slotIndex) => {
      const timeLabel = slot.querySelector(".slot-label");
      if (!timeLabel) {
        console.warn(`‚ö†Ô∏è Slot ${slotIndex} in day ${dayIndex} has no time label, skipping`);
        return;
      }

      const time = timeLabel.textContent.trim();
      const key = `${dayIndex}_${time}`;
      const availability = parseInt(slot.getAttribute("data-availability")) || 0;

      // Collect lozenges
      const lozengeElements = [...slot.children].filter(child =>
        child.classList.contains("walk-lozenge") ||
        child.classList.contains("tag-lozenge") ||
        child.classList.contains("resource-lozenge") ||
        child.classList.contains("place-lozenge") // Include task lozenges if relevant
      );

      const lozenges = lozengeElements.map(loz => ({
        type: loz.getAttribute("data-type"),
        code: loz.textContent.trim()
      }));

      if (lozenges.length > 0 || availability > 0) {
        state.slots[key] = {
          availability,
          lozenges
        };

      } else {

      }
    });
  });

  console.log("‚úÖ Final extracted plan:", state);
  return state;
};

function restoreCalendarPlan(data) {
const dayColumns = [...document.querySelectorAll(".day-column")];

Object.entries(data.slots).forEach(([key, slotData]) => {
  const [dayIndexStr, timeLabel] = key.split("_");
  const dayIndex = parseInt(dayIndexStr, 10);

  const col = dayColumns[dayIndex];
  if (!col) return;

  const slots = [...col.querySelectorAll(".slot")];

  // ‚úÖ Use only the time label for matching
  console.log("üîç Looking for slot", timeLabel);
console.log("üîç In column", dayIndex, "slots are:", slots.map(s => s.textContent));

  const targetSlot = slots.find(s => s.getAttribute("data-time") === timeLabel);
  if (!targetSlot) return;

  // Set availability
  targetSlot.setAttribute("data-availability", slotData.availability);
  targetSlot.setAttribute("title", `${slotData.availability * 2} resources available`);

  // Remove existing lozenges
  [...targetSlot.children].forEach(child => {
    if (
      child.classList.contains("walk-lozenge") ||
      child.classList.contains("tag-lozenge") ||
      child.classList.contains("resource-lozenge") ||
      child.classList.contains("place-lozenge")
    ) {
      child.remove();
    }
  });

  // Re-add lozenges
  slotData.lozenges.forEach(loz => {
    const div = document.createElement("div");
    div.className = `${loz.type}-lozenge dropped`;
    div.setAttribute("data-type", loz.type);
    div.setAttribute("draggable", false);
    div.textContent = loz.code;


    // Tooltip for walk lozenges
    if (loz.type === "walk") {
      const walkInfo = window.walkDetails?.[loz.code];
      if (walkInfo && walkInfo.tooltip_html) {
        tippy(div, {
          content: walkInfo.tooltip_html,
          allowHTML: true,
          interactive: false,
          theme: 'light',  // optional styling
        });
      }
    }

    // Tooltip for places
    if (loz.type === "place" && loz.tooltip) {
      tippy(div, {
        content: loz.tooltip,
        allowHTML: true,
        interactive: false,
        theme: 'light',
      });
    }

    // Tooltip for places, tags etc
    if (loz.type === "place" && loz.tooltip) {
      div.setAttribute("title", loz.tooltip);
    }

    div.addEventListener("click", () => {
      div.remove();
      updateSlotAvailability(targetSlot);
    });

    targetSlot.appendChild(div);
  });


  updateSlotAvailability(targetSlot);
});
}



  async function fetchCurrentElection() {
    try {
      const response = await fetch('/current-election', {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        }
      });

      if (!response.ok) throw new Error('Failed to fetch CurrentElection');

      const data = await response.json();
      return data;
    } catch (error) {
      console.error('Error fetching CurrentElection:', error);
      return null;
    }
  }

  function saveCalendarPlan() {
    const btn = document.getElementById("save-calendar-btn");
    btn.disabled = true;
    btn.textContent = "üíæ Saving...";

    const calendarData = extractCalendarPlan();

    fetch("/current-election", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        plan: calendarData
      })
    })
    .then(response => {
      if (!response.ok) throw new Error("Failed to save calendar");
      return response.json();
    })
    .then(() => {
      btn.textContent = "‚úÖ Saved";
      setTimeout(() => {
        btn.textContent = "üíæ Save Calendar";
        btn.disabled = false;
      }, 1500);
    })
    .catch(error => {
      btn.textContent = "‚ö†Ô∏è Error";
      btn.disabled = false;
      console.error("Save failed:", error);
    });
  }


  async function loadCalendarPlan() {
    console.log("üîÅ loadCalendarPlan called");
    try {
      const response = await fetch('/current-election');
      console.log("üîÅ Fetch /current-election status:", response.status);
      if (!response.ok) throw new Error("Failed to fetch election");

      const electionData = await response.json();
      console.log("üì• electionData:", electionData);

      if (electionData.calendar_plan?.plan) {
        console.log("üì¶ Passing plan to restore:", electionData.calendar_plan.plan);
        restoreCalendarPlan(electionData.calendar_plan.plan);
      } else {
        console.warn("‚ö†Ô∏è No calendar_plan.plan in electionData");
      }
    } catch (err) {
      console.error("‚ùå Error in loadCalendarPlan():", err);
    }
  }

  document.getElementById("export-html-btn").addEventListener("click", async () => {
    await saveCalendarPlan();
    const btn = document.getElementById("export-html-btn");
    btn.disabled = true;
    btn.textContent = "üîÑ Exporting...";

    try {
      // Create a standalone HTML document
      const htmlContent = createStandaloneHTML();

      // Create a Blob and FormData to send as 'file'
      const blob = new Blob([htmlContent], { type: "text/html" });
      const formData = new FormData();
      formData.append("file", blob, "calendar.html");

      // Upload to backend
      const response = await fetch("/api/upload-and-protect", {
        method: "POST",
        body: formData
      });

      const result = await response.json();

      if (!response.ok || !result.ok) {
        throw new Error(result.error || "Upload failed");
      }

      btn.textContent = "‚úÖ Exported & Protected";
    } catch (err) {
      console.error("Export failed:", err);
      btn.textContent = "‚ùå Failed";
    } finally {
      setTimeout(() => {
        btn.textContent = "üîê Export Protected HTML";
        btn.disabled = false;
      }, 1500);
    }
  });

  function createStandaloneHTML() {
    // Clone current document content
    const doctype = "<!DOCTYPE html>";
    const html = document.documentElement.cloneNode(true);

    // Inline all CSS (optional enhancement if you want standalone styles)
    // You can also leave <link rel="stylesheet"> tags alone if your server will serve them

    // Serialize to full HTML string
    return doctype + "\n" + html.outerHTML;
  }


  document.getElementById("generate-summary-btn").addEventListener("click", function () {
    const summary = extractCalendarPlan();

    const summaryTable = document.createElement("table");
    summaryTable.className = "summary-table";
    summaryTable.innerHTML = `
      <thead>
        <tr>
          <th>Date & Time</th>
          <th>Activities</th>
          <th>Resources</th>
          <th>Places</th>
        </tr>
      </thead>
      <tbody></tbody>
    `;

    const tbody = summaryTable.querySelector("tbody");

    const walks = window.walkData || {};
    const places = window.placeData || [];
    const tags = window.tagDescriptions || {};
    const placeMap = Object.fromEntries(places.map(p => [p.code, p.tooltip]));

    Object.entries(summary.slots).forEach(([key, slot]) => {
      const [dayIndex, time] = key.split("_");

      const resourceList = [];
      const placeList = [];
      const activityList = [];

      slot.lozenges.forEach(loz => {
        switch (loz.type) {
          case "resource":
            resourceList.push(loz.code);
            break;

          case "walk": {
            const div = document.createElement("div");
            div.className = `${loz.type}-lozenge`;
            div.setAttribute("data-type", loz.type);
            div.setAttribute("draggable", false);
            div.textContent = loz.code;

            let walkInfo = window.walkDetails?.[loz.code];
            console.log("üì• walkinfo:", walkInfo);

            if (walkInfo?.tooltip_html) {
              tippy(div, {
                content: walkInfo.tooltip_html,
                allowHTML: true,
                interactive: false,
                theme: 'light', // Optional: 'light-border' is another good one
              });
            }
          }

            case "place": {
              const placeInfo = window.placeDetails?.find(p => p.code === loz.code);
              if (placeInfo) {
                placeList.push(`${loz.code} ‚Äì ${placeInfo.tooltip}`);
              } else {
                placeList.push(`${loz.code} ‚Äì (place unknown)`);
              }
              break;
            }

            case "tag": {
              const tagDesc = window.tagDescriptions?.[loz.code] || "";
              activityList.push(`${loz.code} ‚Äì ${tagDesc}`);
              break;
            }

            placeList.push(div.outerHTML);  // Optional if you're building a table
            break;
          }
      });


      slot.lozenges.forEach(loz => {
        switch (loz.type) {
          case "resource":
            resourceList.push(loz.code);
            break;

          case "walk": {
            const div = document.createElement("div");
            div.className = `${loz.type}-lozenge`;
            div.setAttribute("data-type", loz.type);
            div.setAttribute("draggable", false);
            div.textContent = loz.code;
            walkInfo = window.walkDetails?.[loz.code];  // ‚úÖ Corrected
            console.log("üì• walkinfo:", walkInfo);

            if (walkInfo && walkInfo.tooltip_html) {
              tippy(div, {
                content: walkInfo.tooltip_html,
                allowHTML: true,
                interactive: false,
                theme: 'light',  // optional styling
              });
            };

            if (walkInfo) {
              const fullWalk = `Walk Area: ${loz.code} ‚Äì ${walkInfo.streets.join(", ")}`;
              placeList.push(fullWalk);
            } else {
              placeList.push(`Walk Area: ${loz.code}`);
            }
            break;
          }

          case "place": {
            const placeInfo = window.placeDetails?.find(p => p.code === loz.code);
            if (placeInfo) {
              placeList.push(`${loz.code} ‚Äì ${placeInfo.tooltip}`);
            } else {
              placeList.push(`${loz.code} ‚Äì (place unknown)`);
            }
            break;
          }

          case "tag": {
            const tagDesc = window.tagDescriptions?.[loz.code] || "";
            activityList.push(`${loz.code} ‚Äì ${tagDesc}`);
            break;
          }

          default:
            console.warn("Unknown lozenge type:", loz.type);
        }
      });

      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${time}</td>
        <td>${activityList.join("<br>")}</td>
        <td>${resourceList.join(", ")}</td>
        <td>${placeList.join("<br>")}</td>
      `;
      tbody.appendChild(row);
    });

    const container = document.getElementById("calendar-summary");
    container.innerHTML = ""; // Clear previous content
    container.appendChild(summaryTable);
  });

  document.addEventListener("DOMContentLoaded", () => {
    setupPaletteSelection();
    setupWalkLozengeTooltips(); // ‚úÖ Enable walk tooltips
  });


  </script>

</body>
</html>
