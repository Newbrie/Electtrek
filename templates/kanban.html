<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Kanban Board with Doughnut Chart</title>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background-color: #f8f9fa;
      margin: 0;
      padding: 0;
    }

    .chartjs-tooltip {
  z-index: 9999 !important;
}


.kanban-legend {
  position: absolute;
  bottom: 20px;
  right: 20px;
  background: rgba(255, 255, 255, 0.9);
  border: 1px solid #ccc;
  padding: 10px;
  max-width: 250px;
  font-size: 12px;
  box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.1);
  z-index: 1000;
  border-radius: 5px;
}


.kanban-legend h4 {
  margin: 0 0 5px 0;
  font-size: 13px;
}

.kanban-legend .legend-item {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 4px;
}

.kanban-legend .legend-color {
  display: inline-block;
  width: 12px;
  height: 12px;
  border: 1px solid #333;
  background-color: #000; /* optional fallback */
}



    .kanban-board {
      display: flex;
      gap: 0;
      border-top: 2px solid #ccc;
      border-left: 2px solid #ccc;
    }

    .kanban-column {
      flex: 1;
      border-right: 2px solid #ccc;
      border-bottom: 2px solid #ccc;
      background-color: #ffffff;
      display: flex;
      flex-direction: column;
    }

    .kanban-header {
      background-color: #e0e0e0;
      padding: 10px;
      text-align: center;
      font-weight: bold;
      font-size: 1.1em;
      border-bottom: 2px solid #ccc;
    }

    .circle-container {
      flex: 1;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-content: flex-start;
      padding: 10px;
      gap: 10px;
      overflow: visible;
    }

    .circle {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      color: white;
      font-weight: bold;
      cursor: grab;
      box-sizing: border-box;
      width: 150px;  /* Default size */
      height: 150px; /* Default size */
      padding: 10px;
      border-radius: 50%;
      overflow: visible; /* Important */
      z-index: 1;
    }

    .circle-label {
      position: absolute;
      top: -1.4em;
      left: 50%;
      transform: translateX(-50%);
      font-size: 12px;
      color: #333;
      font-weight: bold;
      white-space: nowrap;
      text-align: center;
    }


    .circle div {
      font-size: 0.2em;
      line-height: 1.2;
      padding: 4px;
       overflow: visible;
    }

    .circle-container,
    .circle {
      overflow: visible !important;
      z-index: 1;
    }

    /* Outer and inner doughnut container */
    .doughnut-container {
      position: relative;
      width: 100%;
      height: 100%;
      border-radius: 50%;
    }

    /* Outer doughnut (the "ring" around the center) */
    .outer-doughnut {
      position: absolute;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      z-index: 1;
    }

    /* Inner doughnut (the smaller ring inside) */
    .inner-doughnut {
      position: absolute;
      width: 80%;   /* Inner doughnut is smaller */
      height: 80%;
      border-radius: 50%;
      z-index: 2;
    }

    .circle:hover {
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.3);
      transform: scale(1.05);
    }

    /* Kanban status colors */
    .kanban-R { background-color: #1abc9c; }
    .kanban-P { background-color: #e67e22; }
    .kanban-L { background-color: #9b59b6; }
    .kanban-C { background-color: #e74c3c; }
    .kanban-T { background-color: #f1c40f; color: #333; }
  </style>
</head>
<body>
<div id="log-timeline" style="margin-top: 20px;"></div>
<div class="kanban-board" id="kanbanBoard">
<div id="customLegend" class="kanban-legend"></div>
<!-- Add a container for the axis -->
</div>


<script>
const tagColorMap = {
L1: '#3498db',
L2: '#9b59b6',
L3: '#2ecc71',
M1: '#e67e22',
M2: '#e74c3c',
M3: '#f1c40f',
M4: '#1abc9c',
M5: '#34495e',
R0: '#95a5a6',
R1: '#16a085',
R2: '#2980b9'
};

function stringToColor(tag) {
return tagColorMap[tag] || '#777'; // fallback gray
}



  function scaleSize(count, min = 50, max = 180) {
  const maxCount = 100; // adjust based on your expected upper limit
  const normalized = Math.min(count, maxCount) / maxCount;
  return min + (max - min) * normalized;
  }


  document.addEventListener("DOMContentLoaded", () => {
    const walkTagCounts = {{ walk_tag_counts|tojson }};
    const tagLabels = {{ tag_labels|tojson | default('{}') }};
    console.log("tagLabels =", tagLabels);
    const kanbanOptions = {{ kanban_options|tojson }};
    const groupedWalks = {{ grouped_walks|tojson }};
    const updateUrl = "{{ url_for('update_walk_kanban') }}";
    const board = document.getElementById('kanbanBoard');


      // ... your Kanban and chart creation code ...

      // === LEGEND CREATION ===
      const legendContainer = document.getElementById("customLegend");
      legendContainer.innerHTML = "<h4>Tag Legend</h4>";

      const legendList = document.createElement("div");
      legendContainer.appendChild(legendList);

      const uniqueTags = Object.keys(tagLabels);
      console.log("Legend Tags:", uniqueTags);

      uniqueTags.sort(); // optional

      uniqueTags.forEach(tag => {
        const color = stringToColor(tag);
        const label = tagLabels[tag];
        console.log(`Tag: ${tag}, Label: ${label}, Color: ${color}`);
        const item = document.createElement("div");
        item.className = "legend-item";

        item.innerHTML = `
          <div class="legend-color" style="background-color: ${color};"></div>
          <span><strong>${tag}</strong>: ${label}</span>
        `;

        legendList.appendChild(item);
      });


    // Build Kanban columns
    kanbanOptions.forEach(({ code, label }) => {
      const column = document.createElement('div');
      column.className = 'kanban-column';
      column.innerHTML = `
        <div class="kanban-header">${label}</div>
        <div class="circle-container" id="container-${code}"></div>
      `;
      board.appendChild(column);

      const container = column.querySelector(`#container-${code}`);
      Sortable.create(container, {
        group: 'shared',
        animation: 150,
        onEnd: async (evt) => {
          const movedEl = evt.item;
          const newKanban = evt.to.id.replace('container-', '');
          const walkName = movedEl.dataset.walkName;

          const res = await fetch(updateUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ walk_name: walkName, kanban: newKanban })
          });

          if (!res.ok) {
            alert("Failed to update server.");
          } else {
            movedEl.className = 'circle';
            movedEl.classList.add(`kanban-${newKanban}`);
          }
        }
      });
    });
    console.log("Grouped Walks:", groupedWalks.map(w => w.Kanban));
    console.log("Kanban Option Codes:", kanbanOptions.map(o => o.code));
    // Create and place circles with doughnut charts
    groupedWalks.forEach(group => {
      const walkName = group.WalkName;
      const kanbanKey = group.Kanban || 'U';
      const container = document.getElementById(`container-${kanbanKey}`);
      if (!container) return;

      const wrapper = document.createElement('div');
      wrapper.className = 'circle';
      wrapper.dataset.walkName = walkName;
      wrapper.classList.add(`kanban-${kanbanKey}`);
      wrapper.style.position = 'relative';
      wrapper.style.width = '130px';
      wrapper.style.height = '130px';
      wrapper.style.padding = '5px';
//      wrapper.style.backgroundColor = 'white';

      const enop = parseFloat(group.ENOP) || 0;


      // === Base Inputs and Outputs ===
      const baseInputs = [
        parseInt(group.VI_Canvassed) || 0
      ];
      const baseOutputs = [
        parseInt(group.VI_Pledged) || 0,
        parseInt(group.VI_ToGet_Pos) || 0
      ];
      const inputColors = ['#3498db', '#2ecc71']; // e.g. blue, green
      const outputColors = ['#000000', '#9b59b6', '#f1c40f'];


      // === Combine and Build Datasets ===
      const tagCounts = walkTagCounts[walkName] || {};;
      const baseInputLabels = ['Canvassed'];
      const baseOutputLabels = ['Pledged','ToGet_Pos'];
      const dynamicInputLabels = [];
      const dynamicOutputLabels = [];
      const dynamicInputs = [];
      const dynamicInputColors = [];
      const dynamicOutputs = [];
      const dynamicOutputColors = [];

      const outputTagCount = Object.entries(tagCounts)
      .filter(([tag]) => tag.startsWith('M'))
      .reduce((sum, [, count]) => sum + count, 0);


      Object.entries(tagCounts).forEach(([tag, count]) => {

        const label = tagLabels[tag] || tag;
        const color = stringToColor(tag);

        if (tag.startsWith('L')) {
          dynamicInputs.push(count);
          dynamicInputColors.push(color);
          dynamicInputLabels.push(label);
        }

        if (tag.startsWith('M')) {
          dynamicOutputs.push(count);
          dynamicOutputColors.push(color);
          dynamicOutputLabels.push(label);

        }
      });
      const radius = scaleSize(outputTagCount); // e.g., 80–180px

      wrapper.style.width = `${radius}px`;
      wrapper.style.height = `${radius}px`;

      const label = document.createElement('div');
      label.textContent = walkName;
      label.style.position = 'absolute';
      label.style.top = '-1.2em';
      label.style.left = '50%';
      label.style.transform = 'translateX(-50%)';
      label.style.fontSize = '12px';
      label.style.color = '#333';
      label.style.fontWeight = 'bold';

      const canvas = document.createElement('canvas');
      canvas.width = radius;
      canvas.height = radius;


      wrapper.title = `Output tag count: ${outputTagCount}`;
      wrapper.appendChild(label);
      wrapper.appendChild(canvas);
      container.appendChild(wrapper);




      label.className = 'circle-label';

      new Chart(canvas.getContext('2d'), {
  type: 'doughnut',
  data: {
    datasets: [
      {
        label: '',
        data: [...baseInputs, ...dynamicInputs],
        backgroundColor: [...inputColors, ...dynamicInputColors],
        labels: [...baseInputLabels, ...dynamicInputLabels],
        borderWidth: 1,
        radius: '95%',  // outer ring, 45% of canvas radius
        cutout: '0%' // size of the hole
      },
      {
        label: '',
        data: [...baseOutputs, ...dynamicOutputs],
        backgroundColor: [...outputColors, ...dynamicOutputColors],
        labels: [...baseOutputLabels, ...dynamicOutputLabels],
        borderWidth: 1,
        radius: '95%',  // outer ring, 45% of canvas radius
        cutout: '0%' // size of the hole
      }

    ]
  },
  options: {
    responsive: false,
    plugins: {
      legend: { display: false },
      tooltip: {
        bodyFont: {
          size: 10  // Smaller font size for tooltip body
        },
        titleFont: {
          size: 11  // Smaller font size for tooltip title (optional)
        },
        callbacks: {
          label: function (context) {
            const index = context.dataIndex;
            const dataset = context.dataset;
            const label = dataset.labels?.[index] || 'Unknown';
            return `${label}: ${context.parsed}`;
          }
        }
      }

    }
  }
});
});
});

</script>

</body>

<script>
  const today = new Date();
  const electionDate = window.parent.electiondate;

  const maxDays = 36;  // days before election
  const width = document.getElementById("kanbanBoard").offsetWidth;
  const height = 70;
  const margin = { left: 40, right: 40 };

  const svg = d3.select("#log-timeline")
    .append("svg")
    .attr("width", width)
    .attr("height", height);

  // Logarithmic scale (increasing leftward): domain from 1 to 35 (log scale can't start at 0)
  const xScale = d3.scaleLog()
    .domain([1, maxDays])
    .range([width - margin.right, margin.left]);  // 1 = right (election), 35 = left

  // Custom ticks in log-like spacing
  const tickValues = [1, 2, 3, 5, 7, 10, 14, 20, 28, 35];

  const xAxis = d3.axisBottom(xScale)
    .tickValues(tickValues)
    .tickFormat(d => `${d-1}`)  // so 35 → 0
    .tickSizeOuter(0);

  // Draw the axis
  svg.append("g")
    .attr("transform", `translate(0, ${height - 30})`)
    .call(xAxis)
    .selectAll("text")
    .attr("dy", "-1.2em")
    .style("font-size", "14px")
    .style("font-weight", "bold");

  // Axis label
  svg.append("text")
    .attr("x", width / 2)
    .attr("y", height - 5)
    .attr("text-anchor", "middle")
    .style("font-size", "16px")
    .style("font-weight", "bold")
    .text("Days to Election (log scale)");

  // Vertical line: Today (35 days before election)
  svg.append("line")
    .attr("x1", xScale(maxDays))
    .attr("x2", xScale(maxDays))
    .attr("y1", 0)
    .attr("y2", height)
    .attr("stroke", "#333")
    .attr("stroke-dasharray", "4,2");

  // Vertical line: Election Day (0)
  svg.append("line")
    .attr("x1", xScale(1))
    .attr("x2", xScale(1))
    .attr("y1", 0)
    .attr("y2", height)
    .attr("stroke", "red")
    .attr("stroke-dasharray", "4,2");
</script>



</html>
