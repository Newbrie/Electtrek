{% extends "base.html" %}
{% block map %}
<div id="mapwin" class="innertube">
    <iframe id="iframe1" src= {{ url_for('thru',path=mapfile) }} width="1200" height="800" onload="refreshTableData('nodelist_xref')"> </iframe>
    <!-- Login Screen -->
    <div id="loginScreen">
        <h2>Login</h2>
        <input type="password" id="password" placeholder="Enter password" class="form-control mb-2">
        <button id="loginBtn" type="button" class="btn btn-primary mb-2">Login</button>
        <div id="loginMessage"></div>
    </div>

    <!-- Calendar Container -->
    <div id="calendar">
        <div class="container-fluid">
            <h2 class="text-center mb-4">{{ current_election }} Campaigns Calendar</h2>

            <div id="calendar-controls" class="mb-3">
                <button id="save-calendar-btn" class="btn btn-primary">üíæ Save Calendar</button>
                <button id="generate-summary-btn" class="btn btn-secondary">üìã Generate Table</button>
                <button id="export-html-btn" class="btn btn-info">üîê Export HTML</button>
            </div>

            <div id="calendar-grid" class="calendar-grid mt-4"></div>

            <!-- Modal (unchanged) -->
            <div class="modal fade" id="slotModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Edit Slot</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="slotForm">
                                <div class="mb-2">
                                    <label>Activity</label>
                                    <select id="activitySelect" class="form-select"></select>
                                </div>
                                <div class="mb-2">
                                    <label>Resources</label>
                                    <select id="resourcesSelect" class="form-select" multiple></select>
                                </div>
                                <div class="mb-2">
                                    <label>Place</label>
                                    <select id="placeSelect" class="form-select"></select>
                                </div>
                                <div class="mb-2">
                                    <label>Area</label>
                                    <select id="areaSelect" class="form-select" multiple></select>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button class="btn btn-danger" id="clearSlotBtn">Clear Slot</button>
                            <button class="btn btn-primary" id="saveSlotBtn">Save</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="summary-report" class="mt-4"></div>
        </div>
    </div>
</div>
<style>
  /* Container to align label and switch */
  .toggle-container {
    display: flex;
    align-items: center;
    gap: 12px; /* space between label and switch */
    font-family: sans-serif;
    margin: 10px 0;
  }

  .toggle-label {
    font-size: 16px;
    color: #333;
  }

  /* Switch styling */
  .switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 28px;
  }

  .switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }

  .slider {
    position: absolute;
    cursor: pointer;
    top: 0; left: 0;
    right: 0; bottom: 0;
    background-color: #ccc;
    transition: 0.4s;
    border-radius: 28px;
  }

  .slider:before {
    position: absolute;
    content: "";
    height: 22px;
    width: 22px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: 0.4s;
    border-radius: 50%;
  }

  input:checked + .slider {
    background-color: #4CAF50;
  }

  input:checked + .slider:before {
    transform: translateX(22px);
  }

  body {
      font-family: sans-serif;
      margin: 20px;
  }

  /* Calendar container initially hidden */
  #calendar {
      display: none;
  }

  /* Login screen */
  #loginScreen {
      display: block;
      max-width: 400px;
      margin: 100px auto;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 6px;
      background-color: #f9f9f9;
      text-align: center;
  }


  /* add to your CSS */
  #loginScreen.fade-out {
      opacity: 0;
      transition: opacity 0.3s ease;
  }

    #loginMessage {
      transition: opacity 0.5s ease-in-out;
      opacity: 0; /* start hidden */
    }
    #loginMessage.show {
      opacity: 1; /* fade in */
    }

  /* Calendar styles (unchanged) */
  .calendar-grid { margin-top: 100px; }
  .slot { position: relative; height: 90px; width: 100%; border: 1px solid #ddd; border-radius: 4px; background-color: #fafafa; box-sizing: border-box; padding: 1px 6px; overflow: hidden; font-size: 0.85em; line-height: 1.2em; }
  .slot-time { font-size: 0.75em; font-weight: 600; color: #666; margin-right: 0.4em; vertical-align: baseline; }
  .slot-content { display: inline; word-break: break-word; }
  .slot small { color: #555; display: block; }
  .slot-label { position: absolute; top: 2px; left: 4px; font-size: 0.75em; color: #666; pointer-events: none; z-index: 2; background: rgba(255,255,255,0.85); border-radius: 3px; padding: 0 4px; white-space: nowrap; --label-width: calc(100% + 8px); }
  .slot::before { content:""; display:block; width:calc(var(--label-width,3em)+6px); height:0; flex:0 0 auto; }
  .slot .lozenge { margin:0; padding:0 4px; font-size:0.8em; line-height:1em; display:inline-block; border-radius:4px; white-space:nowrap; opacity:1; }
  .slot .lozenge[data-type="activity"] { background: rgba(204,229,255,0.9); }
  .slot .lozenge[data-type="resource"] { background: rgba(212,237,218,0.9); }
  .slot .lozenge[data-type="place"] { background: rgba(255,243,205,0.9); }
  .slot .lozenge[data-type="area"] { background: rgba(248,215,218,0.9); }
  .election-highlight { border: 2px double red !important; box-sizing: border-box; }
  .today-highlight { border: 2px double blue !important; box-sizing: border-box; }

<script >
  // Listen to message from child window
  const pessages = [];
  var pack = JSON.parse('{{ get_flashed_messages()|tojson|safe }}');

  for (let x in pack) {
  pessages.push(pack[x]);
  };

  var iframeEl = document.getElementById('iframe1');

  function bindEvent( element, eventName, eventHandler) {
   if (element.addEventListener){
       element.addEventListener(eventName, eventHandler, false);
   } else if (element.attachEvent) {
       element.attachEvent('on' + eventName, eventHandler);
   };
  };

  bindEvent( window, 'message', function (e) {
    pessages.pop();
    pessages.push(e.data);
    var logWindow = document.getElementById("logwin");
    var li = document.createElement("li");
    li.appendChild(document.createTextNode(e.data));
    logWindow.appendChild(li);
    logWindow.scrollTop = logWindow.scrollHeight;
      });

</script>
<script src="https://https://newbrie.github.io/Electtrek/static/resourcing.js"></script>

{% endblock map %}

{% block log %}

<div id="logwin" class="innertube">
  <h3>elecTrek flash messages: </h3>
  {% with messages = get_flashed_messages() %}
  {% if messages %}
    <ul class="flashes">
      {% for message in messages %}
        <li>{{ message }}</li>
      {% endfor %}
    </ul>
  {% endif %}
{% endwith %}
		<h3>elecTrek status messages: </h3>
      <ul class="flashes" >
      {% for pessage in pessages %}
        <li> {{ pessage  }}</li>
      {% endfor %}
      </ul>

</div>
{% endblock log %}


{% block nav %}
<div id="nav" >
  <h3>Election Dashboard</h3>
  <ul class="centred" >user: {{ session['username'] }}</ul>
  <ul class="nav nav-tabs" id="election-tabs">
    {% for election_name in ELECTIONS %}
      <li class="nav-item position-relative tab-item">
        <button class="nav-link election-tab {% if election_name == current_election %}active{% endif %}"
                data-election="{{ election_name }}"
                onclick="selectElection('{{ election_name }}')">
          {{ election_name }}
        </button>
        <span class="delete-tab-btn"
              data-election="{{ election_name }}"
              onclick="deleteElection('{{ election_name }}')">√ó</span>
      </li>
    {% endfor %}
    <li class="nav-item">
      <button class="nav-link" id="add-election-tab" style="font-weight: bold;" onclick="addElection()">ÔºãNEW</button>
    </li>
  </ul>


      <div id="constants-container">
      <ul>
        <li class="righted">
          <select class="righted"name="streams" id="streams" ></select><br>
      </li>
      <li class="righted">
        Type of Election: <select class="righted"name="territories" id="territories"></select><br>
      </li>
      <li class="righted">
        Territory: <input class="righted" type="text" name="territory" id="territory" readonly><br>
      </li>
      <li class="righted">
      Party selected: <select class="righted" name="yourparty" id="yourparty"></select><br>
      </li>
      <li class="righted">
      Walk Size: <input class="righted" type="number" min="100" max="500" step="50" name="walksize" id="walksize" /><br>
      </li>
      <li class="righted">
      Team Size: <input class="righted" type="number" min="1" max="25" step="1" name="teamsize" id="teamsize" /><br>
      </li>
      <li class="righted">
      GOTV: <input class="righted" type="number" id="GOTV" name="GOTV" min="0.01" max="0.99" step="0.01"  />
      </li>
      <li class="righted">
        <div class="toggle-container">
          <span class="toggle-label">Accumulate: </span>
          <label class="switch">
            <input type="checkbox" id="accumulate" name="accumulate" onchange="handleToggle(this)">
            <span class="slider"></span>
          </label>
        </div>
      </li>
      <li class="righted">
      Bookmarks: <select class="righted" name="mapfiles" id="mapfiles" ></select><br>
      </li>
      <li class="righted">
        <label id="resources-toggle" style="cursor: pointer;">Resources ‚¨á</label>
        <div id="resources-container" style="display: none; position: absolute; background: white; border: 1px solid #ccc; padding: 5px;">
          <select name="resources" id="resources" multiple size="5"></select>
        </div>
      </li>
      <li class="righted" >
      Candidate: <select class="righted" name="candidate" id="candidate" ></select><br>
        </li>
      <li class="righted" >
      Campaign Mgr: <select class="righted" name="campaignMgr" id="campaignMgr" ></select><br>
      </li>
      <li class="righted" >
      Email: <input class="righted" name="campaignMgremail" id="campaignMgremail" readonly></input><br>
      </li>
      <li class="righted" >
      Mobile: <select class="righted" name="mobile" id="mobile" ></select><br>
      </li>
      <li class="righted" >
      Prev.Party: <select class="righted" name="previousParty" id="previousParty" disabled></select><br>
      </li>
      <li class="righted">
          Date of election:
          <input
          class="righted"
          type="date"
          id="electiondate"
          name="electiondate"
          />
      </li>
      </ul>
</div>
        <div class = "grid-container">
          <div class="grid-item">
          <button type="button" id="update-territory-btn" class="small_btn">BOOKMARK<br>TERRITORY</button>
          </div>
            <div class="grid-item">
              <button type = "button" id = "b1" class = "small_btn" onclick="setActionForm('filelist',filelist='maps')">Boundary<br>Maps</button>
            </div>
            <div class="grid-item">
              <button type = "button" id = "b2" class = "small_btn" onclick="window.open('/election-report', '_blank')">ELECTIONS<br>REPORT</button>
            </div>
            <div class="grid-item">
              <button type="button" id="b3" class="small_btn" >ELECTORAL<br>REGISTERS</button>
            </div>
            <div class="grid-item">
              <button type = "button" id = "b4" class = "small_btn">ACTIVITY<br>DELIVERY</button>
            </div>
            <div class="grid-item">
              <button type = "button" id = "b5" class = "small_btn">CAMPAIGN PROGRESS</button>
            </div>
            <div class="grid-item">
              <button type = "button" id = "b9" class = "small_btn">CALENDAR</button>
            </div>
            <div class="grid-item">
              <button type = "button" id = "b6" class = "small_btn">VOTER<br>TELLING</button>
            </div>
            <div class="grid-item">
              <button type = "button" id = "b7" class = "small_btn" >ELECTOR<br>SEARCH</button>
            </div>
            <div class="grid-item">
              <button type = "button" id = "b8" class = "small_btn" >BROWSE<br>TERRITORY</button>
            </div>
            <div class="grid-item">
              <button type = "button" id = "logout-button" class = "small_btn" >LOGOUT</button>
            </div>

          </div>
    <div id="chartContainer" style="width: 300px; height: 300px; position: relative;">
      <canvas id="streamChart"></canvas>
    </div>
  </div>
{% endblock nav %}
{% block captains %}

<div id="tabletitle" class="innertube">
  <span id="selectedTitle">Table Details</span>
  <select id="tableSelector">
    {% for key, value in table_types.items() %}
    <option value="{{ key }}">{{ value }}</option>
  {% endfor %}
  </select>
</div>

<div id="datawin" class="innertube">
  <div style="overflow-x: auto; width: 100%; height: 100%;">
    <table id="captains-table" style="width: 100%; table-layout: fixed;">
      <thead></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

<script>


function fetchTableData(tableName) {
  const VCO = {
    O: "brown", R: "cyan", C: "blue", S: "red",
    LD: "yellow", G: "limegreen", I: "indigo",
    PC: "darkred", SD: "orange", Z: "lightgray",
    W: "white", X: "darkgray"
  };

  const table = document.getElementById("captains-table");
  const tabtitle = document.getElementById("selectedTitle");
  const tabletitle = document.getElementById("tabletitle");

  if (!table || !tabtitle) {
    console.error("‚ùå Required DOM elements not found: #captains-table or #selectedTitle");
    return;
  }

  const tabhead = table.querySelector("thead");
  const tabbody = table.querySelector("tbody");

  if (!tabhead || !tabbody) {
    console.error("‚ùå Table structure invalid: missing <thead> or <tbody>");
    return;
  }

  console.log(`üì• Fetching data for table: ${tableName}`);

  fetch(`/get_table/${tableName}`, {
    method: "GET",
    headers: { "Content-Type": "application/json" },
    credentials: "same-origin"
  })
  .then(response => {
    if (!response.ok) throw new Error(`Server returned ${response.status}`);
    return response.json();
  })
  .then(data => {
    if (!Array.isArray(data) || data.length < 3) {
      console.error("‚ùå Invalid data format received:", data);
      return;
    }

    const [columnHeaders, rows, title] = data;

    // Clear and set title
    tabtitle.textContent = title;
    tabhead.innerHTML = "";
    tabbody.innerHTML = "";

    // Create table head
    const headRow = document.createElement("tr");
    const checkboxHeader = document.createElement("th");
    checkboxHeader.textContent = "?";
    headRow.appendChild(checkboxHeader);

    columnHeaders.forEach(header => {
      const th = document.createElement("th");
      th.textContent = header.toUpperCase();
      headRow.appendChild(th);
    });
    tabhead.appendChild(headRow);

    // Try to get the current party selector if it exists
    const yourpartyEl = document.getElementById("yourparty");
    const selectedParty = yourpartyEl ? yourpartyEl.value : null;

    rows.forEach(record => {
      const row = document.createElement("tr");

      // Add checkbox cell
      const checkboxCell = document.createElement("td");
      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.name = "selectRow[]";
      checkbox.classList.add("selectRow");
      checkboxCell.appendChild(checkbox);
      row.appendChild(checkboxCell);

      columnHeaders.forEach(header => {
        const cell = document.createElement("td");
        const value = record[header] !== undefined ? record[header] : "";

        cell.innerHTML = value;

        // Highlight cell based on party
        if (selectedParty && header === selectedParty) {
          const color = VCO[selectedParty] || "inherit";
          cell.style.backgroundColor = color;
        }

        row.appendChild(cell);
      });

      tabbody.appendChild(row);
    });

    console.log(`‚úÖ Table "${tableName}" populated with ${rows.length} rows.`);
  })
  .catch(error => {
    console.error("‚ùå Error fetching table data:", error);
  });
}


  function handleToggle(el) {
    if (el.checked) {
      console.log("Switch is ON");
    } else {
      console.log("Switch is OFF");
    }
  }


  function changeIframeSrc(newurl) {
    var msg = "Retrieving area "+newurl;
    var logWindow = document.getElementById("logwin");
    var li = document.createElement("li");
    li.appendChild(document.createTextNode(msg));
    logWindow.appendChild(li);
    logWindow.scrollTop = logWindow.scrollHeight;
    document.getElementById("iframe1").src = newurl;
      };

  function toUpperCase(str) {
    return str.replace(
      /\w\S*/g,
      text => text.charAt(0).toUpperCase() + text.substring(1).toUpperCase()
    );
  };


  window.addEventListener("message", function(event) {
    // optionally check event.origin === "https://yourdomain.com"
    if (event.data.type === "update-table") {
        const stable = document.getElementById(event.data.stable);
        if (stable) {
          console.log("Received message to updateTable: " + event.data.stable);
            fetchTableData(stable);
        }
    }
});

function subending(filename, ending) {
  const endings = [
    ".XLSX", ".xlsx", ".CSV", ".csv",
    "-PRINT.html", "-MAP.html", "-WALKS.html",
    "-ZONES.html", "-PDS.html", "-DIVS.html", "-WARDS.html"
  ];

  let stem = filename;

  for (const suffix of endings) {
    if (filename.endsWith(suffix)) {
      stem = filename.slice(0, -suffix.length);
      break;
    }
  }

  const result = stem + ending;
  console.log(`____Subending test: from ${filename} to ${result}`);
  return result;
}

function createOrUpdateChart(labels, data, rags) {
  const ragColors = {
    red: 'rgba(255, 99, 132, 0.9)',
    amber: 'rgba(255, 159, 64, 0.9)',
    limegreen: 'rgba(50, 205, 50, 0.9)'
  };

  const backgroundColors = rags.map(rag => ragColors[rag]);

  // Get canvas element safely in case this is triggered late
  const canvas = document.getElementById('streamChart');
  if (!canvas) {
    console.error('streamChart canvas not found.');
    return;
  }

  const ctx = canvas.getContext('2d');

  if (streamChart) {
    // Update existing chart
    streamChart.data.labels = labels;
    streamChart.data.datasets[0].data = data;
    streamChart.data.datasets[0].backgroundColor = backgroundColors;
    streamChart.update();
  } else {
    // First-time chart creation
    Chart.register(ChartDataLabels); // Only needed once
    streamChart = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: labels,
        datasets: [{
          label: 'Electors in Stream',
          data: data,
          backgroundColor: backgroundColors,
          borderColor: '#fff',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          title: {
            display: true,
            text: 'Stream Loading Status'
          },
          datalabels: {
            color: '#000',
            font: { size: 14, weight: 'bold' },
            formatter: (value) => value.toLocaleString()
          }
        }
      },
      plugins: [ChartDataLabels]
    });
  }
};

function updateChart(newLabels, newData, newRags) {
  const ragColors = {
    red: 'rgba(255, 99, 132, 0.2)',
    amber: 'rgba(255, 159, 64, 0.2)',
    green: 'rgba(75, 192, 192, 0.2)'
  };

  if (!streamChart) {
    console.warn("Chart not initialized.");
    return;
  }

  streamChart.data.labels = newLabels;
  streamChart.data.datasets[0].data = newData;
  streamChart.data.datasets[0].backgroundColor = newRags.map(rag => ragColors[rag] || 'gray');

  streamChart.update();
};

async function fetchAndUpdateChart() {
try {
  const response = await fetch('/streamrag_api');
  const receiveddata = await response.json();
  const streamrag = receiveddata.streamrag
  const html = receiveddata.html

  const labels = Object.keys(streamrag);
  const data = labels.map(label => streamrag[label].Elect);
  const rags = labels.map(label => streamrag[label].RAG);

  createOrUpdateChart(labels, data, rags);
} catch (error) {
  console.error('Failed to fetch streamrag data:', error);
}
};

// Attach listeners to constant fields dynamically
function attachListenersToConstantFields(constants) {
Object.keys(constants).forEach(key => {
  const el = document.getElementById(key);
  if (!el) return;

  const listener = () => refreshConstantsUI();
  el.removeEventListener("change", listener);
  el.removeEventListener("input", listener);

  if (el.tagName === "SELECT" && el.multiple) {
    el.addEventListener("blur", listener);
  } else {
    el.addEventListener("change", listener);
    el.addEventListener("input", listener);
  }
});
}


function updateConstantsUI(constants, options) {
  console.log(`Update to constants: ${Object.keys(constants)} : ${Object.entries(options)}`);
  Object.entries(constants).forEach(([key, value]) => {
    const el = document.getElementById(key);
    if (!el) return;

    const optsObj = options[key] || {};
    el.innerHTML = ""; // Clear current options
    if (options[key] && typeof options[key] === 'object') {
        console.log(`Update to constant: ${key} ${constants[key]} :`, Object.entries(options[key]));
      } else {
        console.log(`Update to constant: ${key} ${constants[key]} : (no options available)`);
      }

    if (el.tagName === "SELECT") {

      if (key === "resources") {
        // Multi-select for resources
        Object.entries(options.resources || {}).forEach(([code, person]) => {
          const option = document.createElement("option");
          option.value = code;
          option.textContent = `${person.Firstname} ${person.Surname}`;
          if (Array.isArray(value) && value.includes(code)) {
            option.selected = true;
          }
          el.appendChild(option);
        });

      } else if (key === "candidate" || key === "campaignMgr") {
        // Candidate/compaignMgr filtered by selected resources
        const selectedResources = Array.isArray(constants.resources) ? constants.resources : [];
        selectedResources.forEach(code => {
          const person = options.resources?.[code];
          if (person) {
            const option = document.createElement("option");
            const email = document.getElementById("campaignMgremail");
            option.value = code;
            option.textContent = `${person.Firstname} ${person.Surname}`;
            if (value === code) { option.selected = true;
               email.value = `${person.campaignMgremail}`;
             };
            el.appendChild(option);
          }
        });

      } else if (key === "mapfiles") {
        // ‚úî Correct mapfiles handling
        if (Array.isArray(value)) {
          value.forEach((mapPath, index) => {
            const o = document.createElement("option");
            o.value = mapPath;
            o.textContent = `Map ${index + 1}: ${mapPath.split("/").pop()}`;
            if (index === value.length - 1) {
              o.selected = true;
            }
            el.appendChild(o);
          });
        }

        // Add listener to change iframe when user selects
        el.onchange = () => {
          const selectedMap = el.value;
          console.log("üó∫Ô∏è Selected map:", selectedMap);
          if (selectedMap) {
            changeIframeSrc(`/thru/${selectedMap}`);
          }
        };

      } else if (key === "streams") {
        // Do nothing as streams is populated elsewhere
      }
       else {
        // Generic SELECT fields C: Conservative , W:Westminster etc
        Object.entries(optsObj).forEach(([optValue, optLabel]) => {
          const o = document.createElement("option");
          o.value = optValue;
          o.textContent = `${optValue}: ${optLabel}`;
          if (optValue === value) o.selected = true;
          el.appendChild(o);
        });
      }
    } else {
      // Non-SELECT elements
      el.value = value;
    }

    // General input handler (select, input, etc.)
    el.oninput = () => {
      let newVal = el.value;
      if (el.type === "number") newVal = parseFloat(newVal);
      if (el.type === "checkbox") newVal = el.checked;
      if (el.multiple) newVal = Array.from(el.selectedOptions).map(opt => opt.value);

      fetch("/set-constant", {
        method: "POST",
        credentials: 'same-origin',
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          election: document.querySelector(".election-tab.active")?.dataset.election || "",
          name: key,
          value: newVal
        })
      })
      .then(res => res.json())
      .then(resp => {
        if (resp.success) {
//            fetchTableData('nodelist_xref');
        } else {
          alert("Failed to update: " + resp.error);
        }
      });
    };
  });
  attachListenersToConstantFields(constants);
}


  function selectElection(electionName) {
  console.log("Selecting election:", electionName);

  // Remove 'active' from all tabs
  document.querySelectorAll(".election-tab").forEach(tab => {
    tab.classList.remove("active");
  });

  // Add 'active' to the clicked tab
  const clickedTab = Array.from(document.querySelectorAll(".election-tab"))
    .find(tab => tab.dataset.election === electionName);

  if (clickedTab) {
    clickedTab.classList.add("active");
    clickedTab.classList.add("nav-link", "active");
    console.log("Tab activated for election:", electionName);
  } else {
    console.warn("No tab found for election:", electionName);
  }

  // Proceed with backend election switch
  fetch("/set-election", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    credentials: "same-origin",
    body: JSON.stringify({ election: electionName })
  })
  .then(res => {
    console.log("Fetch response status:", res.status, res.statusText);
    return res.text(); // use text first to debug invalid JSON
  })
  .then(text => {
    console.log("Raw response text:", text);
    let data;
    try {
      data = JSON.parse(text);
      console.log("Parsed JSON response:", data);
    } catch (e) {
      console.error("JSON parse failed:", e);
      console.log("Response text causing parse error:", text);
      return; // stop here if parse fails
    }

    if (!data || !data.constants) {
      console.warn("Missing constants in response:", data);
      return;
    }

    // Update constants UI
    console.log("Updating constants UI with:", data.constants);
    updateConstantsUI(data.constants, data.options);

    // Extract mapfile
    const mapfile = data.constants.territory;
    if (mapfile) {
      console.log("Changing iframe source to mapfile:", mapfile);
      changeIframeSrc(`/thru/${mapfile}`);
    } else {
      console.warn("No territory/mapfile found in constants:", data.constants);
    }

    // Refresh table data
    console.log("Fetching table data for 'nodelist_xref'");
    fetchTableData('nodelist_xref');
  })
  .catch(err => {
    console.error("Fetch failed:", err);
  });
}




  function syncStreamsSelectWithTabs() {
      const tabs = document.querySelectorAll('.election-tab');
      const streamsSelect = document.getElementById('streams');

      // Clear existing options
      streamsSelect.innerHTML = '';

      // Add each tab as an option
      tabs.forEach(tab => {
          const election = tab.dataset.election;
          const option = document.createElement('option');
          option.value = election;
          option.textContent = `Election ${election}`;
          streamsSelect.appendChild(option);
      });

      // Set the selected option to match the active tab
      const activeTab = document.querySelector('.election-tab.active');
      if (activeTab) {
          streamsSelect.value = activeTab.dataset.election;
      }
  }


  function deleteElection(electionName) {
    if (!confirm(`Delete "${electionName}"? This cannot be undone.`)) return;

    fetch("/delete-election", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "same-origin",
      body: JSON.stringify({ election: electionName })
    })
    .then(res => res.json())
    .then(resp => {
      if (resp.success && resp.electiontabs_html) {
        document.getElementById("election-tabs").innerHTML = resp.electiontabs_html;
        fetchTableData('nodelist_xref');
        syncStreamsSelectWithTabs();
        // ‚úÖ All onclick bindings are preserved because they come from server-rendered HTML
      } else {
        alert("Could not delete election: " + (resp.error || "Unknown error"));
      }
    });
  }

  function addElection() {
    const newName = prompt("Enter name for new election:");
    if (!newName) return;

    fetch("/add-election", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "same-origin",
      body: JSON.stringify({ election: newName })
    })
    .then(res => res.json())
    .then(resp => {
      if (resp.success && resp.electiontabs_html) {
        document.getElementById("election-tabs").innerHTML = resp.electiontabs_html;
        syncStreamsSelectWithTabs();
        updateConstantsUI(resp.constants, resp.options);
        fetchTableData('nodelist_xref');
        // ‚úÖ Onclick handlers already embedded

      } else {
        alert("Error adding election: " + resp.error);
      }
    });
  }


  document.addEventListener("DOMContentLoaded", () => {

    window.refreshTableData = function(id) {
    console.log("Refreshing table for", id);
    window.parent.postMessage({
    type: "update-table",
    stable: selectedTable
    }, "*"); // Replace * with specific origin if needed
}

    const tableSelector = document.getElementById("tableSelector");
    const toggle = document.getElementById("resources-toggle");
    const container = document.getElementById("resources-container");
    const tabContainer = document.getElementById("election-tabs");

    // Helper functions
    const getActiveElectionTab = () => document.querySelector(".election-tab.active");
    const changeIframe = (url) => changeIframeSrc(url);

    const refreshConstantsUI = (callback) => {
      fetch("/get-constants", { credentials: "same-origin" })
        .then(res => res.json())
        .then(data => {
          updateConstantsUI(data.constants, data.options);
          if (callback) callback(data);
        });
    };

    // Fetch table on selection
    if (tableSelector) {
      tableSelector.addEventListener("change", e => {
        const selectedTable = e.target.value;
        fetchTableData(selectedTable);
        console.log("selectedTable:", selectedTable);
      });
    }

    // Generic button-to-iframe mapping
    const iframeButtons = {
      b3: "{{ url_for('stream_input') }}",
      b4: "{{ url_for('leafletting') }}",
      b5: "{{ url_for('kanban') }}",
      b6: "{{ url_for('telling') }}",
      b7: "{{ url_for('search') }}",
      b8: "{{ url_for('dashboard') }}",
      b9: "{{ url_for('calendar') }}"
    };

    Object.entries(iframeButtons).forEach(([id, url]) => {
      const btn = document.getElementById(id);
      if (btn) btn.addEventListener("click", () => changeIframe(url));
    });

    // Logout button
    document.getElementById("logout-button")?.addEventListener("click", () => {
      window.location.href = "/logout";
    });

    // Resource toggle
    toggle?.addEventListener("click", () => {
      const isVisible = container.style.display === "block";
      container.style.display = isVisible ? "none" : "block";
      toggle.textContent = isVisible ? "Resources ‚¨á" : "Resources ‚¨Ü";
    });

    // Initial fetch for constants
    fetch("/get-constants", { credentials: 'same-origin' })
      .then(res => res.json())
      .then(data => {
        updateConstantsUI(data.constants, data.options);
        const mapfile = data.constants?.mapfiles?.slice(-1)[0];
        if (mapfile) changeIframe(`/thru/${mapfile}`);
      });

    // Set election for active tab on load
    const activeTab = getActiveElectionTab();
    if (activeTab) {
      fetch("/set-election", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "same-origin",
        body: JSON.stringify({ election: activeTab.dataset.election })
      })
      .then(res => res.text()) // get raw text first
      .then(text => {
        console.log("Raw /set-election response:", text);
        let resp;
        try {
          resp = JSON.parse(text); // try parse JSON
        } catch (e) {
          console.error("JSON parse failed:", e);
          return; // stop here if invalid JSON
        }

        if (resp.success) {
          refreshConstantsUI(data => {
            const mapfile = data.constants?.mapfiles?.slice(-1)[0];
            if (mapfile) changeIframe(`/thru/${mapfile}`);
          });
        } else {
          console.warn("/set-election returned success=false:", resp);
        }
      })
      .catch(err => console.error("Fetch error:", err));
    }


    // Sync dropdowns with tabs
    syncStreamsSelectWithTabs();

    // Update territory
    document.getElementById("update-territory-btn")?.addEventListener("click", () => {
      const activeTab = getActiveElectionTab();
      if (!activeTab) return alert("No election selected.");

      fetch("/update-territory", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "same-origin",
        body: JSON.stringify({ election: activeTab.dataset.election })
      })
      .then(res => res.json())
      .then(resp => {
        if (resp.success) {
          refreshConstantsUI(data => {
            const mapfile = data.constants?.territory;
            if (mapfile) changeIframe(`/thru/${mapfile}`);
            fetchTableData('nodelist_xref');
          });
        }
      });
    });

    // Election tab click delegation
    document.addEventListener('click', e => {
      if (!e.target.classList.contains('election-tab')) return;
      document.querySelectorAll('.election-tab').forEach(tab => tab.classList.remove('active'));
      e.target.classList.add('active');
      syncStreamsSelectWithTabs();
    });

    // Resources select blur/update
    document.getElementById('resources')?.addEventListener('blur', () => {
      const el = document.getElementById('resources');
      const selected = Array.from(el.selectedOptions).map(opt => opt.value);
      const activeTab = getActiveElectionTab();
      if (!activeTab) return;

      fetch("/set-constant", {
        method: "POST",
        credentials: 'same-origin',
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ election: activeTab.dataset.election, name: "resources", value: selected })
      })
      .then(res => res.json())
      .then(resp => {
        if (resp.success) refreshConstantsUI();
        else alert("Failed to update resources: " + resp.error);
      });
    });



    // Parent dropdown reassignment
    document.addEventListener('change', e => {
      const select = e.target;
      if (!select.classList.contains('parent-dropdown')) return;

      const subject = select.dataset.subject;
      const oldParent = select.dataset.oldValue;
      const newParent = select.value;

      if (!subject) return console.error("‚ö† Missing subject for parent reassignment");

      fetch('/reassign_parent', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ subject, old_parent: oldParent, new_parent: newParent })
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === 'success') {
          console.log("‚úÖ Reassignment complete:", data.message);
          window.location.href = data.mapfile;
        } else {
          console.error("‚ùå Reassignment failed:", data.message);
        }
      })
      .catch(err => console.error("‚ùå Network/server error:", err));
    });

    // Update constants UI and dependent selects
    function updateConstantsUI(constants, options) {
      if (!constants || !options) return;

      Object.keys(constants).forEach(key => {
        const el = document.getElementById(key);
        if (!el) return;

        if (el.tagName === "SELECT") {
          if (el.multiple && Array.isArray(constants[key])) {
            Array.from(el.options).forEach(opt => opt.selected = constants[key].includes(opt.value));
          } else {
            el.value = constants[key];
          }
        } else if ("value" in el) {
          el.value = constants[key];
        }
      });

      ["candidate", "campaignMgr"].forEach(key => {
        const el = document.getElementById(key);
        if (!el) return;

        el.innerHTML = "";
        const selectedResources = Array.isArray(constants.resources) ? constants.resources : [];
        selectedResources.forEach(code => {
          const person = options.resources?.[code];
          if (!person) return;

          const option = document.createElement("option");
          option.value = code;
          option.textContent = `${person.Firstname ?? "?"} ${person.Surname ?? "?"}`.trim();
          if (constants[key] === code) option.selected = true;

          el.appendChild(option);
        });

        if (!el.options.length) {
          const placeholder = document.createElement("option");
          placeholder.value = "";
          placeholder.textContent = "No available options";
          el.appendChild(placeholder);
        }
      });
    }
  });


</script>


{% endblock captains %}
