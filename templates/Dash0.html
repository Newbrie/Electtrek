{% extends "base.html" %}
{% block map %}
<style>
  /* Container to align label and switch */
  .toggle-container {
    display: flex;
    align-items: center;
    gap: 12px; /* space between label and switch */
    font-family: sans-serif;
    margin: 10px 0;
  }

  .toggle-label {
    font-size: 16px;
    color: #333;
  }

  /* Switch styling */
  .switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 28px;
  }

  .switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }

  .slider {
    position: absolute;
    cursor: pointer;
    top: 0; left: 0;
    right: 0; bottom: 0;
    background-color: #ccc;
    transition: 0.4s;
    border-radius: 28px;
  }

  .slider:before {
    position: absolute;
    content: "";
    height: 22px;
    width: 22px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: 0.4s;
    border-radius: 50%;
  }

  input:checked + .slider {
    background-color: #4CAF50;
  }

  input:checked + .slider:before {
    transform: translateX(22px);
  }

  body {
      font-family: sans-serif;
      margin: 20px;
  }

    /* Keep iframe visible and in normal flow when map shown */
    #iframe1 {
        visibility: hidden;
        position: relative;
        z-index: 1;
    }

    /* Calendar hidden by default but stays in document flow */
    #calendar {
        visibility: hidden;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        z-index: 2;
    }

    /* Login screen on top of everything initially */
    #loginScreen {
        visibility: visible;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        background: white;
        padding: 20px;
        z-index: 3;
    }

    /* add to your CSS */
    #loginScreen.fade-out {
        opacity: 0;
        transition: opacity 0.3s ease;
    }

      #loginMessage {
        transition: opacity 0.5s ease-in-out;
        opacity: 0; /* start hidden */
      }
      #loginMessage.show {
        opacity: 1; /* fade in */
      }

  /* Calendar styles (unchanged) */
  .calendar-grid { margin-top: 100px; }
  .slot { position: relative; height: 90px; width: 100%; border: 1px solid #ddd; border-radius: 4px; background-color: #fafafa; box-sizing: border-box; padding: 1px 6px; overflow: hidden; font-size: 0.85em; line-height: 1.2em; }
  .slot-time { font-size: 0.75em; font-weight: 600; color: #666; margin-right: 0.4em; vertical-align: baseline; }
  .slot-content { display: inline; word-break: break-word; }
  .slot small { color: #555; display: block; }
  .slot-label { position: absolute; top: 2px; left: 4px; font-size: 0.75em; color: #666; pointer-events: none; z-index: 2; background: rgba(255,255,255,0.85); border-radius: 3px; padding: 0 4px; white-space: nowrap; --label-width: calc(100% + 8px); }
  .slot::before { content:""; display:block; width:calc(var(--label-width,3em)+6px); height:0; flex:0 0 auto; }
  .slot .lozenge { margin:0; padding:0 4px; font-size:0.8em; line-height:1em; display:inline-block; border-radius:4px; white-space:nowrap; opacity:1; }
  .slot .lozenge[data-type="activity"] { background: rgba(204,229,255,0.9); }
  .slot .lozenge[data-type="resource"] { background: rgba(212,237,218,0.9); }
  .slot .lozenge[data-type="place"] { background: rgba(255,243,205,0.9); }
  .slot .lozenge[data-type="area"] { background: rgba(248,215,218,0.9); }
  .election-highlight { border: 2px double red !important; box-sizing: border-box; }
  .today-highlight { border: 2px double blue !important; box-sizing: border-box; }
</style>
<script>

  // üß± Safe variable injection
  window.task_tags = {{ task_tags | default([]) | tojson }};
  window.resources = {{ resources | default([]) | tojson }};
  window.places = {{ places | default([]) | tojson }};
  window.areas = {{ areas | default([]) | tojson }};

  console.log("Injected task_tags:", window.task_tags);
  console.log("Injected resources:", window.resources);
  console.log("Injected places:", window.places);
  console.log("Injected areas:", window.areas);

  const DEVURLS = {{ DEVURLS | tojson }} ;
  const isDev = location.hostname.includes("localhost") || location.hostname.startsWith("127.");
  const API = isDev ? DEVURLS["dev"] : "__REPLACE_WITH_API_URL__";

  if (!isDev) {
      const btn = document.getElementById("export-html-btn");
      if (btn) {
          btn.style.display = "none";
      }
  }
  const calendarData = {};
  const startHour = 9, endHour = 21, slotDuration = 2;


  /* ---------------------------------------------------------
   * UPDATE CONSTANTS FORM UI
   * --------------------------------------------------------- */
  window.updateConstantsUI = function (constants, options) {
      if (!constants) return;

      // populate basic fields
      for (const key of Object.keys(constants)) {
          const el = document.getElementById(key);
          if (!el) continue;

          if (el.tagName === "SELECT") {
              if (el.multiple && Array.isArray(constants[key])) {
                  Array.from(el.options).forEach(opt =>
                      opt.selected = constants[key].includes(opt.value)
                  );
              } else {
                  el.value = constants[key];
              }
          }
      }

      // populate special selects
      ["candidate", "campaignMgr"].forEach(key => {
          const el = document.getElementById(key);
          if (!el) return;

          el.innerHTML = "";
          const resources = constants.resources || [];

          resources.forEach(code => {
              const person = options?.resources?.[code];
              if (!person) return;

              const opt = document.createElement("option");
              opt.value = code;
              opt.textContent = `${person.Firstname} ${person.Surname}`;
              if (constants[key] === code) opt.selected = true;

              el.appendChild(opt);
          });
      });
  }


  // ----------------------------
  // Iframe & Toggle
  // ----------------------------
  window.changeIframeSrc = function(url) {
    const logWindow = document.getElementById("logwin");
    const li = document.createElement("li");
    li.textContent = `Retrieving area ${url}`;
    logWindow.appendChild(li);
    logWindow.scrollTop = logWindow.scrollHeight;

    iframeEl.src = url;
  }

  window.selectElection = function(electionName) {
  console.log("Selecting election:", electionName);

  // Remove 'active' from all tabs
  document.querySelectorAll(".election-tab").forEach(tab => {
    tab.classList.remove("active");
  });

  // Add 'active' to the clicked tab
  const clickedTab = Array.from(document.querySelectorAll(".election-tab"))
    .find(tab => tab.dataset.election === electionName);

  if (clickedTab) {
    clickedTab.classList.add("active");
    clickedTab.classList.add("nav-link", "active");
    console.log("Tab activated for election:", electionName);
  } else {
    console.warn("No tab found for election:", electionName);
  }

  // Proceed with backend election switch
  fetch("/set-election", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    credentials: "same-origin",
    body: JSON.stringify({ election: electionName })
  })
  .then(res => {
    console.log("Fetch response status:", res.status, res.statusText);
    return res.text(); // use text first to debug invalid JSON
  })
  .then(text => {
    console.log("Raw response text:", text);
    let data;
    try {
      data = JSON.parse(text);
      console.log("Parsed JSON response:", data);
    } catch (e) {
      console.error("JSON parse failed:", e);
      console.log("Response text causing parse error:", text);
      return; // stop here if parse fails
    }

    if (!data || !data.constants) {
      console.warn("Missing constants in response:", data);
      return;
    }

    // Update constants UI
    console.log("Updating constants UI with:", data.constants);
    updateConstantsUI(data.constants, data.options);

    // Extract mapfile
    const mapfile = data.constants.territory;
    if (mapfile) {
      console.log("Changing iframe source to mapfile:", mapfile);
      changeIframeSrc(`/thru/${mapfile}`);
    } else {
      console.warn("No territory/mapfile found in constants:", data.constants);
    }

    // Refresh table data
    console.log("Fetching table data for 'nodelist_xref'");
    fetchTableData('nodelist_xref');
  })
  .catch(err => {
    console.error("Fetch failed:", err);
  });
}

</script>
<div id="mapwin" class="innertube">
    <iframe id="iframe1" src= {{ url_for('thru',path=mapfile) }} width="1200" height="800" > </iframe>
    <!-- Login Screen -->
    <div id="loginScreen">
        <h2>Login</h2>
        <input type="password" id="password" placeholder="Enter password" class="form-control mb-2">
        <button id="loginBtn" type="button" class="btn btn-primary mb-2">Login</button>
        <div id="loginMessage"></div>
    </div>

    <!-- Calendar Container -->
    <div id="calendar">
        <div class="container-fluid">
            <h2 class="text-center mb-4">{{ current_election }} Campaigns Calendar</h2>

            <div id="calendar-controls" class="mb-3">
                <button id="save-calendar-btn" class="btn btn-primary">üíæ Save Calendar</button>
                <button id="generate-summary-btn" class="btn btn-secondary">üìã Generate Table</button>
                <button id="export-html-btn" class="btn btn-info">üîê Export HTML</button>
            </div>

            <div id="calendar-grid" class="calendar-grid mt-4"></div>

            <!-- Modal (unchanged) -->
            <div class="modal fade" id="slotModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Edit Slot</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="slotForm">
                                <div class="mb-2">
                                    <label>Activity</label>
                                    <select id="activitySelect" class="form-select"></select>
                                </div>
                                <div class="mb-2">
                                    <label>Resources</label>
                                    <select id="resourcesSelect" class="form-select" multiple></select>
                                </div>
                                <div class="mb-2">
                                    <label>Place</label>
                                    <select id="placeSelect" class="form-select"></select>
                                </div>
                                <div class="mb-2">
                                    <label>Area</label>
                                    <select id="areaSelect" class="form-select" multiple></select>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button class="btn btn-danger" id="clearSlotBtn">Clear Slot</button>
                            <button class="btn btn-primary" id="saveSlotBtn">Save</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="summary-report" class="mt-4"></div>
        </div>
    </div>
</div>

{% endblock map %}

{% block log %}

<div id="logwin" class="innertube">
  <h3>elecTrek flash messages: </h3>
  {% with messages = get_flashed_messages() %}
  {% if messages %}
    <ul class="flashes">
      {% for message in messages %}
        <li>{{ message }}</li>
      {% endfor %}
    </ul>
  {% endif %}
{% endwith %}
		<h3>elecTrek status messages: </h3>
      <ul class="flashes" >
      {% for pessage in pessages %}
        <li> {{ pessage  }}</li>
      {% endfor %}
      </ul>

</div>
{% endblock log %}


{% block nav %}
<div id="nav" >
  <h3>Election Dashboard</h3>
  <ul class="centred" >user: {{ session['username'] }}</ul>
  <ul class="nav nav-tabs" id="election-tabs">
    {% for election_name in ELECTIONS %}
      <li class="nav-item position-relative tab-item">
        <button class="nav-link election-tab {% if election_name == current_election %}active{% endif %}"
                data-election="{{ election_name }}"
                onclick="selectElection('{{ election_name }}')">
          {{ election_name }}
        </button>
        <span class="delete-tab-btn"
              data-election="{{ election_name }}"
              onclick="deleteElection('{{ election_name }}')">√ó</span>
      </li>
    {% endfor %}
    <li class="nav-item">
      <button class="nav-link" id="add-election-tab" style="font-weight: bold;" onclick="addElection()">ÔºãNEW</button>
    </li>
  </ul>


      <div id="constants-container">
      <ul>
        <li class="righted">
          <select class="righted"name="streams" id="streams" ></select><br>
      </li>
      <li class="righted">
        Type of Election: <select class="righted"name="territories" id="territories"></select><br>
      </li>
      <li class="righted">
        Territory: <input class="righted" type="text" name="territory" id="territory" readonly><br>
      </li>
      <li class="righted">
      Party selected: <select class="righted" name="yourparty" id="yourparty"></select><br>
      </li>
      <li class="righted">
      Walk Size: <input class="righted" type="number" min="100" max="500" step="50" name="walksize" id="walksize" /><br>
      </li>
      <li class="righted">
      Team Size: <input class="righted" type="number" min="1" max="25" step="1" name="teamsize" id="teamsize" /><br>
      </li>
      <li class="righted">
      GOTV: <input class="righted" type="number" id="GOTV" name="GOTV" min="0.01" max="0.99" step="0.01"  />
      </li>
      <li class="righted">
        <div class="toggle-container">
          <span class="toggle-label">Accumulate: </span>
          <label class="switch">
            <input type="checkbox" id="accumulate" name="accumulate" onchange="handleToggle(this)">
            <span class="slider"></span>
          </label>
        </div>
      </li>
      <li class="righted">
      Bookmarks: <select class="righted" name="mapfiles" id="mapfiles" ></select><br>
      </li>
      <li class="righted">
        <label id="resources-toggle" style="cursor: pointer;">Resources ‚¨á</label>
        <div id="resources-container" style="display: none; position: absolute; background: white; border: 1px solid #ccc; padding: 5px;">
          <select name="resources" id="resources" multiple size="5"></select>
        </div>
      </li>
      <li class="righted" >
      Candidate: <select class="righted" name="candidate" id="candidate" ></select><br>
        </li>
      <li class="righted" >
      Campaign Mgr: <select class="righted" name="campaignMgr" id="campaignMgr" ></select><br>
      </li>
      <li class="righted" >
      Email: <input class="righted" name="campaignMgremail" id="campaignMgremail" readonly></input><br>
      </li>
      <li class="righted" >
      Mobile: <select class="righted" name="mobile" id="mobile" ></select><br>
      </li>
      <li class="righted" >
      Prev.Party: <select class="righted" name="previousParty" id="previousParty" disabled></select><br>
      </li>
      <li class="righted">
          Date of election:
          <input
          class="righted"
          type="date"
          id="electiondate"
          name="electiondate"
          />
      </li>
      </ul>
</div>
        <div class = "grid-container">
          <div class="grid-item">
          <button type="button" id="update-territory-btn" class="small_btn">BOOKMARK<br>TERRITORY</button>
          </div>
            <div class="grid-item">
              <button type = "button" id = "b1" class = "small_btn" onclick="setActionForm('filelist',filelist='maps')">Boundary<br>Maps</button>
            </div>
            <div class="grid-item">
              <button type = "button" id = "b2" class = "small_btn" onclick="window.open('/election-report', '_blank')">ELECTIONS<br>REPORT</button>
            </div>
            <div class="grid-item">
              <button type="button" id="b3" class="small_btn" >ELECTORAL<br>REGISTERS</button>
            </div>
            <div class="grid-item">
              <button type = "button" id = "b4" class = "small_btn">ACTIVITY<br>DELIVERY</button>
            </div>
            <div class="grid-item">
              <button type = "button" id = "b5" class = "small_btn">CAMPAIGN PROGRESS</button>
            </div>
            <div class="grid-item">
              <button type = "button" id = "b9" class = "small_btn">CALENDAR</button>
            </div>
            <div class="grid-item">
              <button type = "button" id = "b6" class = "small_btn">VOTER<br>TELLING</button>
            </div>
            <div class="grid-item">
              <button type = "button" id = "b7" class = "small_btn" >ELECTOR<br>SEARCH</button>
            </div>
            <div class="grid-item">
              <button type = "button" id = "b8" class = "small_btn" >BROWSE<br>TERRITORY</button>
            </div>
            <div class="grid-item">
              <button type = "button" id = "logout-button" class = "small_btn" >LOGOUT</button>
            </div>

          </div>
    <div id="chartContainer" style="width: 300px; height: 300px; position: relative;">
      <canvas id="streamChart"></canvas>
    </div>
  </div>
{% endblock nav %}
{% block captains %}

<div id="tabletitle" class="innertube">
  <span id="selectedTitle">Table Details</span>
  <select id="tableSelector">
    {% for key, value in table_types.items() %}
    <option value="{{ key }}">{{ value }}</option>
  {% endfor %}
  </select>
</div>

<div id="datawin" class="innertube">
  <div style="overflow-x: auto; width: 100%; height: 100%;">
    <table id="captains-table" style="width: 100%; table-layout: fixed;">
      <thead></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<script >
  // ----------------------------
  // Message Handling
  // ----------------------------
  const messages = JSON.parse('{{ get_flashed_messages()|tojson|safe }}') || [];
  const iframeEl = document.getElementById('iframe1');

  function bindEvent(element, eventName, eventHandler) {
    element.addEventListener(eventName, eventHandler, false);
  }

  bindEvent(window, 'message', (e) => {
    messages.pop();
    messages.push(e.data);

    const logWindow = document.getElementById("logwin");
    const li = document.createElement("li");
    li.textContent = e.data;
    logWindow.appendChild(li);
    logWindow.scrollTop = logWindow.scrollHeight;
  });

  // ----------------------------
  // Table Fetching
  // ----------------------------
  const PARTY_COLORS = {
    O: "brown", R: "cyan", C: "blue", S: "red",
    LD: "yellow", G: "limegreen", I: "indigo",
    PC: "darkred", SD: "orange", Z: "lightgray",
    W: "white", X: "darkgray"
  };

  async function fetchTableData(tableName) {
    const table = document.getElementById("captains-table");
    const tabTitle = document.getElementById("selectedTitle");

    if (!table || !tabTitle) {
      console.error("‚ùå Required DOM elements not found: #captains-table or #selectedTitle");
      return;
    }

    const tabHead = table.querySelector("thead");
    const tabBody = table.querySelector("tbody");

    if (!tabHead || !tabBody) {
      console.error("‚ùå Table structure invalid: missing <thead> or <tbody>");
      return;
    }

    console.log(`üì• Fetching data for table: ${tableName}`);

    try {
      const res = await fetch(`/get_table/${tableName}`, { credentials: "same-origin" });
      if (!res.ok) throw new Error(`Server returned ${res.status}`);
      const data = await res.json();

      if (!Array.isArray(data) || data.length < 3) {
        console.error("‚ùå Invalid data format received:", data);
        return;
      }

      const [columnHeaders, rows, title] = data;
      tabTitle.textContent = title;
      tabHead.innerHTML = "";
      tabBody.innerHTML = "";

      // Table header
      const headRow = document.createElement("tr");
      headRow.innerHTML = `<th>?</th>` + columnHeaders.map(h => `<th>${h.toUpperCase()}</th>`).join('');
      tabHead.appendChild(headRow);

      const selectedParty = document.getElementById("yourparty")?.value;

      // Table body
      rows.forEach(record => {
        const row = document.createElement("tr");
        row.innerHTML = `<td><input type="checkbox" class="selectRow" name="selectRow[]"></td>` +
          columnHeaders.map(h => {
            const value = record[h] ?? "";
            const color = (selectedParty && h === selectedParty) ? (PARTY_COLORS[selectedParty] || 'inherit') : '';
            return `<td style="background-color:${color}">${value}</td>`;
          }).join('');
        tabBody.appendChild(row);
      });

      console.log(`‚úÖ Table "${tableName}" populated with ${rows.length} rows.`);
    } catch (err) {
      console.error("‚ùå Error fetching table data:", err);
    }
  }


  function handleToggle(el) {
    console.log(`Switch is ${el.checked ? 'ON' : 'OFF'}`);
  }

  // ----------------------------
  // String Utilities
  // ----------------------------
  function toUpperCase(str) {
    return str.replace(/\w\S*/g, txt => txt.charAt(0).toUpperCase() + txt.slice(1).toUpperCase());
  }

  function subending(filename, ending) {
    const endings = [".XLSX", ".xlsx", ".CSV", ".csv", "-PRINT.html", "-MAP.html", "-WALKS.html", "-ZONES.html", "-PDS.html", "-DIVS.html", "-WARDS.html"];
    let stem = filename;

    for (const suffix of endings) if (filename.endsWith(suffix)) { stem = filename.slice(0, -suffix.length); break; }

    const result = stem + ending;
    console.log(`____Subending test: from ${filename} to ${result}`);
    return result;
  }

  // ----------------------------
  // Chart Utilities
  // ----------------------------
  function createOrUpdateChart(labels, data, rags) {
    const ragColors = { red: 'rgba(255,99,132,0.9)', amber: 'rgba(255,159,64,0.9)', limegreen: 'rgba(50,205,50,0.9)' };
    const backgroundColors = rags.map(rag => ragColors[rag]);

    const canvas = document.getElementById('streamChart');
    if (!canvas) return console.error('streamChart canvas not found.');

    const ctx = canvas.getContext('2d');

    if (window.streamChart) {
      window.streamChart.data.labels = labels;
      window.streamChart.data.datasets[0].data = data;
      window.streamChart.data.datasets[0].backgroundColor = backgroundColors;
      window.streamChart.update();
    } else {
      Chart.register(ChartDataLabels);
      window.streamChart = new Chart(ctx, {
        type: 'doughnut',
        data: { labels, datasets: [{ label: 'Electors in Stream', data, backgroundColor: backgroundColors, borderColor: '#fff', borderWidth: 1 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, title: { display: true, text: 'Stream Loading Status' }, datalabels: { color: '#000', font: { size: 14, weight: 'bold' }, formatter: val => val.toLocaleString() } } },
        plugins: [ChartDataLabels]
      });
    }
  }

  async function fetchAndUpdateChart() {
    try {
      const { streamrag } = await (await fetch('/streamrag_api')).json();
      const labels = Object.keys(streamrag);
      const data = labels.map(l => streamrag[l].Elect);
      const rags = labels.map(l => streamrag[l].RAG);
      createOrUpdateChart(labels, data, rags);
    } catch (err) {
      console.error('Failed to fetch streamrag data:', err);
    }
  }

  // ----------------------------
  // Constants UI
  // ----------------------------
  function attachListenersToConstantFields(constants) {
    Object.keys(constants).forEach(key => {
      const el = document.getElementById(key);
      if (!el) return;

      const listener = () => refreshConstantsUI();
      el.removeEventListener("change", listener);
      el.removeEventListener("input", listener);

      if (el.tagName === "SELECT" && el.multiple) el.addEventListener("blur", listener);
      else { el.addEventListener("change", listener); el.addEventListener("input", listener); }
    });
  }

  function updateConstantsUI(constants, options) {
    Object.entries(constants).forEach(([key, value]) => {
      const el = document.getElementById(key);
      if (!el) return;
      const optsObj = options[key] || {};
      el.innerHTML = "";

      if (el.tagName === "SELECT") {
        // Multi-select for resources
        if (key === "resources") {
          Object.entries(options.resources || {}).forEach(([code, person]) => {
            const option = document.createElement("option");
            option.value = code;
            option.textContent = `${person.Firstname} ${person.Surname}`;
            if (Array.isArray(value) && value.includes(code)) option.selected = true;
            el.appendChild(option);
          });
        } else if (key === "candidate" || key === "campaignMgr") {
          const selectedResources = Array.isArray(constants.resources) ? constants.resources : [];
          selectedResources.forEach(code => {
            const person = options.resources?.[code];
            if (!person) return;
            const option = document.createElement("option");
            option.value = code;
            option.textContent = `${person.Firstname} ${person.Surname}`;
            if (value === code) { option.selected = true; document.getElementById("campaignMgremail").value = person.campaignMgremail; }
            el.appendChild(option);
          });
        } else if (key === "mapfiles") {
          if (Array.isArray(value)) {
            value.forEach((mapPath, idx) => {
              const o = document.createElement("option");
              o.value = mapPath;
              o.textContent = `Map ${idx+1}: ${mapPath.split("/").pop()}`;
              if (idx === value.length-1) o.selected = true;
              el.appendChild(o);
            });
          }
          el.onchange = () => changeIframeSrc(`/thru/${el.value}`);
        } else {
          Object.entries(optsObj).forEach(([optValue, optLabel]) => {
            const o = document.createElement("option");
            o.value = optValue;
            o.textContent = `${optValue}: ${optLabel}`;
            if (optValue === value) o.selected = true;
            el.appendChild(o);
          });
        }
      } else el.value = value;

      // Auto-update backend on input/change
      el.oninput = () => {
        let newVal = el.type === "number" ? parseFloat(el.value) : el.type === "checkbox" ? el.checked : el.value;
        if (el.multiple) newVal = Array.from(el.selectedOptions).map(o => o.value);

        fetch("/set-constant", {
          method: "POST",
          credentials: 'same-origin',
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ election: document.querySelector(".election-tab.active")?.dataset.election || "", name: key, value: newVal })
        }).then(res => res.json()).then(resp => {
          if (!resp.success) alert("Failed to update: " + resp.error);
        });
      };
    });
    attachListenersToConstantFields(constants);
  }

  // ----------------------------
  // Election Management
  // ----------------------------
  function syncStreamsSelectWithTabs() {
    const streamsSelect = document.getElementById('streams');
    streamsSelect.innerHTML = '';
    document.querySelectorAll('.election-tab').forEach(tab => {
      const opt = document.createElement('option');
      opt.value = tab.dataset.election;
      opt.textContent = `Election ${tab.dataset.election}`;
      streamsSelect.appendChild(opt);
    });
    streamsSelect.value = document.querySelector('.election-tab.active')?.dataset.election || '';
  }

  window.deleteElection = async function(electionName) {
    if (!confirm(`Delete "${electionName}"? This cannot be undone.`)) return;
    const res = await fetch("/delete-election", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "same-origin",
      body: JSON.stringify({ election: electionName })
    });
    const resp = await res.json();
    if (resp.success && resp.electiontabs_html) {
      document.getElementById("election-tabs").innerHTML = resp.electiontabs_html;
      fetchTableData('nodelist_xref');
      syncStreamsSelectWithTabs();
    } else alert("Could not delete election: " + (resp.error || "Unknown error"));
  }

  window.addElection = async function() {
    const newName = prompt("Enter name for new election:");
    if (!newName) return;
    const res = await fetch("/add-election", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "same-origin",
      body: JSON.stringify({ election: newName })
    });
    const resp = await res.json();
    if (resp.success && resp.electiontabs_html) {
      document.getElementById("election-tabs").innerHTML = resp.electiontabs_html;
      syncStreamsSelectWithTabs();
      updateConstantsUI(resp.constants, resp.options);
      fetchTableData('nodelist_xref');
    } else alert("Error adding election: " + resp.error);
  }

  // ----------------------------
  // Message Listener for Table Updates
  // ----------------------------
  window.addEventListener("message", (event) => {
    if (event.data.type === "update-table") fetchTableData(event.data.stable);
  });


    document.addEventListener("DOMContentLoaded", async () => {

      /* ---------------------------------------------------------
       * expose refreshTableData so iframe can call the parent
       * --------------------------------------------------------- */
      window.refreshTableData = function(id) {
          console.log("Refreshing table for", id);
          window.parent.postMessage(
              { type: "update-table", stable: "nodelist_xref" },
              "*"
          );
      }
      /* ---------------------------------------------------------
       * expose refreshTableData so iframe can call the parent
       * --------------------------------------------------------- */

      async function getCalendarUpdate () {
              try {
                const response = await fetch(`${API}/current-election`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const data = await response.json();
                console.log("üì¶ Raw backend response:", data);

                // Handle possible nested structures
                const plan = data.calendar_plan || data;
                console.log("üìã Parsed plan object:", plan);

                if (plan?.slots) {
                  loadCalendarPlan(plan);
                  console.log("‚úÖ Calendar plan loaded into UI");
                } else {
                  console.warn("‚ö†Ô∏è No slots found in backend data");
                }
              } catch (error) {
                console.error("üö® Error fetching calendar plan:", error);
              }
            };
      /* ---------------------------------------------------------
   * CALENDAR LOGIN AND CALENDAR BUILD
   * --------------------------------------------------------- */

  // elements
  const iframe = document.getElementById("iframe1");
  const calendar = document.getElementById("calendar");
  const loginScreen = document.getElementById("loginScreen");
  const loginBtn = document.getElementById("loginBtn");
  const passwordInput = document.getElementById("password");
  const loginMessage = document.getElementById("loginMessage");

  // Initial state ‚Äî hide map + calendar, show login
  iframe.style.visibility = "hidden";
  calendar.style.visibility = "hidden";
  loginScreen.style.visibility = "visible";

  // ENTER triggers login
  passwordInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
          e.preventDefault();
          loginBtn.click();
      }
  });

  loginBtn.addEventListener("click", async () => {

      loginMessage.textContent = "";
      const password = passwordInput.value;

      try {
          const res = await fetch("/api/", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ password })
          });

          const data = await res.json();

          if (data.success) {
              loginMessage.textContent = "Access granted";

              setTimeout(() => {
                  loginScreen.style.visibility = "hidden";
                  calendar.style.visibility = "visible";
              }, 300);
          } else {
              loginMessage.textContent = "Wrong password!";
          }

      } catch (err) {
          console.error(err);
          loginMessage.textContent = "Login failed";
      }
  });

  /* ---------------------------------------------------------
   * CALENDAR <-> MAP TOGGLE
   * --------------------------------------------------------- */

  const toggleBtn = document.getElementById("b9");

  toggleBtn.addEventListener("click", async () => {

      // Do nothing if login screen still visible
      if (loginScreen.style.visibility === "visible") return;

      // Toggle from calendar ‚Üí map
      if (calendar.style.visibility === "visible") {
          calendar.style.visibility = "hidden";
          calendar.style.position = "absolute";   // remove from layout so iframe is fully visible
          iframe.style.visibility = "visible";
          toggleBtn.textContent = "üìÖ View Calendar";
      }

      // Toggle from map ‚Üí calendar
      else {
          iframe.style.visibility = "hidden";
          calendar.style.position = "static";
          calendar.style.visibility = "visible";

          // Load calendar only once
          if (!calendar.dataset.loaded) {
              await getCalendarUpdate();
              calendar.dataset.loaded = "true";
          }

          toggleBtn.textContent = "üó∫Ô∏è View Map";
      }
  });


      /* ---------------------------------------------------------
       * GENERAL ELEMENTS
       * --------------------------------------------------------- */
      const tableSelector = document.getElementById("tableSelector");
      const resourcesToggle = document.getElementById("resources-toggle");
      const resourcesContainer = document.getElementById("resources-container");

      const electionTabs = document.querySelectorAll(".election-tab");

      const getActiveElectionTab = () =>
          document.querySelector(".election-tab.active");

      const changeIframe = (url) => changeIframeSrc(url);


      /* ---------------------------------------------------------
       * FETCH CONSTANTS + UPDATE UI
       * --------------------------------------------------------- */
      function refreshConstantsUI(callback) {
          fetch("/get-constants", { credentials: "same-origin" })
              .then(res => res.json())
              .then(data => {
                  updateConstantsUI(data.constants, data.options);
                  if (callback) callback(data);
              });
      }


      /* ---------------------------------------------------------
       * TABLE SELECTOR
       * --------------------------------------------------------- */
      if (tableSelector) {
          tableSelector.addEventListener("change", (e) => {
              fetchTableData(e.target.value);
          });
      }


      /* ---------------------------------------------------------
       * BUTTON ‚Üí IFRAME ROUTING
       * --------------------------------------------------------- */
      const iframeButtons = {
          b3: "{{ url_for('stream_input') }}",
          b4: "{{ url_for('leafletting') }}",
          b5: "{{ url_for('kanban') }}",
          b6: "{{ url_for('telling') }}",
          b7: "{{ url_for('search') }}",
          b8: "{{ url_for('dashboard') }}"
      };

      for (const [id, url] of Object.entries(iframeButtons)) {
          const btn = document.getElementById(id);
          if (btn) btn.addEventListener("click", () => changeIframe(url));
      }


      /* ---------------------------------------------------------
       * LOGOUT
       * --------------------------------------------------------- */
      document.getElementById("logout-button")?.addEventListener("click", () => {
          window.location.href = "/logout";
      });


      /* ---------------------------------------------------------
       * RESOURCES TOGGLE
       * --------------------------------------------------------- */
      resourcesToggle?.addEventListener("click", () => {
          const visible = resourcesContainer.style.display === "block";
          resourcesContainer.style.display = visible ? "none" : "block";
          resourcesToggle.textContent = visible ? "Resources ‚¨á" : "Resources ‚¨Ü";
      });


      /* ---------------------------------------------------------
       * INITIAL CONSTANTS + LOAD MAP
       * --------------------------------------------------------- */
      fetch("/get-constants", { credentials: "same-origin" })
          .then(res => res.json())
          .then(data => {
              updateConstantsUI(data.constants, data.options);

              const latestMap = data.constants?.mapfiles?.slice(-1)[0];
              if (latestMap) changeIframe(`/thru/${latestMap}`);
          });


      /* ---------------------------------------------------------
       * SET ACTIVE ELECTION ON LOAD
       * --------------------------------------------------------- */
      const activeTab = getActiveElectionTab();

      if (activeTab) {
          fetch("/set-election", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              credentials: "same-origin",
              body: JSON.stringify({ election: activeTab.dataset.election })
          })
              .then(r => r.text())
              .then(txt => {
                  let resp;
                  try { resp = JSON.parse(txt); }
                  catch { return console.error("Bad JSON:", txt); }

                  if (resp.success) {
                      refreshConstantsUI(data => {
                          const latest = data.constants?.mapfiles?.slice(-1)[0];
                          if (latest) changeIframe(`/thru/${latest}`);
                      });
                  }
              });
      }


      /* ---------------------------------------------------------
       * TAB CLICK HANDLER
       * --------------------------------------------------------- */
      document.addEventListener("click", (e) => {
          if (!e.target.classList.contains("election-tab")) return;

          electionTabs.forEach(t => t.classList.remove("active"));
          e.target.classList.add("active");

          syncStreamsSelectWithTabs();
      });


      /* ---------------------------------------------------------
       * RESOURCES UPDATE
       * --------------------------------------------------------- */
      const resourcesSelect = document.getElementById("resources");

      resourcesSelect?.addEventListener("blur", () => {
          const selected = Array.from(resourcesSelect.selectedOptions).map(o => o.value);
          const tab = getActiveElectionTab();
          if (!tab) return;

          fetch("/set-constant", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              credentials: "same-origin",
              body: JSON.stringify({
                  election: tab.dataset.election,
                  name: "resources",
                  value: selected
              })
          })
              .then(res => res.json())
              .then(resp => {
                  if (resp.success) refreshConstantsUI();
              });
      });


      /* ---------------------------------------------------------
       * PARENT-DROPDOWN REASSIGNMENT
       * --------------------------------------------------------- */
      document.addEventListener("change", (e) => {
          if (!e.target.classList.contains("parent-dropdown")) return;

          const select = e.target;
          const subject = select.dataset.subject;

          fetch("/reassign_parent", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                  subject,
                  old_parent: select.dataset.oldValue,
                  new_parent: select.value
              })
          })
              .then(r => r.json())
              .then(data => {
                  if (data.status === "success") {
                      window.location.href = data.mapfile;
                  }
              });
      });



        console.log("üìÖ Building calendar‚Ä¶");

        // Build the grid and load data
        buildCalendarGrid("calendar-grid", 45);
        populateDropdowns();
        await getCalendarUpdate();
        console.log("‚úÖ Calendar initialized.");

        // Buttons (use correct IDs)
        const saveCalendarBtn = document.getElementById("save-calendar-btn"); // ‚úÖ matches HTML ID
        const generateSummaryBtn = document.getElementById("generate-summary-btn");
        const saveSlotBtn = document.getElementById("saveSlotBtn");
        const clearSlotBtn = document.getElementById("clearSlotBtn");

        // Attach button event handlers
        saveCalendarBtn.addEventListener("click", saveCalendarPlan);
        generateSummaryBtn.addEventListener("click", generateSummaryReport);
        saveSlotBtn.addEventListener("click", handleSaveSlot);
        clearSlotBtn.addEventListener("click", handleClearSlot);

  });



</script>
<script src="https://newbrie.github.io/Electtrek/static/resourcing.js"></script>


{% endblock captains %}
