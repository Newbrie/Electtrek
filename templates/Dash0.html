{% extends "base.html" %}
{% block map %}
<style>
  /* Container to align label and switch */
  .toggle-container {
    display: flex;
    align-items: center;
    gap: 12px; /* space between label and switch */
    font-family: sans-serif;
    margin: 10px 0;
  }

  .toggle-label {
    font-size: 16px;
    color: #333;
  }

  /* Switch styling */
  .switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 28px;
  }

  .switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }

  .stay-on-top {
    z-index: 999999 !important;
    position: relative !important;
}


  .slider {
    position: absolute;
    cursor: pointer;
    top: 0; left: 0;
    right: 0; bottom: 0;
    background-color: #ccc;
    transition: 0.4s;
    border-radius: 28px;
  }

  .slider:before {
    position: absolute;
    content: "";
    height: 22px;
    width: 22px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: 0.4s;
    border-radius: 50%;
  }

  input:checked + .slider {
    background-color: #4CAF50;
  }

  input:checked + .slider:before {
    transform: translateX(22px);
  }


  html, body {
    height: 100%;
    margin: 0;
    padding: 0;
    overflow: hidden;   /* prevent page scrolling */
}

#iframe-container {
    position: absolute;
    visibility: hidden;
    top: 0; left: 0;
    width: 100%; height: 100%;
    z-index: 1; /* low */
}

#iframe1 {
    width: 100%;
    height: 100%;
    border: none;
}


    /* Calendar hidden by default but stays in document flow */

    /* Mapwin = fixed-size container (height of screen minus margins) */
    #mapwin {
        position: relative;
        height: calc(100vh - 40px);
/*        overflow: hidden;    prevents outer scrolling */
        border: 1px solid #ddd;
    }


    #calendar {
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        display: flex;
        flex-direction: column;
        background: white;
        visibility: visible;   /* toggle via JS */
        z-index: 100;          /* HIGHER than iframe */
    }


    #calendar-header {
        flex: 0 0 auto; /* fixed height */
        background: white;
        padding: 10px 0;
        border-bottom: 1px solid #ccc;
        z-index: 100;
    }

    /* Only this scrolls */
    #calendar-scroll {
        position: relative;
        flex: 1 1 auto;   /* fills remaining space */
        height: 800px;     /* critical! allows scrolling */
        overflow-y: auto;  /* scrolling enabled */
        padding: 5px;
        /* remove height: 100% */
        z-index: 100;
    }


    /* Login screen on top of everything initially */
    #loginScreen {
        visibility: visible;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        background: white;
        padding: 20px;
        z-index: 3;
    }

    /* add to your CSS */
    #loginScreen.fade-out {
        opacity: 0;
        transition: opacity 0.3s ease;
    }

      #loginMessage {
        transition: opacity 0.5s ease-in-out;
        opacity: 0; /* start hidden */
      }
      #loginMessage.show {
        opacity: 1; /* fade in */
      }

  /* Calendar styles (unchanged) */
  .calendar-grid { margin-top: 90px; }
  .slot { position: relative; height: 90px; width: 100%; border: 1px solid #ddd; border-radius: 4px; background-color: #fafafa; box-sizing: border-box; padding: 1px 6px; overflow: hidden; font-size: 0.85em; line-height: 1.2em; }
  .slot-time { font-size: 0.75em; font-weight: 600; color: #666; margin-right: 0.4em; vertical-align: baseline; }
  .slot-content { display: inline; word-break: break-word; }
  .slot small { color: #555; display: block; }
  .slot-label { position: absolute; top: 2px; left: 4px; font-size: 0.75em; color: #666; pointer-events: none; z-index: 2; background: rgba(255,255,255,0.85); border-radius: 3px; padding: 0 4px; white-space: nowrap; --label-width: calc(100% + 8px); }
  .slot::before { content:""; display:block; width:calc(var(--label-width,3em)+6px); height:0; flex:0 0 auto; }
  .slot .lozenge { margin:0; padding:0 4px; font-size:0.8em; line-height:1em; display:inline-block; border-radius:4px; white-space:nowrap; opacity:1; }
  .slot .lozenge[data-type="activity"] { background: rgba(204,229,255,0.9); }
  .slot .lozenge[data-type="resource"] { background: rgba(212,237,218,0.9); }
  .slot .lozenge[data-type="place"] { background: rgba(255,243,205,0.9); }
  .slot .lozenge[data-type="area"] { background: rgba(248,215,218,0.9); }
  .election-highlight { border: 2px double red !important; box-sizing: border-box; }
  .today-highlight { border: 2px double blue !important; box-sizing: border-box; }
</style>
<script>

  // üß± Safe variable injection
  {% set _options = options or {} %}
  window.task_tags = {{ _options.get('task_tags', []) | tojson }};
  window.resources = {{ _options.get('resources', []) | tojson }};
  window.places = {{ _options.get('places', []) | tojson }};
  window.areas = {{ _options.get('areas', []) | tojson }};

  console.log("Injected task_tags:", window.task_tags);
  console.log("Injected resources:", window.resources);
  console.log("Injected places:", window.places);
  console.log("Injected areas:", window.areas);

  const DEVURLS = {{ DEVURLS | tojson }} ;
  const isDev = location.hostname.includes("localhost") || location.hostname.startsWith("127.");
  const API = isDev ? DEVURLS["dev"] : "__REPLACE_WITH_API_URL__";

  if (!isDev) {
      const btn = document.getElementById("export-html-btn");
      if (btn) {
          btn.style.display = "none";
      }
  }

  const startHour = 9, endHour = 21, slotDuration = 2;


  /* ---------------------------------------------------------
   * UPDATE CONSTANTS FORM UI
   * --------------------------------------------------------- */


</script>

<div id="mapwin" class="innertube">
  <div id="iframe-container">
    <iframe id="iframe1" src="{{ url_for('thru', path=mapfile) }}" width="1200" height="800"></iframe>
  </div>
    <!-- Login Screen -->
    <div id="loginScreen">
        <h2>Login</h2>
        <input type="password" id="password" placeholder="Enter password" class="form-control mb-2">
        <button id="loginBtn" type="button" class="btn btn-primary mb-2">Login</button>
        <div id="loginMessage"></div>
    </div>

    <!-- Calendar Container -->
    <div id="calendar">
        <div id="calendar-header" class="container-fluid text-center">
            <h2 id="calendar-title" class="mb-2">
                {{ current_election }} Campaigns Calendar
            </h2>

            <div id="calendar-controls" class="d-flex justify-content-center gap-2 flex-wrap mb-2">
                <button id="switch-tomap-btn" class="btn btn-tomap">üß≠ Map</button>
                <button id="save-calendar-btn" class="btn btn-primary">üíæ Save Calendar</button>
                <button id="generate-summary-btn" class="btn btn-secondary">üìã Generate Table</button>
                <button id="export-html-btn" class="btn btn-info">üîê Export HTML</button>
            </div>
        </div>

        <div id="calendar-scroll" class="container-fluid">
            <div id="calendar-grid" class="calendar-grid mt-4"></div>
            <div id="summary-report" class="mt-4"></div>
        </div>
    </div>
</div>


{% endblock map %}
{% block modals %}
<!-- Modal -->
<div class="modal fade" id="slotModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">

            <!-- Modal header -->
            <div id="modalPopup" class="modal-header">
                <h5 class="modal-title">Edit Slot</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <!-- Modal body -->
            <div class="modal-body">

                <!-- Main slot form -->
                <form id="slotForm">

                    <!-- Activity -->
                    <div class="mb-2">
                        <label>Activity</label>
                        <select id="activitySelect" class="form-select"></select>
                        <button id="addTaskTagBtn" type="button" class="btn btn-sm btn-primary mt-1">‚ûï Add Task Tag</button>
                    </div>

                    <!-- Hidden mini-form for adding a task tag -->
                    <div id="addTaskTagForm" class="border p-2 mt-2 d-none">
                        <h6>New Task Tag</h6>
                        <input id="newTagCode" class="form-control mb-1" placeholder="Tag code">
                        <input id="newTagLabel" class="form-control mb-1" placeholder="Tag label">
                        <button id="saveNewTag" type="button" class="btn btn-success btn-sm mt-1">Save Tag</button>
                    </div>

                    <!-- Resources -->
                    <div class="mb-2">
                        <label>Resources</label>
                        <select id="resourcesSelect" class="form-select" multiple></select>
                        <button id="addResourceBtn" type="button" class="btn btn-sm btn-primary mt-1">‚ûï Add Resource</button>
                    </div>

                    <!-- Hidden mini-form for adding a resource -->
                    <div id="addResourceForm" class="border p-2 mt-2 d-none">
                        <h6>New Resource</h6>
                        <input id="newResFirst" class="form-control mb-1" placeholder="First name">
                        <input id="newResLast" class="form-control mb-1" placeholder="Surname">
                        <input id="newResEmail" class="form-control mb-1" placeholder="Email">
                        <button id="saveNewResource" type="button" class="btn btn-success btn-sm mt-1">Save Resource</button>
                    </div>

                    <!-- Place -->
                    <div class="mb-2">
                        <label>Place</label>
                        <select id="placeSelect" class="form-select"></select>
                        <button id="addPlaceBtn" type="button" class="btn btn-sm btn-primary mt-1">
                            ‚ûï Add Place
                        </button>
                    </div>

                    <!-- Hidden mini-form for adding a place -->
                    <div id="addPlaceForm" class="border p-2 mt-2 d-none">
                        <h6>New Place</h6>
                        <input id="newPlacePrefix" class="form-control mb-1" placeholder="Prefix (e.g., Four Points Hotel)">
                        <input id="newPlaceAddress1" class="form-control mb-1" placeholder="Address line 1">
                        <input id="newPlaceAddress2" class="form-control mb-1" placeholder="City / Town">
                        <input id="newPlacePostcode" class="form-control mb-1" placeholder="Postcode">
                        <input id="newPlaceURL" class="form-control mb-1" placeholder="Website URL (optional)">
                        <button id="saveNewPlace" type="button" class="btn btn-success btn-sm mt-1">Save Place</button>
                    </div>

                    <!-- Area -->
                    <div class="mb-2">
                        <label>Area</label>
                        <select id="areaSelect" class="form-select" multiple></select>
                    </div>

                </form>

            </div>

            <!-- Modal footer -->
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button class="btn btn-danger" id="clearSlotBtn">Clear Slot</button>
                <button class="btn btn-primary" id="saveSlotBtn">Save</button>
            </div>

        </div>
    </div>
</div>



{% endblock modals %}
{% block log %}

<div id="logwin" class="innertube">
  <h3>elecTrek flash messages: </h3>
  {% with messages = get_flashed_messages() %}
  {% if messages %}
    <ul class="flashes">
      {% for message in messages %}
        <li>{{ message }}</li>
      {% endfor %}
    </ul>
  {% endif %}
{% endwith %}
		<h3>elecTrek status messages: </h3>
      <ul class="flashes" >
      {% for pessage in pessages %}
        <li> {{ pessage  }}</li>
      {% endfor %}
      </ul>

</div>
{% endblock log %}


{% block nav %}

<div id="nav" >
  <h3>Election Dashboard</h3>
  <ul class="centred" >user: {{ session['username'] }}</ul>
  <ul class="nav nav-tabs" id="election-tabs">
    {% for election_name in ELECTIONS %}
      <li class="nav-item position-relative tab-item">
        <button class="nav-link election-tab {% if election_name == current_election %}active{% endif %}"
                data-election="{{ election_name }}"
                onclick="switchElection('{{ election_name }}')">
          {{ election_name }}
        </button>
        <span class="delete-tab-btn"
              data-election="{{ election_name }}"
              onclick="deleteElection('{{ election_name }}')">√ó</span>
      </li>
    {% endfor %}
    <li class="nav-item">
      <button class="nav-link" id="add-election-tab" style="font-weight: bold;" onclick="addElection()">ÔºãNEW</button>
    </li>
  </ul>


      <div id="constants-container">
      <ul>
        <li class="righted">
          <select class="righted"name="streams" id="streams" ></select><br>
      </li>
      <li class="righted">
        Type of Election: <select class="righted"name="territories" id="territories"></select><br>
      </li>
      <li class="righted">
        Territory: <input class="righted" type="text" name="territory" id="territory" readonly><br>
      </li>
      <li class="righted">
      Party selected: <select class="righted" name="yourparty" id="yourparty"></select><br>
      </li>
      <li class="righted">
      Walk Size: <input class="righted" type="number" min="100" max="500" step="50" name="walksize" id="walksize" /><br>
      </li>
      <li class="righted">
      Team Size: <input class="righted" type="number" min="1" max="25" step="1" name="teamsize" id="teamsize" /><br>
      </li>
      <li class="righted">
      GOTV: <input class="righted" type="number" id="GOTV" name="GOTV" min="0.01" max="0.99" step="0.01"  />
      </li>
      <li class="righted">
        <div class="toggle-container">
          <span class="toggle-label">Accumulate: </span>
          <label class="switch">
            <input type="checkbox" id="accumulate" name="accumulate" onchange="handleToggle(this)">
            <span class="slider"></span>
          </label>
        </div>
      </li>
      <li class="righted">
      Bookmarks: <select class="righted" name="mapfiles" id="mapfiles" ></select><br>
      </li>
      <li class="righted">
        <label id="resources-toggle" style="cursor: pointer;">Resources ‚¨á</label>
        <div id="resources-container" style="display: none; position: absolute; background: white; border: 1px solid #ccc; padding: 5px;">
          <select name="resources" id="resources" multiple size="5"></select>
        </div>
      </li>
      <li class="righted" >
      Candidate: <select class="righted" name="candidate" id="candidate" ></select><br>
        </li>
      <li class="righted" >
      Campaign Mgr: <select class="righted" name="campaignMgr" id="campaignMgr" ></select><br>
      </li>
      <li class="righted" >
      Email: <input class="righted" name="campaignMgremail" id="campaignMgremail" readonly></input><br>
      </li>
      <li class="righted" >
      Mobile: <select class="righted" name="mobile" id="mobile" ></select><br>
      </li>
      <li class="righted" >
      Prev.Party: <select class="righted" name="previousParty" id="previousParty" disabled></select><br>
      </li>
      <li class="righted">
          Date of election:
          <input
          class="righted"
          type="date"
          id="electiondate"
          name="electiondate"
          />
      </li>
      </ul>
</div>
        <div class = "grid-container">
          <div class="grid-item">
          <button type="button" id="update-territory-btn" class="small_btn">BOOKMARK<br>TERRITORY</button>
          </div>
            <div class="grid-item">
              <button type = "button" id = "b1" class = "small_btn" onclick="setActionForm('filelist',filelist='maps')">Boundary<br>Maps</button>
            </div>
            <div class="grid-item">
              <button type = "button" id = "b2" class = "small_btn" onclick="window.open('/election-report', '_blank')">ELECTIONS<br>REPORT</button>
            </div>
            <div class="grid-item">
              <button type="button" id="b3" class="small_btn" >ELECTORAL<br>REGISTERS</button>
            </div>
            <div class="grid-item">
              <button type = "button" id = "b4" class = "small_btn">ACTIVITY<br>DELIVERY</button>
            </div>
            <div class="grid-item">
              <button type = "button" id = "b5" class = "small_btn">CAMPAIGN PROGRESS</button>
            </div>
            <div class="grid-item">
              <button type = "button" id = "b9" class = "small_btn">CALENDAR</button>
            </div>
            <div class="grid-item">
              <button type = "button" id = "b6" class = "small_btn">VOTER<br>TELLING</button>
            </div>
            <div class="grid-item">
              <button type = "button" id = "b7" class = "small_btn" >ELECTOR<br>SEARCH</button>
            </div>
            <div class="grid-item">
              <button type = "button" id = "b8" class = "small_btn" >BROWSE<br>TERRITORY</button>
            </div>
            <div class="grid-item">
              <button type = "button" id = "logout-button" class = "small_btn" >LOGOUT</button>
            </div>

          </div>
    <div id="chartContainer" style="width: 300px; height: 300px; position: relative;">
      <canvas id="streamChart"></canvas>
    </div>
  </div>
{% endblock nav %}

{% block captains %}

<div id="tabletitle" class="innertube">
  <span id="selectedTitle">Table Details</span>
  <select id="tableSelector">
    {% for key, value in table_types.items() %}
    <option value="{{ key }}">{{ value }}</option>
  {% endfor %}
  </select>
</div>

<div id="datawin" class="innertube">
  <div style="overflow-x: auto; width: 100%; height: 100%;">
    <table id="captains-table" style="width: 100%; table-layout: fixed;">
      <thead></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<script >



  // ----------------------------
  // Message Handling
  // ----------------------------
  const messages = JSON.parse('{{ get_flashed_messages()|tojson|safe }}') || [];
  const iframeEl = document.getElementById('iframe1');

  function bindEvent(element, eventName, eventHandler) {
    element.addEventListener(eventName, eventHandler, false);
  }

  bindEvent(window, 'message', (e) => {
    messages.pop();
    messages.push(e.data);

    const logWindow = document.getElementById("logwin");
    const li = document.createElement("li");
    li.textContent = e.data.type;
    logWindow.appendChild(li);
    logWindow.scrollTop = logWindow.scrollHeight;
  });





  // ----------------------------
  // Table Fetching
  // ----------------------------
  const PARTY_COLORS = {
    O: "brown", R: "cyan", C: "blue", S: "red",
    LD: "yellow", G: "limegreen", I: "indigo",
    PC: "darkred", SD: "orange", Z: "lightgray",
    W: "white", X: "darkgray"
  };

  async function fetchTableData(tableName) {
    const table = document.getElementById("captains-table");
    const tabTitle = document.getElementById("selectedTitle");

    if (!table || !tabTitle) {
      console.error("‚ùå Required DOM elements not found: #captains-table or #selectedTitle");
      return;
    }

    const tabHead = table.querySelector("thead");
    const tabBody = table.querySelector("tbody");

    if (!tabHead || !tabBody) {
      console.error("‚ùå Table structure invalid: missing <thead> or <tbody>");
      return;
    }

    console.log(`üì• Fetching data for table: ${tableName}`);

    try {
      const res = await fetch(`/get_table/${tableName}`, { credentials: "same-origin" });
      if (!res.ok) throw new Error(`Server returned ${res.status}`);
      const data = await res.json();

      if (!Array.isArray(data) || data.length < 3) {
        console.error("‚ùå Invalid data format received:", data);
        return;
      }

      const [columnHeaders, rows, title] = data;
      tabTitle.textContent = title;
      tabHead.innerHTML = "";
      tabBody.innerHTML = "";

      // Table header
      const headRow = document.createElement("tr");
      headRow.innerHTML = `<th>?</th>` + columnHeaders.map(h => `<th>${h.toUpperCase()}</th>`).join('');
      tabHead.appendChild(headRow);

      const selectedParty = document.getElementById("yourparty")?.value;

      // Table body
      rows.forEach(record => {
        const row = document.createElement("tr");
        row.innerHTML = `<td><input type="checkbox" class="selectRow" name="selectRow[]"></td>` +
          columnHeaders.map(h => {
            const value = record[h] ?? "";
            const color = (selectedParty && h === selectedParty) ? (PARTY_COLORS[selectedParty] || 'inherit') : '';
            return `<td style="background-color:${color}">${value}</td>`;
          }).join('');
        tabBody.appendChild(row);
      });

      console.log(`‚úÖ Table "${tableName}" populated with ${rows.length} rows.`);
    } catch (err) {
      console.error("‚ùå Error fetching table data:", err);
    }
  }


  function handleToggle(el) {
    console.log(`Switch is ${el.checked ? 'ON' : 'OFF'}`);
  }

  // ----------------------------
  // String Utilities
  // ----------------------------
  function toUpperCase(str) {
    return str.replace(/\w\S*/g, txt => txt.charAt(0).toUpperCase() + txt.slice(1).toUpperCase());
  }

  function subending(filename, ending) {
    const endings = [".XLSX", ".xlsx", ".CSV", ".csv", "-PRINT.html", "-MAP.html", "-WALKS.html", "-ZONES.html", "-PDS.html", "-DIVS.html", "-WARDS.html"];
    let stem = filename;

    for (const suffix of endings) if (filename.endsWith(suffix)) { stem = filename.slice(0, -suffix.length); break; }

    const result = stem + ending;
    console.log(`____Subending test: from ${filename} to ${result}`);
    return result;
  }

  // ----------------------------
  // Chart Utilities
  // ----------------------------
  function createOrUpdateChart(labels, data, rags) {
    const ragColors = { red: 'rgba(255,99,132,0.9)', amber: 'rgba(255,159,64,0.9)', limegreen: 'rgba(50,205,50,0.9)' };
    const backgroundColors = rags.map(rag => ragColors[rag]);

    const canvas = document.getElementById('streamChart');
    if (!canvas) return console.error('streamChart canvas not found.');

    const ctx = canvas.getContext('2d');

    if (window.streamChart) {
      window.streamChart.data.labels = labels;
      window.streamChart.data.datasets[0].data = data;
      window.streamChart.data.datasets[0].backgroundColor = backgroundColors;
      window.streamChart.update();
    } else {
      Chart.register(ChartDataLabels);
      window.streamChart = new Chart(ctx, {
        type: 'doughnut',
        data: { labels, datasets: [{ label: 'Electors in Stream', data, backgroundColor: backgroundColors, borderColor: '#fff', borderWidth: 1 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, title: { display: true, text: 'Stream Loading Status' }, datalabels: { color: '#000', font: { size: 14, weight: 'bold' }, formatter: val => val.toLocaleString() } } },
        plugins: [ChartDataLabels]
      });
    }
  }

  async function fetchAndUpdateChart() {
    try {
      const { streamrag } = await (await fetch('/streamrag_api')).json();
      const labels = Object.keys(streamrag);
      const data = labels.map(l => streamrag[l].Elect);
      const rags = labels.map(l => streamrag[l].RAG);
      createOrUpdateChart(labels, data, rags);
    } catch (err) {
      console.error('Failed to fetch streamrag data:', err);
    }
  }

  // ----------------------------
  // Constants UI
  // ----------------------------
  function attachListenersToConstantFields(constants) {
    Object.keys(constants).forEach(key => {
      const el = document.getElementById(key);
      if (!el) return;

      const listener = () => refreshConstantsUI();
      el.removeEventListener("change", listener);
      el.removeEventListener("input", listener);

      if (el.tagName === "SELECT" && el.multiple) el.addEventListener("blur", listener);
      else { el.addEventListener("change", listener); el.addEventListener("input", listener); }
    });
  }






  document.addEventListener("DOMContentLoaded", async () => {

  let selectedPlaceData = null; // Store data from the map
  let preventModalClose = false;
  let addPlaceActive = false;




  const modal = document.getElementById("modalPopup");

  // Bootstrap tries to close the modal ‚Üí we intercept it
  modal.addEventListener("hide.bs.modal", function (e) {
      if (preventModalClose) {
          console.warn("‚õî Prevented modal from closing ‚Äî add-place mode active");
          e.preventDefault();
      }
  });

  /* ---------------------------------------------------------
   * CALENDAR <-> MAP TOGGLE
   * --------------------------------------------------------- */
   window.toggleView = function () {

       if (loginScreen.style.visibility === "visible") return;

       const mapVisible = iframeContainer.style.visibility === "visible";

       // Map ‚Üí Calendar
       if (mapVisible) {

           // Hide map iframe non-destructively
           iframeContainer.style.visibility = "hidden";
           iframeContainer.style.pointerEvents = "none";
           iframeContainer.style.zIndex = "1";

           iframe.style.visibility = "hidden";
           iframe.style.pointerEvents = "none";

           // Show calendar safely
           calendar.style.opacity = "1";
           calendar.style.pointerEvents = "auto";

           toggleBtn.textContent = "üß≠ View Map";
       }

       // Calendar ‚Üí Map
       else {

           // Hide calendar safely
           calendar.style.opacity = "0";
           calendar.style.pointerEvents = "none";

           // Show map
           iframeContainer.style.visibility = "visible";
           iframeContainer.style.pointerEvents = "auto";
           iframeContainer.style.zIndex = "1000";

           iframe.style.visibility = "visible";
           iframe.style.pointerEvents = "auto";

           toggleBtn.textContent = "üìÖ View Calendar";
       }
   };


 window.addEventListener("message", async (event) => {
   const data = event.data;
   const iframe = document.getElementById("iframe1");

   console.log("üì© Parent received message:", data, "from", event.origin);
   // -----------------------------------------------------
   // toggleView
   // -----------------------------------------------------
   if (data?.type === "toggleView" || data === "toggleView") {
       console.log("üì© Received toggleView from iframe");
       await window.toggleView();
       return;
   }



   // -----------------------------------------------------
   // TABLE UPDATE
   // -----------------------------------------------------
   if (data?.type === "update-table" || data === "update-table") {
       fetchTableData(data.stable);
       return;
   }

   // -----------------------------------------------------
   // SHOW MAP FOR ADD-PLACE
   // -----------------------------------------------------
   if (data === "showMapForAddPlace") {
       console.log("üìå Handling showMapForAddPlace");

       iframe.style.visibility = "visible";
       iframe.classList.remove("dimmed");

       document
           .getElementById("modalPopup")
           .classList.add("stay-on-top");



       return;
   }

   // -----------------------------------------------------
   // NEW PLACE CREATED
   // -----------------------------------------------------
   if (data?.type === "newPlaceCreated") {
       console.log("üìå Handling newPlaceCreated", data);

       // Save for later processing
       selectedPlaceData = data;
       console.log("üì¶ Stored selectedPlaceData:", selectedPlaceData);

       // Fill mini-form in modal
       document.getElementById("newPlacePrefix").value = data.prefix || "";
       document.getElementById("newPlaceAddress1").value = "";
       document.getElementById("newPlaceAddress2").value = "";
       document.getElementById("newPlacePostcode").value = data.postcode || "";
       document.getElementById("newPlaceURL").value = "";

       // Store lat/lng
       const form = document.getElementById("addPlaceForm");
       form.dataset.lat = data.lat;
       form.dataset.lng = data.lng;

       console.log("üìå Stored hidden lat/lng:", data.lat, data.lng);

       // Show the form
       form.classList.remove("d-none");
       console.log("‚û°Ô∏è addPlaceForm is now VISIBLE");

       // Dim the map
       iframe.classList.add("dimmed");

       // Allow modal to be closed normally again
       preventModalClose = false;
       addPlaceActive = false;

       console.log("‚ö†Ô∏è Modal remains visible and active!");

       return;
   }
});


    // ------------------------------
    // Add Place button handler
    // ------------------------------
    document.getElementById("addPlaceBtn").addEventListener("click", () => {
        addPlaceActive = true;

        // Show map
        window.postMessage({ type: "showMapForAddPlace"}, "*");

        // Tell iframe to prepare
        document.getElementById("iframe1").contentWindow.postMessage(
            { type: "enableAddPlace" },
            "*"
        );
    });




    // ------------------------------
    // Save button handler
    // ------------------------------
    document.getElementById("saveNewPlace").addEventListener("click", () => {
        const form = document.getElementById("addPlaceForm");

        const prefix = document.getElementById("newPlacePrefix").value.trim();
        const address1 = document.getElementById("newPlaceAddress1").value.trim();
        const address2 = document.getElementById("newPlaceAddress2").value.trim();
        const postcode = document.getElementById("newPlacePostcode").value.trim();
        const url = document.getElementById("newPlaceURL").value.trim();
        const lat = form.dataset.lat;
        const lng = form.dataset.lng;

        if (!prefix || !address1 || !address2) {
            alert("Prefix, Address line 1, and City/Town are required.");
            return;
        }

        const newPlace = {
            AddressPrefix: prefix,
            Address1: address1,
            Address2: address2,
            Postcode: postcode,
            url: url,
            Lat: lat,
            Long: lng
        };

        // Add to dropdown
        const opt = document.createElement("option");
        opt.value = prefix;
        opt.textContent = `${prefix} ‚Äî ${address1}, ${address2}`;
        document.getElementById("placeDropdown").appendChild(opt);

        // Hide mini-place form and restore map visibility
        form.classList.add("d-none");
        iframe.classList.remove("dimmed");
        iframe.style.visibility = "hidden";

        console.log("New place added:", newPlace);
    });



    // ------------------------------
    // Handle Save button for new place
    // ------------------------------
    document.getElementById("saveNewPlace").addEventListener("click", () => {
        const form = document.getElementById("addPlaceForm");

        if (!selectedPlaceData) return alert("Select a place on the map first.");

        const prefix = document.getElementById("newPlacePrefix").value.trim();
        if (!prefix) return alert("Please enter a prefix.");

        // Add to dropdown
        const opt = document.createElement("option");
        opt.value = prefix;
        opt.textContent = `${prefix} ‚Äî ${document.getElementById("newPlaceAddress1").value} ${document.getElementById("newPlaceAddress2").value}`;
        document.getElementById("placeDropdown").appendChild(opt);

        // Hide mini-form and undim map
        form.classList.add("d-none");
        document.getElementById("iframe1").classList.remove("dimmed");

        // Clear global selection
        selectedPlaceData = null;

        // Optional: reset form fields
        form.reset();
    });



    // Show add-resource form
    document.getElementById("addResourceBtn").addEventListener("click", () => {
        document.getElementById("addResourceForm").classList.remove("d-none");
    });

    // Save new resource
    document.getElementById("saveNewResource").addEventListener("click", () => {
        const first = newResFirst.value.trim();
        const last  = newResLast.value.trim();
        const email = newResEmail.value.trim();

        if (!first || !last) {
            alert("Firstname and surname required");
            return;
        }

        const code = (first[0] + last).toUpperCase();

        const resourceObj = {
            Firstname: first,
            Surname: last,
            campaignMgremail: email
        };

        // Update global state
        window.resources[code] = resourceObj;

        // ALSO update latestOptions (otherwise UI resets)
        window.latestOptions.resources[code] = resourceObj;

        populateDropdowns();
        updateConstantsUI(window.latestConstants, window.latestOptions);

        addResourceForm.classList.add("d-none");
    });


    // Show add-task-tag form
    document.getElementById("addTaskTagBtn").addEventListener("click", () => {
        document.getElementById("addTaskTagForm").classList.remove("d-none");
    });

    // Save new tag
    document.getElementById("saveNewTag").addEventListener("click", () => {
        const code  = newTagCode.value.trim();
        const label = newTagLabel.value.trim();

        if (!code || !label) {
            alert("Both code and label required");
            return;
        }

        // Update global
        window.task_tags[code] = label;

        // ALSO update options so updateConstantsUI does not overwrite
        window.latestOptions.task_tags[code] = label;

        // Refresh UI
        populateDropdowns();
        updateConstantsUI(window.latestConstants, window.latestOptions);

        addTaskTagForm.classList.add("d-none");
    });




    function openAddResourceForm() {
    const id = prompt("Enter new resource code (unique ID like R101):");
    if (!id) return;

    const Firstname = prompt("Enter first name:");
    const Surname = prompt("Enter surname:");
    const campaignMgremail = prompt("Enter campaign manager email (optional):") || "";

    if (!Firstname || !Surname) return alert("Firstname and Surname are required");

    // Create resource object
    window.resources[id] = {
        Firstname,
        Surname,
        campaignMgremail
    };

    console.log("Added new resource:", window.resources[id]);

    // Rerender UI
    updateConstantsUI(window.latestConstants, window.latestOptions);

    alert("Resource added!");
}

function openAddTaskTagForm() {
    const tag = prompt("Enter new task tag code (e.g., L5):");
    if (!tag) return;

    if (window.task_tags[tag]) {
        return alert("This task tag already exists!");
    }

    const description = prompt("Enter task tag description:");
    if (!description) return;

    window.task_tags[tag] = description;

    console.log("Added new task tag:", tag, description);

    updateConstantsUI(window.latestConstants, window.latestOptions);

    alert("Task tag added!");
}

    window.updateConstantsUI = function (constants, options) {
      if (!constants) return;

      // =====================================================
      // ‚≠ê Make global objects
      // =====================================================
      window.areas      = options?.areas      || {};
      window.places     = options?.places     || {};
      window.resources  = options?.resources  || {};
      window.task_tags  = options?.task_tags  || {};

      console.log("Global areas:", window.areas);
      console.log("Global places:", window.places);
      console.log("Global resources:", window.resources);
      console.log("Global task_tags:", window.task_tags);

      // =====================================================
      // ‚≠ê Iterate through all constants and populate UI
      // =====================================================
      Object.entries(constants).forEach(([key, value]) => {
          const el = document.getElementById(key);
          if (!el) return;

          const optsObj = options[key] || {}; // used for dynamic select building
          el.innerHTML = "";

          // ------------------------------------------
          // SELECT HANDLING
          // ------------------------------------------
          if (el.tagName === "SELECT") {

              //
              // 1Ô∏è‚É£ MULTI-SELECT "resources"
              //
              if (key === "resources") {
                  Object.entries(options.resources || {}).forEach(([code, person]) => {
                      const o = document.createElement("option");
                      o.value = code;
                      o.textContent = `${person.Firstname} ${person.Surname}`;
                      if (Array.isArray(value) && value.includes(code)) o.selected = true;
                      el.appendChild(o);
                  });
              }

              //
              // 2Ô∏è‚É£ candidate / campaignMgr selectors
              //
              else if (key === "candidate" || key === "campaignMgr") {
                  const selectedResources = Array.isArray(constants.resources)
                      ? constants.resources
                      : [];

                  selectedResources.forEach(code => {
                      const person = options.resources?.[code];
                      if (!person) return;

                      const o = document.createElement("option");
                      o.value = code;
                      o.textContent = `${person.Firstname} ${person.Surname}`;

                      if (value === code) {
                          o.selected = true;

                          // support the old behaviour where campaignMgr updates email field
                          if (key === "campaignMgr") {
                              const emailField = document.getElementById("campaignMgremail");
                              if (emailField) emailField.value = person.campaignMgremail;
                          }
                      }

                      el.appendChild(o);
                  });
              }

              //
              // 3Ô∏è‚É£ mapfiles logic (loads into iframe)
              //
              else if (key === "mapfiles") {
                  if (Array.isArray(value)) {
                      value.forEach((path, idx) => {
                          const o = document.createElement("option");
                          o.value = path;
                          o.textContent = `Map ${idx + 1}: ${path.split("/").pop()}`;
                          if (idx === value.length - 1) o.selected = true;
                          el.appendChild(o);
                      });
                  }

                  el.onchange = () => {
                      changeIframeSrc(`/thru/${el.value}`);
                  };
              }

              //
              // 4Ô∏è‚É£ Generic SELECT population
              //
              else {
                  Object.entries(optsObj).forEach(([optValue, optLabel]) => {
                      const o = document.createElement("option");
                      o.value = optValue;
                      o.textContent = `${optValue}: ${optLabel}`;
                      if (optValue === value) o.selected = true;
                      el.appendChild(o);
                  });
              }

          }
          // ------------------------------------------
          // NON-SELECT INPUTS
          // ------------------------------------------
          else {
              el.value = value;
          }

          // =====================================================
          // ‚≠ê Auto backend update on change (old behaviour kept)
          // =====================================================
          el.oninput = () => {
              let newVal;

              if (el.type === "number") newVal = parseFloat(el.value);
              else if (el.type === "checkbox") newVal = el.checked;
              else newVal = el.value;

              if (el.multiple) {
                  newVal = Array.from(el.selectedOptions).map(o => o.value);
              }

              fetch("/set-constant", {
                  method: "POST",
                  credentials: "same-origin",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                      election:
                          document.querySelector(".election-tab.active")?.dataset.election ||
                          "",
                      name: key,
                      value: newVal
                  })
              })
                  .then(res => res.json())
                  .then(resp => {
                      if (!resp.success) alert("Failed to update: " + resp.error);
                  });
          };
      });

      // Keep the old behaviour
      if (typeof attachListenersToConstantFields === "function") {
          attachListenersToConstantFields(constants);
      }
  };



    const getActiveElectionTab = () =>
        document.querySelector("button.election-tab.active");

    console.log("üîÄ places on DOM relaod :", places);
    console.log("üîÄ resources on DOM relaod :", resources);
    console.log("üîÄ areas on DOM relaod :", areas);
    console.log("üîÄ task_tags on DOM relaod :", task_tags);


      async function ensureTabsReady() {
          while (document.querySelectorAll(".election-tab").length === 0) {
              await new Promise(r => requestAnimationFrame(r));
          }
      }

      async function ensureOneTabActive() {
        const tabs = document.querySelectorAll(".election-tab");
        let active = document.querySelector(".election-tab.active");

        if (!active && tabs.length > 0) {

            // Fetch last-used election (correct JSON way)
            let lastElection = null;
            try {
                const res = await fetch("/last-election", { credentials: "same-origin" });
                const json = await res.json();
                lastElection = json.last_election;   // <-- THIS WAS THE FIX
            } catch (e) {
                console.warn("Could not fetch last election");
            }

            // Try selecting that tab
            if (lastElection) {
                const lastTab = [...tabs].find(t => t.dataset.election === lastElection);
                if (lastTab) {
                    lastTab.classList.add("active");
                    return lastTab;
                }
            }

            // Fallback: first tab
            tabs[0].classList.add("active");
            return tabs[0];
        }

        return active;
    }

    async function setActiveElectionOnStartup() {
        const activeTab = await ensureOneTabActive();
        const electionName = activeTab.dataset.election || activeTab.textContent.trim();
        console.log("üì© setting startup active tab::", electionName);
        if (!electionName) {
            console.error("No election name found for active tab!", activeTab);
            return;
        }

        try {
            const res = await fetch("/set-election", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                credentials: "same-origin",
                body: JSON.stringify({ election: electionName })
            });

            const data = await res.json();
            window.latestConstants = data.constants;
            window.latestOptions = data.options;

            updateConstantsUI(data.constants, data.options);

            console.log("üì©  startup (set-election returned data:", data);
            console.log("üîÄ startup places on DOM reload :", window.places);
            console.log("üîÄ startup resources on DOM reload :", window.resources);
            console.log("üîÄ startup areas on DOM reload :", window.areas);
            console.log("üîÄ startup task_tags on DOM reload :", window.task_tags);

           window.plan = data.constants?.calendar_plan;
           console.log("üì© calendar_plan::", plan);
        } catch (e) {
            console.error("Failed to set active election:", e);
        }
    }


    // Call this function on startup to tell backend which election is active


      // 1. Wait for tabs
      await ensureTabsReady();
      // 2Ô∏è‚É£ Tell backend which election is active
      await setActiveElectionOnStartup();

      // 4. Build calendar UI BEFORE loading calendar data
      console.log("üìÖ Building calendar UI‚Ä¶");
      buildCalendarGrid("calendar-grid", 45);
      populateDropdowns();
      console.log("üìÖ Calendar UI ready.");

      // 5. NOW load plan into fully created calendar
      await getCalendarUpdate();
      console.log("üìÖ Calendar data loaded.");

      /* ---------------------------------------------------------
       * expose refreshTableData so iframe can call the parent
       * --------------------------------------------------------- */
      window.refreshTableData = function(id) {
          console.log("Refreshing table for", id);
          window.parent.postMessage(
              { type: "update-table", stable: "nodelist_xref" },
              "*"
          );
      };
      /* ---------------------------------------------------------
       * expose refreshTableData so iframe can call the parent
       * --------------------------------------------------------- */

       async function getCalendarUpdate() {
           const currentTab = getActiveElectionTab();
           if (!currentTab) return;

           try {
               const election = currentTab.dataset.election;
               console.log("üì¶ Fetching election:", election);

               const response = await fetch(`${API}/current-election?election=${encodeURIComponent(election)}`);
               if (!response.ok) throw new Error(`HTTP ${response.status}`);

               const data = await response.json();
               console.log("üì¶ Backend response:", data);

//               window.plan = data.calendar_plan;

  //             updateConstantsUI(data.constants, data.options);
               console.log("üì© update calendar_plan::", plan);
//               console.log("üîÄ update places on DOM relaod :", places);
//               console.log("üîÄ update resources on DOM relaod :", resources);
//               console.log("üîÄ update areas on DOM relaod :", areas);
//               console.log("üîÄ update task_tags on DOM relaod :", task_tags);

              window.plan = data.constants?.calendar_plan;
               if (!window.plan || !window.plan.slots) {
                   console.warn("‚ö†Ô∏è No slots found in calendar_plan");
                   return;
               }

               loadCalendarPlan(window.plan);
               console.log("‚úÖ Calendar plan loaded into UI");

           } catch (err) {
               console.error("üö® Error fetching calendar plan:", err);
           }
       }


      /* ---------------------------------------------------------
   * CALENDAR LOGIN AND CALENDAR BUILD
   * --------------------------------------------------------- */

  // elements
  const iframeContainer = document.getElementById("iframe-container");
  const iframe = document.getElementById("iframe1"); // the actual iframe element
  const calendar = document.getElementById("calendar");
  const loginScreen = document.getElementById("loginScreen");
  const loginBtn = document.getElementById("loginBtn");
  const passwordInput = document.getElementById("password");
  const loginMessage = document.getElementById("loginMessage");
  const toggleBtn = document.getElementById("b9");


  // Initial state ‚Äî hide map + calendar, show login unless in dev mode
  if (isDev) {
      console.warn("‚ö† DEV MODE: Skipping login screen");

      loginScreen.style.visibility = "hidden";
      calendar.style.visibility = "visible"; // hide calendar initially
      iframe.style.visibility = "hidden";  // show map initially
      toggleBtn.textContent = "üìÖ View Map"; // button shows calendar option
      calendar.dataset.loaded = "true";    // avoid duplicate fetches

      window.loggedIn = true;

  } else {
      // Normal login behaviour
      loginScreen.style.visibility = "visible";
      calendar.style.visibility = "visible";  // hide calendar
      iframe.style.visibility = "hidden";   // show map by default
      toggleBtn.textContent = "üìÖ View Map"; // button shows calendar option
      window.loggedIn = false;
  }

  // ----------------------------
  // Election Management
  // ----------------------------
  function syncStreamsSelectWithTabs() {
    const streamsSelect = document.getElementById('streams');
    streamsSelect.innerHTML = '';
    document.querySelectorAll('.election-tab').forEach(tab => {
      const opt = document.createElement('option');
      opt.value = tab.dataset.election;
      opt.textContent = `Election ${tab.dataset.election}`;
      streamsSelect.appendChild(opt);
    });
    streamsSelect.value = document.querySelector('.election-tab.active')?.dataset.election || '';
  }

  window.deleteElection = async function(electionName) {
    if (!confirm(`Delete "${electionName}"? This cannot be undone.`)) return;
    const res = await fetch("/delete-election", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "same-origin",
      body: JSON.stringify({ election: electionName })
    });
    const resp = await res.json();
    if (resp.success && resp.electiontabs_html) {
      document.getElementById("election-tabs").innerHTML = resp.electiontabs_html;
      fetchTableData('nodelist_xref');
      syncStreamsSelectWithTabs();
    } else alert("Could not delete election: " + (resp.error || "Unknown error"));
  };

  window.addElection = async function() {
    const newName = prompt("Enter name for new election:");
    if (!newName) return;
    const res = await fetch("/add-election", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "same-origin",
      body: JSON.stringify({ election: newName })
    });
    const resp = await res.json();
    if (resp.success && resp.electiontabs_html) {
      document.getElementById("election-tabs").innerHTML = resp.electiontabs_html;
      syncStreamsSelectWithTabs();
      updateConstantsUI(resp.constants, resp.options);
      fetchTableData('nodelist_xref');
    } else alert("Error adding election: " + resp.error);
  };



  // ENTER triggers login
  passwordInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
          e.preventDefault();
          loginBtn.click();
      }
  });




  // ----------------------------
  // Iframe & Toggle
  // ----------------------------
  window.changeIframeSrc = function(url) {
    const logWindow = document.getElementById("logwin");
    const li = document.createElement("li");
    li.textContent = `Retrieving area ${url}`;
    logWindow.appendChild(li);
    logWindow.scrollTop = logWindow.scrollHeight;

    iframeEl.src = url;
  };

  window.switchElection = async function (electionName) {
    console.log("üîÄ Switching election to:", electionName);

    // Highlight the active tab
    document.querySelectorAll(".election-tab").forEach(tab =>
        tab.classList.remove("active")
    );

    const clickedTab = [...document.querySelectorAll(".election-tab")]
        .find(tab => tab.dataset.election === electionName);

    if (clickedTab) clickedTab.classList.add("active");

    // Update title immediately
    const title = document.getElementById("calendar-title");
    if (title) title.textContent = `${electionName} Campaigns Calendar`;

    // Tell backend
    const res = await fetch("/set-election", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "same-origin",
        body: JSON.stringify({ election: electionName })
    });

    const data = await res.json();
    window.latestConstants = data.constants;
    window.latestOptions = data.options;
    updateConstantsUI(data.constants, data.options);

   window.plan = data.constants?.calendar_plan;

   console.log("üîÄ set places on DOM relaod :", window.places);
   console.log("üîÄ set resources on DOM relaod :", window.resources);
   console.log("üîÄ set areas on DOM relaod :", window.areas);
   console.log("üîÄ set task_tags on DOM relaod :", window.task_tags);
   console.log("üì© set calendar_plan::", window.plan);

   if (!window.plan || !window.plan.slots) {
       console.warn("‚ö†Ô∏è No slots found in calendar_plan");
       return;
   }
   buildCalendarGrid("calendar-grid", 45);
   populateDropdowns();
   loadCalendarPlan(window.plan);
   console.log("‚úÖ Calendar plan loaded into UI");


    if (data.constants?.territory) {
        changeIframeSrc(`/thru/${data.constants.territory}`);
    }

    fetchTableData("nodelist_xref");



};











   toggleBtn.addEventListener("click", async () => {
       await window.toggleView();
   });


      /* ---------------------------------------------------------
       * GENERAL ELEMENTS
       * --------------------------------------------------------- */
      const tableSelector = document.getElementById("tableSelector");
      const resourcesToggle = document.getElementById("resources-toggle");
      const resourcesContainer = document.getElementById("resources-container");

      const electionTabs = document.querySelectorAll(".election-tab");


      const changeIframe = (url) => changeIframeSrc(url);


      /* ---------------------------------------------------------
       * FETCH CONSTANTS + UPDATE UI
       * --------------------------------------------------------- */
       function refreshConstantsUI(callback) {
          console.log("üì© refreshing constants");
           return fetch("/get-constants", { credentials: "same-origin" })
               .then(res => res.json())
               .then(data => {
                   window.latestConstants = data.constants;
                   window.latestOptions = data.options;
                   window.updateConstantsUI(data.constants, data.options);
                   if (callback) callback(data);
                   return data.constants;
               });
       }



      /* ---------------------------------------------------------
       * TABLE SELECTOR
       * --------------------------------------------------------- */
      if (tableSelector) {
          tableSelector.addEventListener("change", (e) => {
              fetchTableData(e.target.value);
          });
      }


      /* ---------------------------------------------------------
       * BUTTON ‚Üí IFRAME ROUTING
       * --------------------------------------------------------- */
      const iframeButtons = {
          b3: "{{ url_for('stream_input') }}",
          b4: "{{ url_for('leafletting') }}",
          b5: "{{ url_for('kanban') }}",
          b6: "{{ url_for('telling') }}",
          b7: "{{ url_for('search') }}",
          b8: "{{ url_for('dashboard') }}"
      };

      for (const [id, url] of Object.entries(iframeButtons)) {
          const btn = document.getElementById(id);
          if (btn) btn.addEventListener("click", () => changeIframe(url));
      }


      /* ---------------------------------------------------------
       * LOGOUT
       * --------------------------------------------------------- */
      document.getElementById("logout-button")?.addEventListener("click", () => {
          window.location.href = "/logout";
      });


      /* ---------------------------------------------------------
       * RESOURCES TOGGLE
       * --------------------------------------------------------- */
      resourcesToggle?.addEventListener("click", () => {
          const visible = resourcesContainer.style.display === "block";
          resourcesContainer.style.display = visible ? "none" : "block";
          resourcesToggle.textContent = visible ? "Resources ‚¨á" : "Resources ‚¨Ü";
      });

      /* ---------------------------------------------------------
       * TAB CLICK HANDLER
       * --------------------------------------------------------- */
       document.addEventListener("click", async (e) => {
           if (!e.target.classList.contains("election-tab")) return;

           const electionName = e.target.dataset.election;
           console.log("üì© Switching to:", electionName);
           await switchElection(electionName);

           // Optional: keep any extra tab sync logic
           syncStreamsSelectWithTabs();
       });




      /* ---------------------------------------------------------
       * RESOURCES UPDATE
       * --------------------------------------------------------- */
      const resourcesSelect = document.getElementById("resources");

      resourcesSelect?.addEventListener("blur", () => {
          const selected = Array.from(resourcesSelect.selectedOptions).map(o => o.value);
          const tab = getActiveElectionTab();
          if (!tab) return;

          fetch("/set-constant", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              credentials: "same-origin",
              body: JSON.stringify({
                  election: tab.dataset.election,
                  name: "resources",
                  value: selected
              })
          })
              .then(res => res.json())
              .then(resp => {
                  if (resp.success) refreshConstantsUI();
              });
      });


      /* ---------------------------------------------------------
       * PARENT-DROPDOWN REASSIGNMENT
       * --------------------------------------------------------- */
      document.addEventListener("change", (e) => {
          if (!e.target.classList.contains("parent-dropdown")) return;

          const select = e.target;
          const subject = select.dataset.subject;

          fetch("/reassign_parent", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                  subject,
                  old_parent: select.dataset.oldValue,
                  new_parent: select.value
              })
          })
              .then(r => r.json())
              .then(data => {
                  if (data.status === "success") {
                      window.location.href = data.mapfile;
                  }
              });
      });



        console.log("üìÖ Building calendar‚Ä¶");

        // Buttons (use correct IDs)
        const switchToMapBtn = document.getElementById("switch-tomap-btn");
        const saveCalendarBtn = document.getElementById("save-calendar-btn"); // ‚úÖ matches HTML ID
        const generateSummaryBtn = document.getElementById("generate-summary-btn");
        const saveSlotBtn = document.getElementById("saveSlotBtn");
        const clearSlotBtn = document.getElementById("clearSlotBtn");

        // Attach button event handlers
        switchToMapBtn.addEventListener("click", window.toggleView);
        saveCalendarBtn.addEventListener("click", saveCalendarPlan);
        generateSummaryBtn.addEventListener("click", generateSummaryReport);
        saveSlotBtn.addEventListener("click", handleSaveSlot);
        clearSlotBtn.addEventListener("click", handleClearSlot);

  });



</script>
<script src="https://newbrie.github.io/Electtrek/static/resourcing.js"></script>


{% endblock captains %}
