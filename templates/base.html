<!-- Template by Guildfoss.com -->
<!DOCTYPE html>
<html lang="en">
<head>
  <!-- ðŸ§© Character encoding must come first -->
  <meta charset="utf-8">

  <!-- ðŸ“± Proper mobile viewport for scaling -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- ðŸ§¾ Favicons and basic styles -->
  <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">

  <!-- ðŸŽ¨ Core stylesheets -->
  <link rel="stylesheet" href="https://newbrie.github.io/Electtrek/static/style.css" media="screen">
  <link rel="stylesheet" href="https://newbrie.github.io/Electtrek/static/print.css" media="print">

  <!-- ðŸŒ External libraries (CSS first) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/dist/tippy.css">
  <title>Electtrek</title>


  <!-- ðŸŽ¨ Page-specific inline CSS (calendar, etc.) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/@popperjs/core@2"></script>
  <script src="https://unpkg.com/tippy.js@6"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

  <!-- ðŸ—ºï¸ Custom site scripts (after libs so dependencies exist) -->
  <script src="https://newbrie.github.io/Electtrek/static/map.js"></script>

</head>
<body>
<script>
    <!-- PAGE CONTENT GOES HERE -->
    // ðŸ§± Safe variable injection
      {% set _options = options or {} %}
      {% set _constants = constants or {} %}
      window.task_tags = {{ _options.get('task_tags', []) | tojson }};
      window.resources = {{ _options.get('resources', []) | tojson }};
      window.places = {{ _constants.get('places', []) | tojson }};
      window.areas = {{ _options.get('areas', []) | tojson }};

      console.log("Injected task_tags:", window.task_tags);
      console.log("Injected resources:", window.resources);
      console.log("Injected places:", window.places);
      console.log("Injected areas:", window.areas);

      window.DEVURLS = OPTIONS?.DEVURLS || {};
      window.isDev = location.hostname.includes("localhost") || location.hostname.startsWith("127.");
      window.API = window.isDev ? window.DEVURLS["dev"] : "__REPLACE_WITH_API_URL__";

      if (!window.isDev) {
          const btn = document.getElementById("export-html-btn");
          if (btn) {
              btn.style.display = "none";
          }
      }

      const startHour = 9, endHour = 21, slotDuration = 2;

      // ----------------------------
      // Flash Message Handling
      // ----------------------------
      const messages = {{ get_flashed_messages()|tojson|safe }} || [];

      const logList = document.querySelector("#logwin .flashes");
      function addMessageToLog(text) {
          if (!logList) return;

          const li = document.createElement("li");

          // Create timestamp
          const now = new Date();
          const hh = String(now.getHours()).padStart(2, "0");
          const mm = String(now.getMinutes()).padStart(2, "0");
          const ss = String(now.getSeconds()).padStart(2, "0");
          const timestamp = `[${hh}:${mm}:${ss}]`;

          li.textContent = `${timestamp} ${text}`;
          logList.appendChild(li);

          // Auto-scroll
          logList.scrollTop = logList.scrollHeight;
      }


      // Show flash messages from Flask (if any)
      messages.forEach(msg => addMessageToLog(msg));

      // ----------------------------
      // iframe postMessage handling
      // ----------------------------
      bindEvent(window, "message", (e) => {
          addMessageToLog(e.data?.type || String(e.data));
      });


      /* ---------------------------------------------------------
       * BUTTON â†’ IFRAME ROUTING
       * --------------------------------------------------------- */
      const iframeButtons = {
          b3: "{{ url_for('stream_input') }}",
          b4: "{{ url_for('leafletting') }}",
          b5: "{{ url_for('kanban') }}",
          b6: "{{ url_for('telling') }}",
          b7: "{{ url_for('search') }}",
          b8: "{{ url_for('dashboard') }}"
      };
    </script>

    <main class="container-fluid">
        {% block map %}
        {% endblock %}

        <!-- ðŸŒ Main content blocks -->
        {% block log %}{% endblock %}
        {% block nav %}{% endblock %}
        {% block captains %}{% endblock %}
    </main>

    <!-- ALL MODALS SHOULD BE HERE -->
    {% block modals %}
    {% endblock %}
  <script src="https://newbrie.github.io/Electtrek/static/resourcing.js"></script>

  <script src="https://newbrie.github.io/Electtrek/static/dashutilities.js"></script>

  <script src="https://newbrie.github.io/Electtrek/static/dashdomcontent.js"></script>

</body>
</html>
